<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="https://img.supervj.top/imgHEAD_Icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://img.supervj.top/imgHEAD_Icon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://img.supervj.top/imgHEAD_Icon.png">
  <link rel="mask-icon" href="https://img.supervj.top/imgHEAD_Icon.png" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ma+Shan+Zheng:300,300italic,400,400italic,700,700italic|Noto+Sans+Simplified+Chinese:300,300italic,400,400italic,700,700italic|Noto+Serif+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.css">
  <script src="//cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.js"></script>

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"supervj.top","root":"/","images":"/images","scheme":"Pisces","version":"8.1.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>
<meta name="description" content="如果我们不曾相遇">
<meta property="og:type" content="website">
<meta property="og:title" content="月光林地">
<meta property="og:url" content="http://supervj.top/page/11/index.html">
<meta property="og:site_name" content="月光林地">
<meta property="og:description" content="如果我们不曾相遇">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="VJ东">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://supervj.top/page/11/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>
<title>月光林地</title>
  



  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">月光林地</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
        <li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <section class="post-toc-wrap sidebar-panel">
        </section>
        <!--/noindex-->

        <section class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="VJ东"
      src="https://img.supervj.top/imgHEAD_Icon.png">
  <p class="site-author-name" itemprop="name">VJ东</p>
  <div class="site-description" itemprop="description"> 如果我们不曾相遇 </div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">122</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">106</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="/389278697@qq.com" title="E-Mail → 389278697@qq.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



        </section>
      </div>
        <div class="back-to-top animated">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/VJien" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://supervj.top/2020/06/30/LearnDX12_DrawGeo/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://img.supervj.top/imgHEAD_Icon.png">
      <meta itemprop="name" content="VJ东">
      <meta itemprop="description" content=" 如果我们不曾相遇 ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="月光林地">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/06/30/LearnDX12_DrawGeo/" class="post-title-link" itemprop="url">DX学习笔记（四）：绘制几何体</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-06-30 00:00:00" itemprop="dateCreated datePublished" datetime="2020-06-30T00:00:00+08:00">2020-06-30</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-08-02 16:40:53" itemprop="dateModified" datetime="2021-08-02T16:40:53+08:00">2021-08-02</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/graphics/" itemprop="url" rel="index"><span itemprop="name">graphics</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    
      <a title="changyan" href="/2020/06/30/LearnDX12_DrawGeo/#SOHUCS" itemprop="discussionUrl">
        <span id="url::http://supervj.top/2020/06/30/LearnDX12_DrawGeo/" class="cy_cmt_count" data-xid="2020/06/30/LearnDX12_DrawGeo/" itemprop="commentCount"></span>
      </a>
    
  </span>
  
  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>44k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>40 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="用DirectX绘制几何体"><a href="#用DirectX绘制几何体" class="headerlink" title="用DirectX绘制几何体"></a>用DirectX绘制几何体</h2><p><img src="https://img.supervj.top/img/DX/DrawBox.gif"></p>
<h3 id="流程简述"><a href="#流程简述" class="headerlink" title="流程简述"></a>流程简述</h3><h5 id="顶点与输入布局"><a href="#顶点与输入布局" class="headerlink" title="顶点与输入布局"></a>顶点与输入布局</h5><ol>
<li>创建顶点结构体</li>
<li>设置输入布局描述<code>D3D12_INPUT_ELEMENT_DESC</code></li>
</ol>
<h5 id="顶点-索引缓冲区"><a href="#顶点-索引缓冲区" class="headerlink" title="顶点/索引缓冲区"></a>顶点/索引缓冲区</h5><ol>
<li>创建顶点数据/索引数据</li>
<li>创建缓冲区/索引缓冲区</li>
</ol>
<h5 id="顶点着色-像素着色"><a href="#顶点着色-像素着色" class="headerlink" title="顶点着色/像素着色"></a>顶点着色/像素着色</h5><ol>
<li>编写HLSL着色器文件</li>
<li>编译着色器</li>
</ol>
<h5 id="常量缓冲区（上传堆，CPU可写，GPU可读）"><a href="#常量缓冲区（上传堆，CPU可写，GPU可读）" class="headerlink" title="常量缓冲区（上传堆，CPU可写，GPU可读）"></a>常量缓冲区（上传堆，CPU可写，GPU可读）</h5><ol>
<li>填充常量缓冲区所需的描述符(<code>D3D12_DESCRIPTOR_HEAP_TYPE_CBV_SRV_UAV</code>)</li>
<li>构造缓冲区对象（单独的类），该类创建常量缓冲区</li>
<li>设置缓冲区大小为256B的整数倍</li>
<li>创建常量缓冲区视图</li>
<li>创建根签名</li>
</ol>
<blockquote>
<p>后续在提交命令列表的时候讲根签名和常量缓冲区绑定到流水线</p>
</blockquote>
<h5 id="流水线状态对象-PSO"><a href="#流水线状态对象-PSO" class="headerlink" title="流水线状态对象 PSO"></a>流水线状态对象 PSO</h5><ol>
<li>创建PSO对象 <code>D3D12_GRAPHICS_PIPELINE_STATE_DESC</code></li>
<li>设置PSO对象的各类参数，包括输入布局描述符、根签名、PS、VS、光栅器对象等</li>
<li>通过<code>md3dDevice-&gt;CreateGraphicsPipelineState(&amp;psoDesc,IID_PPV_ARGS(&amp;mPSO))</code>创建PSO</li>
</ol>
<h5 id="构建几何体"><a href="#构建几何体" class="headerlink" title="构建几何体"></a>构建几何体</h5><ol>
<li>顶点/索引数据，布局描述</li>
<li>创建Geo类，并且设置类内参数，这些参数在填充视口描述的时候需要</li>
<li>创建顶点/索引缓冲区</li>
<li>在绘制阶段通过命令列表将顶点和索引视图绑定到流水线插槽</li>
<li>通过<code>DrawIndexedInstanced</code>绘制几何体</li>
</ol>
<h5 id="刷新（update）"><a href="#刷新（update）" class="headerlink" title="刷新（update）"></a>刷新（update）</h5><ol>
<li>根据鼠标信息重新构建观察矩阵（相对坐标的变换）</li>
<li>刷新常量缓冲区</li>
</ol>
<h5 id="Resize"><a href="#Resize" class="headerlink" title="Resize"></a>Resize</h5><ol>
<li>重新构建透视投影矩阵</li>
<li>然后反馈到Update的常量缓冲区上</li>
</ol>
<blockquote>
<p>世界矩阵随移动/旋转/缩放而改变</p>
<p>观察矩阵随虚拟摄像机的移动/旋转/缩放而改变</p>
<p>投影矩阵随窗口大小调整而改变</p>
</blockquote>
<blockquote>
<p>刷新的数据通过根签名设置到着色器</p>
</blockquote>
<h3 id="顶点与输入布局-1"><a href="#顶点与输入布局-1" class="headerlink" title="顶点与输入布局"></a>顶点与输入布局</h3><ul>
<li>顶点结构体</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Vertex</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    XMFLOAT3 Pos;</span><br><span class="line">    XMFLOAT4 Color;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Vertex2</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    XMFLOAT3 Pos;</span><br><span class="line">    XMFLOAT3 Normal;</span><br><span class="line">    XMFLOAT2 Tex0;</span><br><span class="line">    XMFLOAT2 Tex1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>输入布局描述</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">D3D12_INPUT_LAYOUT_DESC</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">    _Field_size_full_(NumElements)  <span class="keyword">const</span> D3D12_INPUT_ELEMENT_DESC *pInputElementDescs;</span><br><span class="line">    UINT NumElements;<span class="comment">//数量</span></span><br><span class="line">    &#125; 	D3D12_INPUT_LAYOUT_DESC;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">D3D12_INPUT_ELEMENT_DESC</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">    LPCSTR SemanticName;</span><br><span class="line">    UINT SemanticIndex;</span><br><span class="line">    DXGI_FORMAT Format;</span><br><span class="line">    UINT InputSlot;</span><br><span class="line">    UINT AlignedByteOffset;</span><br><span class="line">    D3D12_INPUT_CLASSIFICATION InputSlotClass;</span><br><span class="line">    UINT InstanceDataStepRate;</span><br><span class="line">    &#125; 	D3D12_INPUT_ELEMENT_DESC;</span><br></pre></td></tr></table></figure>

<ol>
<li>SemanticName：语义，用于将<strong>顶点结构体</strong>中的元素与<strong>顶点着色器</strong>输入签名（参数列表）中的元素映射起来</li>
<li>SemanticIndex：附加到语义的索引。</li>
<li>Format：顶点元素格式，如<code>DXGI_FORMAT_R32_FLOAT</code>1D32位浮点标量</li>
<li>InputSlot：传递元素所用的输入槽，DirectX12一共16个，索引0-15，一般用同一个输入槽即输入槽0</li>
<li>AlignedByteOffset：顶点结构体的首地址到某点元素起始地址的偏移量</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Vertex2</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    XMFLOAT3 Pos;<span class="comment">//偏移0字节</span></span><br><span class="line">    XMFLOAT3 Normal;<span class="comment">//偏移12字节</span></span><br><span class="line">    XMFLOAT2 Tex0;<span class="comment">//偏移24字节</span></span><br><span class="line">    XMFLOAT2 Tex1;<span class="comment">//偏移32字节</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>InputSlotClass：一般指定为<code>D3D12_INPUT_CLASSIFICATION_PER_VERTEX_DATA</code>，另外一种<code>D3D12_INPUT_CLASSIFICATION_PER_INSTANCE_DATA</code>用于实现实例化的高级技术</li>
<li>InstanceDataStepRate：一般设置0，如果采用实例化就用1</li>
</ol>
<ul>
<li>示例</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">D3D12_INPUT_ELEMENT_DESC desc1 =</span><br><span class="line">  &#123;</span><br><span class="line">      &#123; <span class="string">&quot;POSITION&quot;</span>, <span class="number">0</span>, DXGI_FORMAT_R32G32B32_FLOAT, <span class="number">0</span>, <span class="number">0</span>, D3D12_INPUT_CLASSIFICATION_PER_VERTEX_DATA, <span class="number">0</span> &#125;,</span><br><span class="line">      &#123; <span class="string">&quot;COLOR&quot;</span>, <span class="number">0</span>, DXGI_FORMAT_R32G32B32A32_FLOAT, <span class="number">0</span>, <span class="number">12</span>, D3D12_INPUT_CLASSIFICATION_PER_VERTEX_DATA, <span class="number">0</span> &#125;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">D3D12_INPUT_ELEMENT_DESC desc2 =</span><br><span class="line">  &#123;</span><br><span class="line">      &#123; <span class="string">&quot;POSITION&quot;</span>, <span class="number">0</span>, DXGI_FORMAT_R32G32B32_FLOAT, <span class="number">0</span>, <span class="number">0</span>, D3D12_INPUT_CLASSIFICATION_PER_VERTEX_DATA, <span class="number">0</span> &#125;,</span><br><span class="line">      &#123; <span class="string">&quot;NORMAL&quot;</span>, <span class="number">0</span>, DXGI_FORMAT_R32G32B32A32_FLOAT, <span class="number">0</span>, <span class="number">12</span>, D3D12_INPUT_CLASSIFICATION_PER_VERTEX_DATA, <span class="number">0</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;TEXCOORD&quot;</span>, <span class="number">0</span>, DXGI_FORMAT_R32G32B32_FLOAT, <span class="number">0</span>, <span class="number">24</span>, D3D12_INPUT_CLASSIFICATION_PER_VERTEX_DATA, <span class="number">0</span> &#125;,</span><br><span class="line">      &#123; <span class="string">&quot;TEXCOORD&quot;</span>, <span class="number">0</span>, DXGI_FORMAT_R32G32B32A32_FLOAT, <span class="number">0</span>, <span class="number">32</span>, D3D12_INPUT_CLASSIFICATION_PER_VERTEX_DATA, <span class="number">0</span> &#125;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>



<h3 id="顶点缓冲区"><a href="#顶点缓冲区" class="headerlink" title="顶点缓冲区"></a>顶点缓冲区</h3><p>为了使GPU可以访问顶点数组，就需要把它们放置在<code>缓冲区</code>的GPU资源（ID2D12Resource）</p>
<ul>
<li><p>顶点缓冲区：存储顶点的缓冲区</p>
</li>
<li><p>缓冲区描述:<code>CD3D12_RESOURCE_DESC</code></p>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">CD3DX12_RESOURCE_DESC</span> :</span> <span class="keyword">public</span> D3D12_RESOURCE_DESC</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">CD3DX12_RESOURCE_DESC</span>()</span><br><span class="line">    &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">CD3DX12_RESOURCE_DESC</span><span class="params">( <span class="keyword">const</span> D3D12_RESOURCE_DESC&amp; o )</span> :</span></span><br><span class="line"><span class="function">        D3D12_RESOURCE_DESC( o )</span></span><br><span class="line"><span class="function">    &#123;</span>&#125;</span><br><span class="line">    <span class="built_in">CD3DX12_RESOURCE_DESC</span>( </span><br><span class="line">        D3D12_RESOURCE_DIMENSION dimension,</span><br><span class="line">        UINT64 alignment,</span><br><span class="line">        UINT64 width,</span><br><span class="line">        UINT height,</span><br><span class="line">        UINT16 depthOrArraySize,</span><br><span class="line">        UINT16 mipLevels,</span><br><span class="line">        DXGI_FORMAT format,</span><br><span class="line">        UINT sampleCount,</span><br><span class="line">        UINT sampleQuality,</span><br><span class="line">        D3D12_TEXTURE_LAYOUT layout,</span><br><span class="line">        D3D12_RESOURCE_FLAGS flags )</span><br><span class="line">        <span class="comment">/**********/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此描述继承自<code>D3D_RESOURCE_DESC</code>，重点实现了几个比较便捷的方法如</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> CD3DX12_RESOURCE_DESC <span class="title">Buffer</span><span class="params">( </span></span></span><br><span class="line"><span class="params"><span class="function">       UINT64 width,</span></span></span><br><span class="line"><span class="params"><span class="function">       D3D12_RESOURCE_FLAGS flags = D3D12_RESOURCE_FLAG_NONE,</span></span></span><br><span class="line"><span class="params"><span class="function">       UINT64 alignment = <span class="number">0</span> )</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="built_in">CD3DX12_RESOURCE_DESC</span>( D3D12_RESOURCE_DIMENSION_BUFFER, alignment, width, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, </span><br><span class="line">           DXGI_FORMAT_UNKNOWN, <span class="number">1</span>, <span class="number">0</span>, D3D12_TEXTURE_LAYOUT_ROW_MAJOR, flags );</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>其他还有比如<code>CD3DX12_RESOURCE_DESC::Tex1D,CD3DX12_RESOURCE_DESC::2D</code>等便捷方法</p>
<p>然后通过<code>ID3D12Device::CreateCommittedResource</code>方法创建<code>ID3D12Resource</code>对象</p>
<ul>
<li>示例：创建默认缓冲区函数申明</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create the actual default buffer resource.</span></span><br><span class="line">  <span class="built_in">ThrowIfFailed</span>(device-&gt;<span class="built_in">CreateCommittedResource</span>(</span><br><span class="line">      &amp;<span class="built_in">CD3DX12_HEAP_PROPERTIES</span>(D3D12_HEAP_TYPE_DEFAULT),</span><br><span class="line">      D3D12_HEAP_FLAG_NONE,</span><br><span class="line">      &amp;CD3DX12_RESOURCE_DESC::<span class="built_in">Buffer</span>(byteSize),</span><br><span class="line">D3D12_RESOURCE_STATE_COMMON,</span><br><span class="line">      <span class="literal">nullptr</span>,</span><br><span class="line">      <span class="built_in">IID_PPV_ARGS</span>(defaultBuffer.<span class="built_in">GetAddressOf</span>())));</span><br></pre></td></tr></table></figure>

<blockquote>
<p>DX12中所有资源都用<code>ID3D12Resource</code>接口表示，DX11用各种比如<code>ID3D11Buffers</code>等表示</p>
</blockquote>
<p>为了优化性能，静态几何体的顶点缓冲区置于默认堆中</p>
<p>因为CPU不能向默认堆(<code>D3D12_HEAP_TYPE_DEFAULT</code>)中的顶点缓冲区写入数据，所以就需要用到一个中介</p>
<ul>
<li><p>上传缓冲区<br>为了将数据从CPU复制到GPU显存中，即将顶点数据从系统内存复制到上传缓冲区，然后再复制到真正的顶点缓冲区中</p>
</li>
<li><p>示例:创建默认缓冲区函数实现</p>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">Microsoft::<span class="function">WRL::ComPtr&lt;ID3D12Resource&gt; <span class="title">d3dUtil::CreateDefaultBuffer</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    ID3D12Device* device,</span></span></span><br><span class="line"><span class="params"><span class="function">    ID3D12GraphicsCommandList* cmdList,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> <span class="keyword">void</span>* initData,</span></span></span><br><span class="line"><span class="params"><span class="function">    UINT64 byteSize,</span></span></span><br><span class="line"><span class="params"><span class="function">    Microsoft::WRL::ComPtr&lt;ID3D12Resource&gt;&amp; uploadBuffer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ComPtr&lt;ID3D12Resource&gt; defaultBuffer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建实际的默认缓冲区资源</span></span><br><span class="line">    <span class="built_in">ThrowIfFailed</span>(device-&gt;<span class="built_in">CreateCommittedResource</span>(</span><br><span class="line">        &amp;<span class="built_in">CD3DX12_HEAP_PROPERTIES</span>(D3D12_HEAP_TYPE_DEFAULT),</span><br><span class="line">        D3D12_HEAP_FLAG_NONE,</span><br><span class="line">        &amp;CD3DX12_RESOURCE_DESC::<span class="built_in">Buffer</span>(byteSize),</span><br><span class="line">		D3D12_RESOURCE_STATE_COMMON,</span><br><span class="line">        <span class="literal">nullptr</span>,</span><br><span class="line">        <span class="built_in">IID_PPV_ARGS</span>(defaultBuffer.<span class="built_in">GetAddressOf</span>())));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//为了将CPU端内存中的数据复制到缓冲区，我们就创建处于中介位置的上传堆</span></span><br><span class="line">    <span class="built_in">ThrowIfFailed</span>(device-&gt;<span class="built_in">CreateCommittedResource</span>(</span><br><span class="line">        &amp;<span class="built_in">CD3DX12_HEAP_PROPERTIES</span>(D3D12_HEAP_TYPE_UPLOAD),</span><br><span class="line">		D3D12_HEAP_FLAG_NONE,</span><br><span class="line">        &amp;CD3DX12_RESOURCE_DESC::<span class="built_in">Buffer</span>(byteSize),</span><br><span class="line">		D3D12_RESOURCE_STATE_GENERIC_READ,</span><br><span class="line">        <span class="literal">nullptr</span>,</span><br><span class="line">        <span class="built_in">IID_PPV_ARGS</span>(uploadBuffer.<span class="built_in">GetAddressOf</span>())));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 描述我们希望复制到默认缓冲区的数据</span></span><br><span class="line">    D3D12_SUBRESOURCE_DATA subResourceData = &#123;&#125;;</span><br><span class="line">    subResourceData.pData = initData;</span><br><span class="line">    subResourceData.RowPitch = byteSize;</span><br><span class="line">    subResourceData.SlicePitch = subResourceData.RowPitch;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将数据复制到默认缓冲区的流程</span></span><br><span class="line">    <span class="comment">//UpdateSubresources辅助函数将数据从CPU复制到上传堆</span></span><br><span class="line">    <span class="comment">//再通过ID3D12CommandList::CopySubresourceRegion函数复制到mBuff中</span></span><br><span class="line">	cmdList-&gt;<span class="built_in">ResourceBarrier</span>(<span class="number">1</span>, &amp;CD3DX12_RESOURCE_BARRIER::<span class="built_in">Transition</span>(defaultBuffer.<span class="built_in">Get</span>(), </span><br><span class="line">		D3D12_RESOURCE_STATE_COMMON, D3D12_RESOURCE_STATE_COPY_DEST));</span><br><span class="line">    UpdateSubresources&lt;<span class="number">1</span>&gt;(cmdList, defaultBuffer.<span class="built_in">Get</span>(), uploadBuffer.<span class="built_in">Get</span>(), <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, &amp;subResourceData);</span><br><span class="line">	cmdList-&gt;<span class="built_in">ResourceBarrier</span>(<span class="number">1</span>, &amp;CD3DX12_RESOURCE_BARRIER::<span class="built_in">Transition</span>(defaultBuffer.<span class="built_in">Get</span>(),</span><br><span class="line">		D3D12_RESOURCE_STATE_COPY_DEST, D3D12_RESOURCE_STATE_GENERIC_READ));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// uploadBuffer必须在调用方法以后依然存在，因为命令列表的复制操作可能未执行，等调用者复制完消息以后才可以释放</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> defaultBuffer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>D3D12_SUBRESOURCE_DATA</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">D3D12_SUBRESOURCE_DATA</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">void</span> *pData;<span class="comment">//初始化缓冲区所用的数据指针</span></span><br><span class="line">    LONG_PTR RowPitch;<span class="comment">//对于缓冲区，此参数为欲复制数据的字节数</span></span><br><span class="line">    LONG_PTR SlicePitch;<span class="comment">//同上</span></span><br><span class="line">    &#125; 	D3D12_SUBRESOURCE_DATA;</span><br></pre></td></tr></table></figure>

<ul>
<li>示例：创建有立方体8个顶点的默认缓冲区</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> std::array&lt;Vertex, 8&gt; vertices =</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">Vertex</span>(&#123; <span class="built_in">XMFLOAT3</span>(<span class="number">-1.0f</span>, <span class="number">-1.0f</span>, <span class="number">-1.0f</span>), <span class="built_in">XMFLOAT4</span>(Colors::White) &#125;),</span><br><span class="line">		<span class="built_in">Vertex</span>(&#123; <span class="built_in">XMFLOAT3</span>(<span class="number">-1.0f</span>, +<span class="number">1.0f</span>, <span class="number">-1.0f</span>), <span class="built_in">XMFLOAT4</span>(Colors::Black) &#125;),</span><br><span class="line">		<span class="built_in">Vertex</span>(&#123; <span class="built_in">XMFLOAT3</span>(+<span class="number">1.0f</span>, +<span class="number">1.0f</span>, <span class="number">-1.0f</span>), <span class="built_in">XMFLOAT4</span>(Colors::Red) &#125;),</span><br><span class="line">		<span class="built_in">Vertex</span>(&#123; <span class="built_in">XMFLOAT3</span>(+<span class="number">1.0f</span>, <span class="number">-1.0f</span>, <span class="number">-1.0f</span>), <span class="built_in">XMFLOAT4</span>(Colors::Green) &#125;),</span><br><span class="line">		<span class="built_in">Vertex</span>(&#123; <span class="built_in">XMFLOAT3</span>(<span class="number">-1.0f</span>, <span class="number">-1.0f</span>, +<span class="number">1.0f</span>), <span class="built_in">XMFLOAT4</span>(Colors::Blue) &#125;),</span><br><span class="line">		<span class="built_in">Vertex</span>(&#123; <span class="built_in">XMFLOAT3</span>(<span class="number">-1.0f</span>, +<span class="number">1.0f</span>, +<span class="number">1.0f</span>), <span class="built_in">XMFLOAT4</span>(Colors::Yellow) &#125;),</span><br><span class="line">		<span class="built_in">Vertex</span>(&#123; <span class="built_in">XMFLOAT3</span>(+<span class="number">1.0f</span>, +<span class="number">1.0f</span>, +<span class="number">1.0f</span>), <span class="built_in">XMFLOAT4</span>(Colors::Cyan) &#125;),</span><br><span class="line">		<span class="built_in">Vertex</span>(&#123; <span class="built_in">XMFLOAT3</span>(+<span class="number">1.0f</span>, <span class="number">-1.0f</span>, +<span class="number">1.0f</span>), <span class="built_in">XMFLOAT4</span>(Colors::Magenta) &#125;)</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> UINT vbByteSize = (UINT)vertices.<span class="built_in">size</span>() * <span class="built_in"><span class="keyword">sizeof</span></span>(Vertex);</span><br><span class="line">Microsoft::WRL::ComPtr&lt;ID3D12Resource&gt; VertexBufferGPU = <span class="literal">nullptr</span>;</span><br><span class="line">Microsoft::WRL::ComPtr&lt;ID3D12Resource&gt; VertexBufferUploader = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">mBoxGeo-&gt;VertexBufferGPU = d3dUtil::<span class="built_in">CreateDefaultBuffer</span>(md3dDevice.<span class="built_in">Get</span>(),</span><br><span class="line">		mCommandList.<span class="built_in">Get</span>(), vertices.<span class="built_in">data</span>(), vbByteSize, mBoxGeo-&gt;VertexBufferUploader);</span><br></pre></td></tr></table></figure>

<p><img src="https://img.supervj.top/img/DX/image-20200630173313574.png" alt="image-20200630173313574"></p>
<ul>
<li>顶点缓冲区视图:为了将顶点缓冲区绑定到渲染流水线</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">D3D12_VERTEX_BUFFER_VIEW</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">    D3D12_GPU_VIRTUAL_ADDRESS BufferLocation;</span><br><span class="line">    UINT SizeInBytes;</span><br><span class="line">    UINT StrideInBytes;</span><br><span class="line">    &#125; </span><br></pre></td></tr></table></figure>

<ol>
<li>BufferLocation：顶点缓冲区的虚拟地址，通过<code>ID3D12Resource::GetGPUVirtualAddress</code>方法得到此地址</li>
<li>SizeInBytes：顶点缓冲区大小（字节）</li>
<li>StrideInBytes：每个顶点元素占用的字节</li>
</ol>
<p>然后将顶点缓冲区视图和渲染流水线上的一个输入槽绑定</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//第一个参数：所用的输入槽，一般用0</span></span><br><span class="line"><span class="comment">//第二个参数：与输入槽绑定的缓冲区数量，即pView数组中视图的数量</span></span><br><span class="line"><span class="comment">//视图数组的第一个元素的地址</span></span><br><span class="line">mCommandList-&gt;<span class="built_in">IASetVertexBuffers</span>(<span class="number">0</span>, <span class="number">1</span>, &amp;mBoxGeo-&gt;<span class="built_in">VertexBufferView</span>());</span><br></pre></td></tr></table></figure>



<blockquote>
<p>将顶点缓冲区置入输入槽并不会进行绘制操作，仅仅是为顶点数据送至渲染流水线做好准备</p>
</blockquote>
<p>真正绘制顶点的方法</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//参数1：每个实例绘制的顶点数</span></span><br><span class="line"><span class="comment">//参数2：实例化高级技术，目前给1</span></span><br><span class="line"><span class="comment">//参数3：第一个被绘制顶点的索引</span></span><br><span class="line"><span class="comment">//参数4：实例化技术，目前给0</span></span><br><span class="line">mCommandList-&gt;<span class="built_in">DrawIndexedInstanced</span>(</span><br><span class="line">		mBoxGeo-&gt;DrawArgs[<span class="string">&quot;box&quot;</span>].IndexCount, </span><br><span class="line">		<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<h3 id="索引和索引缓冲区"><a href="#索引和索引缓冲区" class="headerlink" title="索引和索引缓冲区"></a>索引和索引缓冲区</h3><ul>
<li>索引缓冲区</li>
</ul>
<p>与顶点类似，为了使GPU可以访问索引数组，需要将它们放置于GPU的缓冲区资源内,此缓冲区即<code>索引缓冲区</code></p>
<p>同样用<code>CreateDefaultBuffer</code>方法创建索引缓冲区</p>
<p>索引缓冲区用到结构体<code>D3D12_INDEX_BUFFER_VIEW</code>描述</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">D3D12_INDEX_BUFFER_VIEW</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">    D3D12_GPU_VIRTUAL_ADDRESS BufferLocation;<span class="comment">//带创建索引缓冲区虚拟地址，用ID3D12Resource::GetGUPVirtualAddress()得到</span></span><br><span class="line">    UINT SizeInBytes;<span class="comment">//索引缓冲区大小</span></span><br><span class="line">    DXGI_FORMAT Format;<span class="comment">//必须为DXGI_FORMAT_R16_UINT类型或者DXGI_FORMAT_R32_UINT</span></span><br><span class="line">    &#125; </span><br></pre></td></tr></table></figure>

<p>同顶点缓冲区，也需要绑定到渲染流水线，通过<code>ID3D12GraphicsCommandList::IASetIndexBuffer</code>方法将索引缓冲区绑定到输入装配器阶段</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">	std::array&lt;std::<span class="keyword">uint16_t</span>, 36&gt; indices =</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// front face</span></span><br><span class="line">		<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>,</span><br><span class="line">		<span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>,</span><br><span class="line"></span><br><span class="line">		<span class="comment">// back face</span></span><br><span class="line">		<span class="number">4</span>, <span class="number">6</span>, <span class="number">5</span>,</span><br><span class="line">		<span class="number">4</span>, <span class="number">7</span>, <span class="number">6</span>,</span><br><span class="line"></span><br><span class="line">		<span class="comment">// left face</span></span><br><span class="line">		<span class="number">4</span>, <span class="number">5</span>, <span class="number">1</span>,</span><br><span class="line">		<span class="number">4</span>, <span class="number">1</span>, <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">		<span class="comment">// right face</span></span><br><span class="line">		<span class="number">3</span>, <span class="number">2</span>, <span class="number">6</span>,</span><br><span class="line">		<span class="number">3</span>, <span class="number">6</span>, <span class="number">7</span>,</span><br><span class="line"></span><br><span class="line">		<span class="comment">// top face</span></span><br><span class="line">		<span class="number">1</span>, <span class="number">5</span>, <span class="number">6</span>,</span><br><span class="line">		<span class="number">1</span>, <span class="number">6</span>, <span class="number">2</span>,</span><br><span class="line"></span><br><span class="line">		<span class="comment">// bottom face</span></span><br><span class="line">		<span class="number">4</span>, <span class="number">0</span>, <span class="number">3</span>,</span><br><span class="line">		<span class="number">4</span>, <span class="number">3</span>, <span class="number">7</span></span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> UINT ibByteSize = (UINT)indices.<span class="built_in">size</span>() * <span class="built_in"><span class="keyword">sizeof</span></span>(std::<span class="keyword">uint16_t</span>);</span><br><span class="line"></span><br><span class="line">Microsoft::WRL::ComPtr&lt;ID3D12Resource&gt; IndexBufferGPU = <span class="literal">nullptr</span>;</span><br><span class="line">Microsoft::WRL::ComPtr&lt;ID3D12Resource&gt; IndexBufferUploader = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">mBoxGeo-&gt;IndexBufferGPU = d3dUtil::<span class="built_in">CreateDefaultBuffer</span>(md3dDevice.<span class="built_in">Get</span>(),</span><br><span class="line">		mCommandList.<span class="built_in">Get</span>(), indices.<span class="built_in">data</span>(), ibByteSize, mBoxGeo-&gt;IndexBufferUploader);</span><br></pre></td></tr></table></figure>



<blockquote>
<p>使用索引时，要用<code>ID3D12GraphicsCommandList::DrawIndexedInstanced</code>代替<code>DrawInstanced</code>方法</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//第4个参数：读取顶点之前，要为每个索引都加上的整数值</span></span><br><span class="line"><span class="comment">//其他参考顶点绘制</span></span><br><span class="line">mCommandList-&gt;<span class="built_in">DrawIndexedInstanced</span>(</span><br><span class="line">		mBoxGeo-&gt;DrawArgs[<span class="string">&quot;box&quot;</span>].IndexCount, </span><br><span class="line">		<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>将多个顶点缓冲区和索引缓冲区合并以后会需要用到第4个参数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mCommandList-&gt;<span class="built_in">DrawIndexedInstanced</span>(numOfBox, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">mCommandList-&gt;<span class="built_in">DrawIndexedInstanced</span>(numOfSph, <span class="number">1</span>, firstSphIdx, firstSphIdx, <span class="number">0</span>);</span><br><span class="line">mCommandList-&gt;<span class="built_in">DrawIndexedInstanced</span>(numOfCyl, <span class="number">1</span>, firstCylIdx, firstCylIdx, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>



<p><img src="https://img.supervj.top/img/DX/image-20200624172043571.png" alt="image-20200624172043571"></p>
<h3 id="顶点着色器示例"><a href="#顶点着色器示例" class="headerlink" title="顶点着色器示例"></a>顶点着色器示例</h3><ul>
<li>高级着色器语言：HLSL</li>
</ul>
<p>示例</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cbuffer cbPerObject:<span class="built_in"><span class="keyword">register</span></span>(b0)</span><br><span class="line">&#123;</span><br><span class="line">    float4x4 gWorldViewProj;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">VS</span><span class="params">(float3 iPosL:POSITION,float4 iColor:COLOR,out float4 oPosH:SV_POSTION,out float4 oColor:COLOR)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//把顶点变换到齐次裁剪空间</span></span><br><span class="line">    oPosH = <span class="built_in">mul</span>(<span class="built_in">float4</span>(iPosL,<span class="number">1.0f</span>),gWolrdViewProj);</span><br><span class="line">    <span class="comment">//将顶点颜色信息传至像素着色器</span></span><br><span class="line">    oColor=iColor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>HLSL没有指针和引用，用<code>out</code>表示输出参数</p>
<p>HLSL所有函数都是lnline函数</p>
<p>参数<code>POSITION</code>和<code>COLOR</code>语义将元素映射到顶点着色器对应的输入参数；同理输出参数的语义将参数映射到下一个阶段（几何着色器或者像素着色器）对应的输入参数；</p>
<p><code>SV_POSTION</code>的<code>SV</code>代表系统值，此数据存有齐次裁剪空间顶点信息，指定了此语义以后使GPU进行如裁剪、深度测试等处理时，实现其他属性无法介入的有关运算</p>
<p>任何没有系统修饰的参数，都可以根据需求以合法的语义修饰</p>
<p>可以把函数的参数封装成结构体，下面是另一种实现方式</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">VertexIn</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    float3 PosL:POSTION;</span><br><span class="line">    float4 Color:COLOR;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">VertexOut</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    float3 PosH:SV_POSTION;</span><br><span class="line">    float4 Color:COLOR;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">VextexOut <span class="title">VS</span><span class="params">(VertexIn vin)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    VertexOut vout;</span><br><span class="line">    vout.PosH=<span class="built_in">mul</span>(<span class="built_in">float4</span>(vin.PosL,<span class="number">1.0f</span>),gWolrdViewProj);</span><br><span class="line">    vout.Color=vin.Color;</span><br><span class="line">    <span class="keyword">return</span> vout;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果没有使用<code>几何着色器</code>，那么顶点着色器必须用<code>SV_POSITION</code>来输出顶点在齐次裁剪空间的位置</p>
<p>如果使用了，可以把得到齐次裁剪空间位置的工作交给它来处理</p>
<p>顶点着色器/几何着色器无法完成透视除法，此阶段只能完成投影矩阵运算，透视除法由后续硬件执行</p>
</blockquote>
<h5 id="布局描述符与签名匹配问题"><a href="#布局描述符与签名匹配问题" class="headerlink" title="布局描述符与签名匹配问题"></a>布局描述符与签名匹配问题</h5><p><code>ID3D12Device::CreateGraphicsPipelineState</code>函数时，需要指定布局描述符和顶点着色器,这就涉及到参数匹配问题</p>
<ul>
<li>不匹配</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Vertex</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    XMFLOAT3 Pos;</span><br><span class="line">    XMFLOAT4 Color;</span><br><span class="line">    <span class="comment">//XMFLOAT3 Normal;//缺少此行输入</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> D3D12_INPUT_ELEMENT_DESC[] =</span><br><span class="line">    &#123;</span><br><span class="line">        &#123; <span class="string">&quot;POSITION&quot;</span>, <span class="number">0</span>, DXGI_FORMAT_R32G32B32_FLOAT, <span class="number">0</span>, <span class="number">0</span>, D3D12_INPUT_CLASSIFICATION_PER_VERTEX_DATA, <span class="number">0</span> &#125;,</span><br><span class="line">        &#123; <span class="string">&quot;COLOR&quot;</span>, <span class="number">0</span>, DXGI_FORMAT_R32G32B32A32_FLOAT, <span class="number">0</span>, <span class="number">12</span>, D3D12_INPUT_CLASSIFICATION_PER_VERTEX_DATA, <span class="number">0</span> &#125;,</span><br><span class="line">      &#123; <span class="string">&quot;NORMAL&quot;</span>, <span class="number">0</span>, DXGI_FORMAT_R32G32B32A32_FLOAT, <span class="number">0</span>, <span class="number">24</span>, D3D12_INPUT_CLASSIFICATION_PER_VERTEX_DATA, <span class="number">0</span> &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">VertexIn</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    float3 PosL:POSTION;</span><br><span class="line">    float4 Color:COLOR;</span><br><span class="line">    float3 Normal:NORMAL;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">VertexOut</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    float3 PosH:SV_POSTION;</span><br><span class="line">    float4 Color:COLOR;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">VertexOut <span class="title">VS</span><span class="params">(VertexIn vin)</span></span>&#123;...&#125;;</span><br></pre></td></tr></table></figure>



<ul>
<li>匹配</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Vertex</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    XMFLOAT3 Pos;</span><br><span class="line">    XMFLOAT4 Color;</span><br><span class="line">    XMFLOAT3 Normal;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> D3D12_INPUT_ELEMENT_DESC[] =</span><br><span class="line">    &#123;</span><br><span class="line">        &#123; <span class="string">&quot;POSITION&quot;</span>, <span class="number">0</span>, DXGI_FORMAT_R32G32B32_FLOAT, <span class="number">0</span>, <span class="number">0</span>, D3D12_INPUT_CLASSIFICATION_PER_VERTEX_DATA, <span class="number">0</span> &#125;,</span><br><span class="line">        &#123; <span class="string">&quot;COLOR&quot;</span>, <span class="number">0</span>, DXGI_FORMAT_R32G32B32A32_FLOAT, <span class="number">0</span>, <span class="number">12</span>, D3D12_INPUT_CLASSIFICATION_PER_VERTEX_DATA, <span class="number">0</span> &#125;,</span><br><span class="line">      &#123; <span class="string">&quot;NORMAL&quot;</span>, <span class="number">0</span>, DXGI_FORMAT_R32G32B32A32_FLOAT, <span class="number">0</span>, <span class="number">24</span>, D3D12_INPUT_CLASSIFICATION_PER_VERTEX_DATA, <span class="number">0</span> &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">VertexIn</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    float3 PosL:POSTION;</span><br><span class="line">    float4 Color:COLOR;</span><br><span class="line">    <span class="comment">//float3 Normal:NORMAL;//输入有多余的参数可以匹配</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">VertexOut</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    float3 PosH:SV_POSTION;</span><br><span class="line">    float4 Color:COLOR;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">VertexOut <span class="title">VS</span><span class="params">(VertexIn vin)</span></span>&#123;...&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>匹配</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Vertex</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    XMFLOAT3 Pos;</span><br><span class="line">    XMFLOAT4 Color;</span><br><span class="line">    XMFLOAT3 Normal;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> D3D12_INPUT_ELEMENT_DESC[] =</span><br><span class="line">    &#123;</span><br><span class="line">        &#123; <span class="string">&quot;POSITION&quot;</span>, <span class="number">0</span>, DXGI_FORMAT_R32G32B32_FLOAT, <span class="number">0</span>, <span class="number">0</span>, D3D12_INPUT_CLASSIFICATION_PER_VERTEX_DATA, <span class="number">0</span> &#125;,</span><br><span class="line">        &#123; <span class="string">&quot;COLOR&quot;</span>, <span class="number">0</span>, DXGI_FORMAT_R32G32B32A32_FLOAT, <span class="number">0</span>, <span class="number">12</span>, D3D12_INPUT_CLASSIFICATION_PER_VERTEX_DATA, <span class="number">0</span> &#125;,</span><br><span class="line">      &#123; <span class="string">&quot;NORMAL&quot;</span>, <span class="number">0</span>, DXGI_FORMAT_R32G32B32A32_FLOAT, <span class="number">0</span>, <span class="number">24</span>, D3D12_INPUT_CLASSIFICATION_PER_VERTEX_DATA, <span class="number">0</span> &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">VertexIn</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    float3 PosL:POSTION;</span><br><span class="line">    float4 Color:COLOR;</span><br><span class="line">    int3  Normal:NORMAL;<span class="comment">//Direct3D会对数据类型重新解释，但会报警告</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">VertexOut</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    float3 PosH:SV_POSTION;</span><br><span class="line">    float4 Color:COLOR;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">VertexOut <span class="title">VS</span><span class="params">(VertexIn vin)</span></span>&#123;...&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="像素着色器示例"><a href="#像素着色器示例" class="headerlink" title="像素着色器示例"></a>像素着色器示例</h3><p>光栅化阶段先对顶点着色器进行插值计算，然后把数据传递至像素着色器作为输出</p>
<p>像素着色器针对每一个像素片段而运行的函数，但是部分像素片段不会传入或者留存在后台缓冲区，会在深度测试等情况被丢弃掉；即<strong>像素</strong>是最终写入后台缓冲区的数据，<strong>像素片段</strong>是候选像素</p>
<p>示例</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cbuffer cbPerObject:<span class="built_in"><span class="keyword">register</span></span>(b0)</span><br><span class="line">&#123;</span><br><span class="line">    float4x4 gWorldViewProj;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">VS</span><span class="params">(float3 iPosL:POSITION,float4 iColor:COLOR,out float4 oPosH:SV_POSTION,out float4 oColor:COLOR)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//把顶点变换到齐次裁剪空间</span></span><br><span class="line">    oPosH = <span class="built_in">mul</span>(<span class="built_in">float4</span>(iPosL,<span class="number">1.0f</span>),gWolrdViewProj);</span><br><span class="line">    <span class="comment">//将顶点颜色信息传至像素着色器</span></span><br><span class="line">    oColor=iColor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">float4 <span class="title">PS</span><span class="params">(float4 posH:SV_POSITION,float4 color:COLOR)</span>:SV_TARGET</span></span><br><span class="line"><span class="function">&#123;</span></span><br><span class="line">    <span class="keyword">return</span> color;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参数列表后的<code>SV_TARGET</code>表示该返回值的类型樱岛与渲染目标格式相匹配(<code>render target format</code> )1</p>
<p>同样可以利用输入输出结构体来重写上述代码</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">VertexIn</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    float3 PosL:POSTION;</span><br><span class="line">    float4 Color:COLOR;</span><br><span class="line">  </span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">VertexOut</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    float3 PosH:SV_POSTION;</span><br><span class="line">    float4 Color:COLOR;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">VextexOut <span class="title">VS</span><span class="params">(VertexIn vin)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    VertexOut vout;</span><br><span class="line">    vout.PosH=<span class="built_in">mul</span>(<span class="built_in">float4</span>(vin.PosL,<span class="number">1.0f</span>),gWolrdViewProj);</span><br><span class="line">    vout.Color=vin.Color;</span><br><span class="line">    <span class="keyword">return</span> vout;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">float4 <span class="title">PS</span><span class="params">(VertexOut pin)</span>:VS_TARGET</span></span><br><span class="line"><span class="function">&#123;</span></span><br><span class="line">    <span class="keyword">return</span> pin.Color;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h3 id="常量缓冲区"><a href="#常量缓冲区" class="headerlink" title="常量缓冲区"></a>常量缓冲区</h3><h5 id="创建常量缓冲区"><a href="#创建常量缓冲区" class="headerlink" title="创建常量缓冲区"></a>创建常量缓冲区</h5><p>常量缓冲区也是一种GPU资源<code>ID3D12Resource</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cbuffer cbPerObject:<span class="built_in"><span class="keyword">register</span></span>(b0)</span><br><span class="line">&#123;</span><br><span class="line">    float4x4 gWorldViewProj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此代码中的<code>cbuffer</code>对象（常量缓冲区）的名称就是<code>cbPerObject</code>，存储一个4x4矩阵<code>gWorldViewProj</code></p>
<p>此矩阵表示把一个点从局部空间变换到齐次裁剪空间所用到的由世界、视图和投影3种变换组合而成的矩阵</p>
<blockquote>
<p>与顶点和索引缓冲区不同，从常量缓冲区由CPU<strong>每帧更新顶一次</strong></p>
<p>常量缓冲区创建到上传堆而非默认堆，使得我们从CPU端更新常量</p>
<p>常量缓冲区的硬件有特别要求，<strong>大小必须为256B的整数倍</strong></p>
</blockquote>
<p>示例</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ObjectConstants</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    XMFLOAT4X4 WorldViewProj = MathHelper::<span class="built_in">Identity4x4</span>();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"> UINT mElementByteSize = d3dUtil::<span class="built_in">CalcConstantBufferByteSize</span>(<span class="built_in"><span class="keyword">sizeof</span></span>(T));<span class="comment">//换算使得缓冲区大小保持在256B的倍数</span></span><br><span class="line"></span><br><span class="line">Microsoft::WRL::ComPtr&lt;ID3D12Resource&gt; mUploadBuffer;</span><br><span class="line"><span class="built_in">ThrowIfFailed</span>(device-&gt;<span class="built_in">CreateCommittedResource</span>(</span><br><span class="line">            &amp;<span class="built_in">CD3DX12_HEAP_PROPERTIES</span>(D3D12_HEAP_TYPE_UPLOAD),</span><br><span class="line">            D3D12_HEAP_FLAG_NONE,</span><br><span class="line">            &amp;CD3DX12_RESOURCE_DESC::<span class="built_in">Buffer</span>(mElementByteSize*elementCount),</span><br><span class="line">			D3D12_RESOURCE_STATE_GENERIC_READ,</span><br><span class="line">            <span class="literal">nullptr</span>,</span><br><span class="line">            <span class="built_in">IID_PPV_ARGS</span>(&amp;mUploadBuffer)));</span><br></pre></td></tr></table></figure>

<p><code>mUploadCBuffer</code>存储了一个<code>ObjectConstants</code>类型的常量缓冲区数组</p>
<p>绘制物体时，只要将常量缓冲区视图<code>CBV</code>绑定到那个存有物体相应常量缓冲区的子区域即可</p>
<ul>
<li>着色器模型5.1</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ObjectConstants</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    float4x4 gWorldViewProj;</span><br><span class="line">    uint matIndex;</span><br><span class="line">&#125;;</span><br><span class="line">ConstantBuffer&lt;ObjectConstants&gt; gObjConstants : <span class="built_in"><span class="keyword">register</span></span>(b0);</span><br></pre></td></tr></table></figure>

<p>常量缓冲区的数据元素被定义在一个单独的结构体中，随后用这个结构来创建一个常量缓冲区，然后就可以在着色器里访问常量缓冲区中的各个字段</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uint index = gObjConstants.matIndex;</span><br></pre></td></tr></table></figure>





<blockquote>
<p>着色器模型定义了HLSL的编写规范，确定了其内置函数、着色器属性等一切语言元素</p>
</blockquote>
<h5 id="更新常量缓冲区"><a href="#更新常量缓冲区" class="headerlink" title="更新常量缓冲区"></a>更新常量缓冲区</h5><p>常量缓冲区是用<code>D3D12_HEAP_TYPE_UPLOAD</code>类型创建的，所以可以用CPU为常量缓冲区更新数据</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Microsoft::WRL::ComPtr&lt;ID3D12Resource&gt; mUploadBuffer;</span><br><span class="line">BYTE* mMappedData = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="comment">//参数1：预映射的子资源，对于缓冲区来说设置为0</span></span><br><span class="line"><span class="comment">//参数2：指向D3D12_RANGE结构体的可选项，描述了映射范围，如果是空就对整个资源映射</span></span><br><span class="line"><span class="comment">//参数3：双重指针返回待映射资源书的目标内存块</span></span><br><span class="line"><span class="built_in">ThrowIfFailed</span>(mUploadBuffer-&gt;<span class="built_in">Map</span>(<span class="number">0</span>, <span class="literal">nullptr</span>, <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">void</span>**&gt;(&amp;mMappedData)));</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memcpy</span>(mMappedData,&amp;data,dataSizeInBytes);<span class="comment">//用此函数将数据从系统内存复制到常量缓冲区</span></span><br></pre></td></tr></table></figure>

<p>等更新完成，然后在释放映射内存之前对其进行<code>Unmap(取消映射)</code>操作</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(mUploadBuffer != <span class="literal">nullptr</span>)</span><br><span class="line">    mUploadBuffer-&gt;<span class="built_in">Unmap</span>(<span class="number">0</span>,<span class="literal">nullptr</span>);</span><br><span class="line">mMappedData = <span class="literal">nullptr</span>;</span><br></pre></td></tr></table></figure>

<p><code>Unmap</code>的第一个参数是子资源索引，第二个是指向<code>D3D12_RANGE</code>结构体的指针，描述取消映射的内存范围，如空则整个资源映射。</p>
<h5 id="上传缓冲区辅助函数"><a href="#上传缓冲区辅助函数" class="headerlink" title="上传缓冲区辅助函数"></a>上传缓冲区辅助函数</h5><ul>
<li>UploadBuffer类</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UploadBuffer</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">UploadBuffer</span>(ID3D12Device* device, UINT elementCount, <span class="keyword">bool</span> isConstantBuffer) : </span><br><span class="line">        <span class="built_in">mIsConstantBuffer</span>(isConstantBuffer)</span><br><span class="line">    &#123;</span><br><span class="line">        mElementByteSize = <span class="built_in"><span class="keyword">sizeof</span></span>(T);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//常量缓冲区的大小为256B的整数倍</span></span><br><span class="line">        <span class="comment">//长度者两种规格来查看常量数据</span></span><br><span class="line">        <span class="comment">//UINT64 SizeInBytes;//256的整数倍</span></span><br><span class="line">        <span class="comment">//UINT OffsetInBytes;//256的整数倍</span></span><br><span class="line">        <span class="keyword">if</span>(isConstantBuffer)</span><br><span class="line">            mElementByteSize = d3dUtil::<span class="built_in">CalcConstantBufferByteSize</span>(<span class="built_in"><span class="keyword">sizeof</span></span>(T));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">ThrowIfFailed</span>(device-&gt;<span class="built_in">CreateCommittedResource</span>(</span><br><span class="line">            &amp;<span class="built_in">CD3DX12_HEAP_PROPERTIES</span>(D3D12_HEAP_TYPE_UPLOAD),</span><br><span class="line">            D3D12_HEAP_FLAG_NONE,</span><br><span class="line">            &amp;CD3DX12_RESOURCE_DESC::<span class="built_in">Buffer</span>(mElementByteSize*elementCount),</span><br><span class="line">			D3D12_RESOURCE_STATE_GENERIC_READ,</span><br><span class="line">            <span class="literal">nullptr</span>,</span><br><span class="line">            <span class="built_in">IID_PPV_ARGS</span>(&amp;mUploadBuffer)));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">ThrowIfFailed</span>(mUploadBuffer-&gt;<span class="built_in">Map</span>(<span class="number">0</span>, <span class="literal">nullptr</span>, <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">void</span>**&gt;(&amp;mMappedData)));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//只要还会需改当前的资源，我们就无需取消映射</span></span><br><span class="line">        <span class="comment">// 但是在资源被GPU使用期间，我们千万不可向该资源进行写操作（所以需要借助同步技术）</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">UploadBuffer</span>(<span class="keyword">const</span> UploadBuffer&amp; rhs) = <span class="keyword">delete</span>;</span><br><span class="line">    UploadBuffer&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> UploadBuffer&amp; rhs) = <span class="keyword">delete</span>;</span><br><span class="line">    ~<span class="built_in">UploadBuffer</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(mUploadBuffer != <span class="literal">nullptr</span>)</span><br><span class="line">            mUploadBuffer-&gt;<span class="built_in">Unmap</span>(<span class="number">0</span>, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">        mMappedData = <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">ID3D12Resource* <span class="title">Resource</span><span class="params">()</span><span class="keyword">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mUploadBuffer.<span class="built_in">Get</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">CopyData</span><span class="params">(<span class="keyword">int</span> elementIndex, <span class="keyword">const</span> T&amp; data)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;mMappedData[elementIndex*mElementByteSize], &amp;data, <span class="built_in"><span class="keyword">sizeof</span></span>(T));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    Microsoft::WRL::ComPtr&lt;ID3D12Resource&gt; mUploadBuffer;</span><br><span class="line">    BYTE* mMappedData = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">    UINT mElementByteSize = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">bool</span> mIsConstantBuffer = <span class="literal">false</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>世界矩阵随移动/旋转/缩放而改变</p>
<p>观察矩阵随虚拟摄像机的移动/旋转/缩放而改变</p>
<p>投影矩阵随窗口大小调整而改变</p>
</blockquote>
<ul>
<li>OnMouseMove</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">BoxApp::OnMouseMove</span><span class="params">(WPARAM btnState, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>((btnState &amp; MK_LBUTTON) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 根据鼠标的移动距离计算旋转角度，令每个像素按此角度的1/4旋转</span></span><br><span class="line">        <span class="keyword">float</span> dx = <span class="built_in">XMConvertToRadians</span>(<span class="number">0.25f</span>*<span class="keyword">static_cast</span>&lt;<span class="keyword">float</span>&gt;(x - mLastMousePos.x));</span><br><span class="line">        <span class="keyword">float</span> dy = <span class="built_in">XMConvertToRadians</span>(<span class="number">0.25f</span>*<span class="keyword">static_cast</span>&lt;<span class="keyword">float</span>&gt;(y - mLastMousePos.y));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 根据鼠标输入来更新摄像机绕立方体旋转的角度</span></span><br><span class="line">        mTheta += dx;</span><br><span class="line">        mPhi += dy;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 限制角度mPhi的范围</span></span><br><span class="line">        mPhi = MathHelper::<span class="built_in">Clamp</span>(mPhi, <span class="number">0.1f</span>, MathHelper::Pi - <span class="number">0.1f</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>((btnState &amp; MK_RBUTTON) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 使场景中的每个像素按鼠标移动距离的0.005倍进行缩放</span></span><br><span class="line">        <span class="keyword">float</span> dx = <span class="number">0.005f</span>*<span class="keyword">static_cast</span>&lt;<span class="keyword">float</span>&gt;(x - mLastMousePos.x);</span><br><span class="line">        <span class="keyword">float</span> dy = <span class="number">0.005f</span>*<span class="keyword">static_cast</span>&lt;<span class="keyword">float</span>&gt;(y - mLastMousePos.y);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 根据鼠标的输入更新摄像机的可视范围半径</span></span><br><span class="line">        mRadius += dx - dy;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 限制可视半径范围</span></span><br><span class="line">        mRadius = MathHelper::<span class="built_in">Clamp</span>(mRadius, <span class="number">3.0f</span>, <span class="number">15.0f</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mLastMousePos.x = x;</span><br><span class="line">    mLastMousePos.y = y;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>Update</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">BoxApp::Update</span><span class="params">(<span class="keyword">const</span> GameTimer&amp; gt)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 将球坐标（球面坐标）转换为笛卡尔坐标系</span></span><br><span class="line">    <span class="keyword">float</span> x = mRadius*<span class="built_in">sinf</span>(mPhi)*<span class="built_in">cosf</span>(mTheta);</span><br><span class="line">    <span class="keyword">float</span> z = mRadius*<span class="built_in">sinf</span>(mPhi)*<span class="built_in">sinf</span>(mTheta);</span><br><span class="line">    <span class="keyword">float</span> y = mRadius*<span class="built_in">cosf</span>(mPhi);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构建观察矩阵</span></span><br><span class="line">    XMVECTOR pos = <span class="built_in">XMVectorSet</span>(x, y, z, <span class="number">1.0f</span>);</span><br><span class="line">    XMVECTOR target = <span class="built_in">XMVectorZero</span>();</span><br><span class="line">    XMVECTOR up = <span class="built_in">XMVectorSet</span>(<span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>);</span><br><span class="line"></span><br><span class="line">    XMMATRIX view = <span class="built_in">XMMatrixLookAtLH</span>(pos, target, up);</span><br><span class="line">    <span class="built_in">XMStoreFloat4x4</span>(&amp;mView, view);</span><br><span class="line"></span><br><span class="line">    XMMATRIX world = <span class="built_in">XMLoadFloat4x4</span>(&amp;mWorld);</span><br><span class="line">    XMMATRIX proj = <span class="built_in">XMLoadFloat4x4</span>(&amp;mProj);</span><br><span class="line">    XMMATRIX worldViewProj = world*view*proj;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 用最新的 worldViewProj 矩阵来更新常量缓冲区</span></span><br><span class="line">	ObjectConstants objConstants;</span><br><span class="line">    <span class="built_in">XMStoreFloat4x4</span>(&amp;objConstants.WorldViewProj, <span class="built_in">XMMatrixTranspose</span>(worldViewProj));</span><br><span class="line">    mObjectCB-&gt;<span class="built_in">CopyData</span>(<span class="number">0</span>, objConstants);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="常量缓冲区描述符"><a href="#常量缓冲区描述符" class="headerlink" title="常量缓冲区描述符"></a>常量缓冲区描述符</h5><p>常量缓冲区描述符都存放在以<code>D3D12_DESCRIPTOR_HEAP_TYPE_CBV_SRV_UAV</code>类型的描述符堆里，这个堆混合存储了常量缓冲区、着色器资源和无序访问描述符</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">D3D12_DESCRIPTOR_HEAP_DESC cbvHeapDesc;</span><br><span class="line">   cbvHeapDesc.NumDescriptors = <span class="number">1</span>;</span><br><span class="line">   cbvHeapDesc.Type = D3D12_DESCRIPTOR_HEAP_TYPE_CBV_SRV_UAV;</span><br><span class="line">   cbvHeapDesc.Flags = D3D12_DESCRIPTOR_HEAP_FLAG_SHADER_VISIBLE;</span><br><span class="line">cbvHeapDesc.NodeMask = <span class="number">0</span>;</span><br><span class="line">   <span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateDescriptorHeap</span>(&amp;cbvHeapDesc,</span><br><span class="line">       <span class="built_in">IID_PPV_ARGS</span>(&amp;mCbvHeap)));</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在创建着色器程序访问的描述符时，需要把Flags指定为<code>DESCRIPTOR_HEAP_FLAG_SHADER_VISIBLE</code></p>
</blockquote>
<p>然后通过如下代码创建常量缓冲区</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">BoxApp::BuildConstantBuffers</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//此常量缓冲区存储了绘制n个物体所需的常量数据</span></span><br><span class="line">	std::unique_ptr&lt;UploadBuffer&lt;ObjectConstants&gt;&gt; mObjectCB = std::make_unique&lt;UploadBuffer&lt;ObjectConstants&gt;&gt;(md3dDevice.<span class="built_in">Get</span>(), <span class="number">1</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">	UINT objCBByteSize = d3dUtil::<span class="built_in">CalcConstantBufferByteSize</span>(<span class="built_in"><span class="keyword">sizeof</span></span>(ObjectConstants));</span><br><span class="line">	<span class="comment">//缓冲区的起始地址	</span></span><br><span class="line">	D3D12_GPU_VIRTUAL_ADDRESS cbAddress = mObjectCB-&gt;<span class="built_in">Resource</span>()-&gt;<span class="built_in">GetGPUVirtualAddress</span>();</span><br><span class="line">    <span class="comment">//偏移到常量缓冲区中绘制第i个物体所需的常量数据</span></span><br><span class="line">    <span class="keyword">int</span> boxCBufIndex = <span class="number">0</span>;</span><br><span class="line">	cbAddress += boxCBufIndex*objCBByteSize;</span><br><span class="line"></span><br><span class="line">	D3D12_CONSTANT_BUFFER_VIEW_DESC cbvDesc;</span><br><span class="line">	cbvDesc.BufferLocation = cbAddress;</span><br><span class="line">	cbvDesc.SizeInBytes = d3dUtil::<span class="built_in">CalcConstantBufferByteSize</span>(<span class="built_in"><span class="keyword">sizeof</span></span>(ObjectConstants));</span><br><span class="line"></span><br><span class="line">	md3dDevice-&gt;<span class="built_in">CreateConstantBufferView</span>(</span><br><span class="line">		&amp;cbvDesc,</span><br><span class="line">		mCbvHeap-&gt;<span class="built_in">GetCPUDescriptorHandleForHeapStart</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="根签名和描述符表"><a href="#根签名和描述符表" class="headerlink" title="根签名和描述符表"></a>根签名和描述符表</h5><ul>
<li>根签名</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将纹理资源绑定到纹理寄存器槽0</span></span><br><span class="line">Texture2D gDiffuseMap : <span class="built_in"><span class="keyword">register</span></span>(t0);</span><br><span class="line"><span class="comment">//把下列采样器资源一次绑定到采样器槽0-5</span></span><br><span class="line">SamplerState gsamPointWrap : <span class="built_in"><span class="keyword">register</span></span>(s0);</span><br><span class="line">SamplerState gsamPointClamp : <span class="built_in"><span class="keyword">register</span></span>(s1);</span><br><span class="line"><span class="comment">//将常量缓冲区资源绑定到常量缓冲区寄存器槽0</span></span><br><span class="line">cbuffer cbPerObject : <span class="built_in"><span class="keyword">register</span></span>(b0)</span><br><span class="line">&#123;</span><br><span class="line">    float4x4 gWorld;</span><br><span class="line">    float4x4 gTexTransform;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//绘制每种材质所需的各种不同的常量数据</span></span><br><span class="line">cbuffer cbMaterial : <span class="built_in"><span class="keyword">register</span></span>(b2)</span><br><span class="line">&#123;</span><br><span class="line">    float4 gDiffuseAlbedo;</span><br><span class="line">    float3 gFresnelR0;</span><br><span class="line">    <span class="keyword">float</span> gRoughness;</span><br><span class="line">    float4x4 gMatTransform;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>register(*#)</code>中的<code>*</code>表示寄存器传递的资源类型。</p>
<p>t:着色器资源视图；</p>
<p>s:采样器</p>
<p>u:无序访问视图</p>
<p>b:常量缓冲区视图</p>
</blockquote>
<blockquote>
<p>在执行绘制命令之前，那些应用程序将绑定到渲染流水线上的资源，它们会被映射到着色器的对应输入寄存器。</p>
<p>根签名一定要与使用它的着色器相兼容，在创建流水线状态对象时会对此进行验证</p>
<p>不同的绘制调用可能会用到一组不同的着色器程序，意味着要用到不同的<strong>根签名</strong></p>
</blockquote>
<p>在Direct3D中，根签名由<code>ID3D12RootSignature</code>接口表示，并用一组描述绘制调用过程中着色器所需资源的<code>根参数</code>定义而成。</p>
<p>根参数可以是<code>根常量</code>、<code>根描述符</code>或者<code>描述符表</code></p>
<blockquote>
<p>如果把着色器程序看成是一个大函数，那顶点数据和常量数据就是从CPU传入着色器函数的参数，而根签名就好比这些参数的函数签名。所以根签名其实就是将着色器需要用到的数据绑定到对应的寄存器槽上，供着色器访问。</p>
</blockquote>
<p>示例</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">oid <span class="title">BoxApp::BuildRootSignature</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// Shader programs typically require resources as input (constant buffers,</span></span><br><span class="line">	<span class="comment">// textures, samplers).  The root signature defines the resources the shader</span></span><br><span class="line">	<span class="comment">// programs expect.  If we think of the shader programs as a function, and</span></span><br><span class="line">	<span class="comment">// the input resources as function parameters, then the root signature can be</span></span><br><span class="line">	<span class="comment">// thought of as defining the function signature.  </span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 根参数可以是根常量、根描述符或者描述符表</span></span><br><span class="line">	CD3DX12_ROOT_PARAMETER slotRootParameter[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建一个只存有一个CBV的描述符表</span></span><br><span class="line">	CD3DX12_DESCRIPTOR_RANGE cbvTable;</span><br><span class="line">	cbvTable.<span class="built_in">Init</span>(D3D12_DESCRIPTOR_RANGE_TYPE_CBV, <span class="number">1</span>, <span class="number">0</span>);<span class="comment">//1：表中的描述符数量，0：将此段描述符区域绑定至此基准着色器寄存器</span></span><br><span class="line">	slotRootParameter[<span class="number">0</span>].<span class="built_in">InitAsDescriptorTable</span>(<span class="number">1</span>, &amp;cbvTable);<span class="comment">//1：描述符区域的数量；table:指向描述符区域数组的指针</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 根签名由一组根参数构成</span></span><br><span class="line">	<span class="function">CD3DX12_ROOT_SIGNATURE_DESC <span class="title">rootSigDesc</span><span class="params">(<span class="number">1</span>, slotRootParameter, <span class="number">0</span>, <span class="literal">nullptr</span>, </span></span></span><br><span class="line"><span class="params"><span class="function">		D3D12_ROOT_SIGNATURE_FLAG_ALLOW_INPUT_ASSEMBLER_INPUT_LAYOUT)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//创建仅含一个槽位的根签名</span></span><br><span class="line">	ComPtr&lt;ID3DBlob&gt; serializedRootSig = <span class="literal">nullptr</span>;</span><br><span class="line">	ComPtr&lt;ID3DBlob&gt; errorBlob = <span class="literal">nullptr</span>;</span><br><span class="line">	HRESULT hr = <span class="built_in">D3D12SerializeRootSignature</span>(&amp;rootSigDesc, D3D_ROOT_SIGNATURE_VERSION_1,</span><br><span class="line">		serializedRootSig.<span class="built_in">GetAddressOf</span>(), errorBlob.<span class="built_in">GetAddressOf</span>());</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(errorBlob != <span class="literal">nullptr</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		::<span class="built_in">OutputDebugStringA</span>((<span class="keyword">char</span>*)errorBlob-&gt;<span class="built_in">GetBufferPointer</span>());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(hr);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateRootSignature</span>(</span><br><span class="line">		<span class="number">0</span>,</span><br><span class="line">		serializedRootSig-&gt;<span class="built_in">GetBufferPointer</span>(),</span><br><span class="line">		serializedRootSig-&gt;<span class="built_in">GetBufferSize</span>(),</span><br><span class="line">		<span class="built_in">IID_PPV_ARGS</span>(&amp;mRootSignature)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Root parameter can be a table, root descriptor or root constants.</span></span><br><span class="line">	CD3DX12_ROOT_PARAMETER slotRootParameter[<span class="number">1</span>];</span><br><span class="line">cbvTable.<span class="built_in">Init</span>(D3D12_DESCRIPTOR_RANGE_TYPE_CBV,<span class="comment">//描述符表的类型</span></span><br><span class="line">              <span class="number">1</span>, <span class="comment">//表中描述符的数量</span></span><br><span class="line">              <span class="number">0</span>);<span class="comment">//将这段描述符区域绑定至此基础着色器寄存器</span></span><br><span class="line">	slotRootParameter[<span class="number">0</span>].<span class="built_in">InitAsDescriptorTable</span>(<span class="number">1</span>,<span class="comment">//描述符区域的数量</span></span><br><span class="line">                                               &amp;cbvTable);<span class="comment">//指向描述符区域数组的指针</span></span><br></pre></td></tr></table></figure>

<p>上述代码创建了一个根参数，目的是将含有一个<code>CBV</code>的描述符表绑定到常量缓冲区寄存器0，即<code>HLSL</code>代码中的<code>register(b0)</code></p>
<hr>
<p>根签名至定义了应用程序要绑定到渲染流水线的资源，没有真正的执行任何资源绑定操作</p>
<p>只有通过命令列表设置根签名，才可以用<code>ID3D12GraphicsCommandList::SetGraphicsRootDescriptorTable</code> 方法令描述符表与渲染流水线绑定</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mCommandList-&gt;<span class="built_in">SetGraphicsRootDescriptorTable</span>(<span class="number">0</span>, <span class="comment">//将根参数按此索引进行设置</span></span><br><span class="line">mCbvHeap-&gt;<span class="built_in">GetGPUDescriptorHandleForHeapStart</span>());<span class="comment">//此参数指定的是将要想着色器绑定的描述符表中的第一个描述符位于描述符堆中的句柄</span></span><br></pre></td></tr></table></figure>

<p>下列代码先将根签名和CBV堆设置到命令列表上，并随后通过设置描述符表来指定我们希望绑定到渲染流水线的资源</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mCommandList-&gt;<span class="built_in">SetGraphicsRootSignature</span>(mRootSignature.<span class="built_in">Get</span>());</span><br><span class="line"></span><br><span class="line">ID3D12DescriptorHeap* descriptorHeaps[] = &#123; mCbvHeap.<span class="built_in">Get</span>() &#125;;</span><br><span class="line">	mCommandList-&gt;<span class="built_in">SetDescriptorHeaps</span>(_countof(descriptorHeaps), descriptorHeaps);</span><br><span class="line"><span class="comment">//偏移到此次绘制调用所需的CBV处</span></span><br><span class="line"><span class="function">CD3DX12_GPU_DESCRIPTOR_HANDLE <span class="title">cbv</span><span class="params">(mCbvHeap-&gt;GetGPUDescriptorHandleForHeapStart())</span></span>;</span><br><span class="line">cbv.<span class="built_in">Offset</span>(cbvIndex,mCbvSrvUavDescriptorSize);</span><br><span class="line"></span><br><span class="line">mCommandList-&gt;<span class="built_in">SetGraphicsRootDescriptorTable</span>(<span class="number">0</span>,cbv);</span><br></pre></td></tr></table></figure>





<p>·</p>
<h3 id="编译着色器"><a href="#编译着色器" class="headerlink" title="编译着色器"></a>编译着色器</h3><p>着色器程序必须先被编译为一种可移植的字节码，接下来图形驱动程序将获取这些字节码，并将其重新便以为针对当前系统GPU所优化的本地指令[ATI1]</p>
<p>可以用如下函数在运行期间对着色器进行编译</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HRESULT <span class="title">D3DCompileFromFile</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	LPCWSTR pFileName,<span class="comment">//希望编译的以.hlsl作为扩展名的源代码文件</span></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> D3D_SHADER_MACRO *pDefines,<span class="comment">//本书中用nullptr</span></span></span></span><br><span class="line"><span class="params"><span class="function">    ID3DInclude *pInclude,<span class="comment">//同上</span></span></span></span><br><span class="line"><span class="params"><span class="function">    LPOCSTR pEntrypoint,<span class="comment">//着色器入口点函数，一个.hlsl文件可能存有多个着色器程序</span></span></span></span><br><span class="line"><span class="params"><span class="function">    LPCSTR pTarget,<span class="comment">//指定所用着色器类型和版本的字符串，本书用的是5.0和5.1</span></span></span></span><br><span class="line"><span class="params"><span class="function">    UINT Flags1,<span class="comment">//一般用2种：D3DCOMPLIE_DEBUG/D3DCOMPILE_SKIP_OPTIMIZATIOIN，详见SDK</span></span></span></span><br><span class="line"><span class="params"><span class="function">    UINT Flags2,<span class="comment">//本书不用</span></span></span></span><br><span class="line"><span class="params"><span class="function">    ID3DBlob **ppCode,<span class="comment">//返回一个数据结构指针，存储着编译好的着色器对象字节码</span></span></span></span><br><span class="line"><span class="params"><span class="function">    ID3DBlob **ppErrorMsgs<span class="comment">//返回报错信息               </span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>ID3DBlob</li>
</ul>
<p>一段普通的内存块，有2个接口方法</p>
<ol>
<li><code>LPVOID GetBufferPointer</code>:返回对象中数据的<code>void*</code>类型的指针，使用之前需要转换为适当类型</li>
<li><code>SIZE_T GetBufferSize</code>：返回缓冲区字节大小</li>
</ol>
<ul>
<li>运行时编译着色器函数</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ComPtr&lt;ID3DBlob&gt;  <span class="title">CompileShader</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="keyword">const</span> std::wstring&amp; fileName, </span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="keyword">const</span> D3D_SHADER_MACRO* defines, </span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="keyword">const</span> std::string&amp; enteryPoint, </span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="keyword">const</span> std::string&amp; target)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//若处于调试模式，则使用调试标志</span></span><br><span class="line">	UINT compileFlags = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(DEBUG) || defined(_DEBUG)</span></span><br><span class="line">	<span class="comment">//用调试模式来编译着色器 | 指示编译器跳过优化阶段</span></span><br><span class="line">	compileFlags = D3DCOMPILE_DEBUG | D3DCOMPILE_SKIP_OPTIMIZATION;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// defined(DEBUG) || defined(_DEBUG)</span></span></span><br><span class="line"></span><br><span class="line">	HRESULT hr = S_OK;</span><br><span class="line"></span><br><span class="line">	ComPtr&lt;ID3DBlob&gt; byteCode = <span class="literal">nullptr</span>;</span><br><span class="line">	ComPtr&lt;ID3DBlob&gt; errors;</span><br><span class="line">	hr = <span class="built_in">D3DCompileFromFile</span>(fileName.<span class="built_in">c_str</span>(), <span class="comment">//hlsl源文件名</span></span><br><span class="line">		defines,	<span class="comment">//高级选项，指定为空指针</span></span><br><span class="line">		D3D_COMPILE_STANDARD_FILE_INCLUDE,	<span class="comment">//高级选项，可以指定为空指针</span></span><br><span class="line">		enteryPoint.<span class="built_in">c_str</span>(),	<span class="comment">//着色器的入口点函数名</span></span><br><span class="line">		target.<span class="built_in">c_str</span>(),		<span class="comment">//指定所用着色器类型和版本的字符串</span></span><br><span class="line">		compileFlags,	<span class="comment">//指示对着色器断代码应当如何编译的标志</span></span><br><span class="line">		<span class="number">0</span>,	<span class="comment">//高级选项</span></span><br><span class="line">		&amp;byteCode,	<span class="comment">//编译好的字节码</span></span><br><span class="line">		&amp;errors);	<span class="comment">//错误信息</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (errors != <span class="literal">nullptr</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">OutputDebugStringA</span>((<span class="keyword">char</span>*)errors-&gt;<span class="built_in">GetBufferPointer</span>());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(hr);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> byteCode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="离线编译"><a href="#离线编译" class="headerlink" title="离线编译"></a>离线编译</h5><p>离线编译的原因</p>
<ol>
<li>对于复杂的着色器，编译耗时太长，因此借助离线编译即可缩短应用程序的加载时间</li>
<li>以便在早于运行时的构建处理期间提早发现编译错误</li>
<li>对于Windows9应用商店的应用而言，必须采取离线编译这种方式</li>
</ol>
<blockquote>
<p>一般用<code>.cso</code>为已编译的着色器对象的扩展名</p>
</blockquote>
<p>使用DirectX自带的<code>FXC</code>命令行编译工具编译</p>
<ul>
<li>如用CMD输入代码编译</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\<span class="function">Program <span class="title">Files</span> <span class="params">(x86)</span>\Windows Kits\10\bin\x86&gt;fxc.exe C:\Users\Administrator\Desktop\color.hlsl /T vs_5_0 /Fo <span class="string">&quot;color.cso&quot;</span> /E <span class="string">&quot;VS&quot;</span></span></span><br></pre></td></tr></table></figure>

<p>成功输出<code>color.cso</code>文件</p>
<blockquote>
<p>compilation object save succeeded; see C:\Program Files (x86)\Windows Kits\10\bin\x86\color.cso</p>
</blockquote>
<ul>
<li>常用的编译参数</li>
</ul>
<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>/Od</td>
<td>禁用优化（利于调试）</td>
</tr>
<tr>
<td>/Zi</td>
<td>开启调试信息</td>
</tr>
<tr>
<td>/T “string”</td>
<td>着色器模型版本,如输入<code>vs_5_0</code></td>
</tr>
<tr>
<td>/E “string”</td>
<td>着色器入口，如案例中的<code>VS</code>,<code>PS</code></td>
</tr>
<tr>
<td>/Fo “string”</td>
<td>经过编译的着色器对象字节码</td>
</tr>
<tr>
<td>/Fc “string”</td>
<td>输出一个着色器汇编语言清单（调试、查阅细节）</td>
</tr>
</tbody></table>
<p>其他清单可以参考<a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/windows/win32/direct3dtools/dx-graphics-tools-fxc-syntax">微软SDK文档</a></p>
<h3 id="光栅器状态"><a href="#光栅器状态" class="headerlink" title="光栅器状态"></a>光栅器状态</h3><p>光栅器状态只接受配置，非可编程，由结构体<code>D3D12_RASTERIZER_DESC</code>表示</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">D3D12_RASTERIZER_DESC</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">    D3D12_FILL_MODE FillMode;<span class="comment">//默认：D3D12_FILL_MODE_SOLID</span></span><br><span class="line">    D3D12_CULL_MODE CullMode;<span class="comment">//默认: D3D12_CULL_MODE_BACK</span></span><br><span class="line">    BOOL FrontCounterClockwise;<span class="comment">//默认:false</span></span><br><span class="line">    INT DepthBias;</span><br><span class="line">    FLOAT DepthBiasClamp;</span><br><span class="line">    FLOAT SlopeScaledDepthBias;</span><br><span class="line">    BOOL DepthClipEnable;</span><br><span class="line">    BOOL MultisampleEnable;</span><br><span class="line">    BOOL AntialiasedLineEnable;</span><br><span class="line">    UINT ForcedSampleCount;</span><br><span class="line">    D3D12_CONSERVATIVE_RASTERIZATION_MODE ConservativeRaster;</span><br><span class="line">    &#125; 	D3D12_RASTERIZER_DESC;</span><br></pre></td></tr></table></figure>

<p>FillMode:默认是实体渲染，如果用<code>D3D12_FILL_MODE_WIREFRAME</code>则是线框渲染</p>
<p>CullMode：默认剔除背面，<code>D3D12_CULL_MODE_NONE</code>不剔除，<code>D3D12_CULL_MODE_FRONT</code>剔除正面</p>
<p>FrontCounterClockwise：默认false，根据观察视角，将定点顺序为顺时针方向的三角形看作正面；如true则相反</p>
<p>示例</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">CD3DX12_RASTERIZER_DESC <span class="title">rsDesc</span><span class="params">(D3D12_DEFAULT)</span></span>;</span><br><span class="line">reDesc.FillMode = D3D12_FILL_MODE_WIREFRAME;</span><br><span class="line">reDesc.CullMode = D3D12_CULL_MODE_NONE;</span><br></pre></td></tr></table></figure>

<p><code>CD3DX12_RASTERIZER_DESC</code>是扩展自<code>D3DX12_RASTERIZER_DESC</code>的结构，添加了一些辅助构造函数的工具类，如接受<code>CD3DX12_DEFAULT</code>参数的构造函数。</p>
<p><code>CD3DX12_DEFAULT</code>是一个哑类型(dummy),将需要被初始化的成员重载为默认值</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">CD3DX12_DEFAULT</span> &#123;</span>&#125;;</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">const</span> DECLSPEC_SELECTANY CD3DX12_DEFAULT D3D12_DEFAULT;</span><br></pre></td></tr></table></figure>

<h3 id="流水线状态对象"><a href="#流水线状态对象" class="headerlink" title="流水线状态对象"></a>流水线状态对象</h3><p><code>ID3D12PipelineState</code>表示<strong>流水线状态对象(PSO)</strong></p>
<p>结构体</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">D3D12_GRAPHICS_PIPELINE_STATE_DESC</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">    ID3D12RootSignature *pRootSignature;<span class="comment">//指向一个于此PSO绑定的根签名，该根签名必须与PSO指定的着色器兼容</span></span><br><span class="line">    D3D12_SHADER_BYTECODE VS;<span class="comment">//待绑定的顶点着色器，用结构体 D3D12_SHADER_BYTECODE表示</span></span><br><span class="line">    D3D12_SHADER_BYTECODE PS;<span class="comment">//待绑定的像素着色器</span></span><br><span class="line">    D3D12_SHADER_BYTECODE DS;<span class="comment">//域着色器</span></span><br><span class="line">    D3D12_SHADER_BYTECODE HS;<span class="comment">//外壳着色器</span></span><br><span class="line">    D3D12_SHADER_BYTECODE GS;<span class="comment">//几何着色器</span></span><br><span class="line">    D3D12_STREAM_OUTPUT_DESC StreamOutput;<span class="comment">//流输出高级技术</span></span><br><span class="line">    D3D12_BLEND_DESC BlendState;<span class="comment">//混合，默认指定CD3DX12_BLEND_DESC(D3D12_DEFAULT)</span></span><br><span class="line">    UINT SampleMask;<span class="comment">//禁止的采样，默认0xffffffff都进行采样</span></span><br><span class="line">    D3D12_RASTERIZER_DESC RasterizerState;<span class="comment">//指定用来配置光栅器的光栅化状态</span></span><br><span class="line">    D3D12_DEPTH_STENCIL_DESC DepthStencilState;<span class="comment">//用于配置深度/模板测试的深度/模板状态，默认用D3D12_DEPTH_STENCIL_DESC(D3D12_DEFAULT)</span></span><br><span class="line">    D3D12_INPUT_LAYOUT_DESC InputLayout;<span class="comment">//输入布局描述，有两个成员，D3D12_INPUT_ELEMENT_DESC数组和一个表示元素个数的无符号整数</span></span><br><span class="line">    D3D12_INDEX_BUFFER_STRIP_CUT_VALUE IBStripCutValue;</span><br><span class="line">    D3D12_PRIMITIVE_TOPOLOGY_TYPE PrimitiveTopologyType;<span class="comment">//图元的拓扑类型，D3D12_PRIMITIVE_TOPOLOGY_TYPE</span></span><br><span class="line">    UINT NumRenderTargets;<span class="comment">//同时所用的渲染目标数量</span></span><br><span class="line">    DXGI_FORMAT RTVFormats[ <span class="number">8</span> ];<span class="comment">//渲染目标格式</span></span><br><span class="line">    DXGI_FORMAT DSVFormat;<span class="comment">//深度/模板缓冲的格式</span></span><br><span class="line">    DXGI_SAMPLE_DESC SampleDesc;<span class="comment">//多重采样对每个像素采样的数量和质量级别</span></span><br><span class="line">    UINT NodeMask;</span><br><span class="line">    D3D12_CACHED_PIPELINE_STATE CachedPSO;</span><br><span class="line">    D3D12_PIPELINE_STATE_FLAGS Flags;</span><br><span class="line">    &#125; 	D3D12_GRAPHICS_PIPELINE_STATE_DESC;</span><br></pre></td></tr></table></figure>



<p>示例</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">D3D12_GRAPHICS_PIPELINE_STATE_DESC psoDesc;</span><br><span class="line">    <span class="built_in">ZeroMemory</span>(&amp;psoDesc, <span class="built_in"><span class="keyword">sizeof</span></span>(D3D12_GRAPHICS_PIPELINE_STATE_DESC));</span><br><span class="line">    psoDesc.InputLayout = &#123; mInputLayout.<span class="built_in">data</span>(), (UINT)mInputLayout.<span class="built_in">size</span>() &#125;;</span><br><span class="line">    psoDesc.pRootSignature = mRootSignature.<span class="built_in">Get</span>();</span><br><span class="line">    psoDesc.VS = </span><br><span class="line">	&#123; </span><br><span class="line">		<span class="keyword">reinterpret_cast</span>&lt;BYTE*&gt;(mvsByteCode-&gt;<span class="built_in">GetBufferPointer</span>()), </span><br><span class="line">		mvsByteCode-&gt;<span class="built_in">GetBufferSize</span>() </span><br><span class="line">	&#125;;</span><br><span class="line">    psoDesc.PS = </span><br><span class="line">	&#123; </span><br><span class="line">		<span class="keyword">reinterpret_cast</span>&lt;BYTE*&gt;(mpsByteCode-&gt;<span class="built_in">GetBufferPointer</span>()), </span><br><span class="line">		mpsByteCode-&gt;<span class="built_in">GetBufferSize</span>() </span><br><span class="line">	&#125;;</span><br><span class="line">    psoDesc.RasterizerState = <span class="built_in">CD3DX12_RASTERIZER_DESC</span>(D3D12_DEFAULT);</span><br><span class="line">    psoDesc.BlendState = <span class="built_in">CD3DX12_BLEND_DESC</span>(D3D12_DEFAULT);</span><br><span class="line">    psoDesc.DepthStencilState = <span class="built_in">CD3DX12_DEPTH_STENCIL_DESC</span>(D3D12_DEFAULT);</span><br><span class="line">    psoDesc.SampleMask = UINT_MAX;</span><br><span class="line">    psoDesc.PrimitiveTopologyType = D3D12_PRIMITIVE_TOPOLOGY_TYPE_TRIANGLE;</span><br><span class="line">    psoDesc.NumRenderTargets = <span class="number">1</span>;</span><br><span class="line">    psoDesc.RTVFormats[<span class="number">0</span>] = mBackBufferFormat;</span><br><span class="line">    psoDesc.SampleDesc.Count = m4xMsaaState ? <span class="number">4</span> : <span class="number">1</span>;</span><br><span class="line">    psoDesc.SampleDesc.Quality = m4xMsaaState ? (m4xMsaaQuality - <span class="number">1</span>) : <span class="number">0</span>;</span><br><span class="line">    psoDesc.DSVFormat = mDepthStencilFormat;</span><br><span class="line">    <span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateGraphicsPipelineState</span>(&amp;psoDesc, <span class="built_in">IID_PPV_ARGS</span>(&amp;mPSO)));</span><br></pre></td></tr></table></figure>

<blockquote>
<p>PSO的验证和创建过于耗时，所以一般在初始化期间就生成PSO</p>
<p>视口和裁剪矩形等属性独立于PSO</p>
</blockquote>
<p>用不同的PSO绘制不同的物体</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mCommandList-&gt;<span class="built_in">Reset</span>(mDirectCmdListAlloc.<span class="built_in">Get</span>(),mPSO1.<span class="built_in">Get</span>());</span><br><span class="line"></span><br><span class="line">mCommandList-&gt;<span class="built_in">Reset</span>(mDirectCmdListAlloc.<span class="built_in">Get</span>(),mPSO2.<span class="built_in">Get</span>());</span><br><span class="line"></span><br><span class="line">mCommandList-&gt;<span class="built_in">Reset</span>(mDirectCmdListAlloc.<span class="built_in">Get</span>(),mPSO3.<span class="built_in">Get</span>());</span><br></pre></td></tr></table></figure>









<h3 id="几何图形辅助结构体"><a href="#几何图形辅助结构体" class="headerlink" title="几何图形辅助结构体"></a>几何图形辅助结构体</h3><p>此结构体定义了MeshGeometry中存储的单个几何体</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SubmeshGeometry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	UINT IndexCount = <span class="number">0</span>;</span><br><span class="line">	UINT StartIndexLocation = <span class="number">0</span>;</span><br><span class="line">	INT BaseVertexLocation = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过此子网格来定义当前结构体中所存几何体的包围盒 bounding box ，后续章节会讲述</span></span><br><span class="line">	DirectX::BoundingBox Bounds;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">MeshGeometry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="comment">// 几何体网格集的名称</span></span><br><span class="line">	std::string Name;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 系统内存中的副本，由于顶点/索引可以是泛型格式，所以用Blob类型</span></span><br><span class="line">	Microsoft::WRL::ComPtr&lt;ID3DBlob&gt; VertexBufferCPU = <span class="literal">nullptr</span>;</span><br><span class="line">	Microsoft::WRL::ComPtr&lt;ID3DBlob&gt; IndexBufferCPU  = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">	Microsoft::WRL::ComPtr&lt;ID3D12Resource&gt; VertexBufferGPU = <span class="literal">nullptr</span>;</span><br><span class="line">	Microsoft::WRL::ComPtr&lt;ID3D12Resource&gt; IndexBufferGPU = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">	Microsoft::WRL::ComPtr&lt;ID3D12Resource&gt; VertexBufferUploader = <span class="literal">nullptr</span>;</span><br><span class="line">	Microsoft::WRL::ComPtr&lt;ID3D12Resource&gt; IndexBufferUploader = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 缓冲区数据</span></span><br><span class="line">	UINT VertexByteStride = <span class="number">0</span>;</span><br><span class="line">	UINT VertexBufferByteSize = <span class="number">0</span>;</span><br><span class="line">	DXGI_FORMAT IndexFormat = DXGI_FORMAT_R16_UINT;</span><br><span class="line">	UINT IndexBufferByteSize = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 一个结构体能够存储一组顶点/索引缓冲区中的多个几何体</span></span><br><span class="line">    <span class="comment">//用下列容器来定义子网格几何体，就能单独绘制其中的子网格</span></span><br><span class="line">	std::unordered_map&lt;std::string, SubmeshGeometry&gt; DrawArgs;</span><br><span class="line"></span><br><span class="line">	<span class="function">D3D12_VERTEX_BUFFER_VIEW <span class="title">VertexBufferView</span><span class="params">()</span><span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		D3D12_VERTEX_BUFFER_VIEW vbv;</span><br><span class="line">		vbv.BufferLocation = VertexBufferGPU-&gt;<span class="built_in">GetGPUVirtualAddress</span>();</span><br><span class="line">		vbv.StrideInBytes = VertexByteStride;</span><br><span class="line">		vbv.SizeInBytes = VertexBufferByteSize;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> vbv;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">D3D12_INDEX_BUFFER_VIEW <span class="title">IndexBufferView</span><span class="params">()</span><span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		D3D12_INDEX_BUFFER_VIEW ibv;</span><br><span class="line">		ibv.BufferLocation = IndexBufferGPU-&gt;<span class="built_in">GetGPUVirtualAddress</span>();</span><br><span class="line">		ibv.Format = IndexFormat;</span><br><span class="line">		ibv.SizeInBytes = IndexBufferByteSize;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> ibv;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 等数据上传GPU后，我们就能释放内存了</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">DisposeUploaders</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		VertexBufferUploader = <span class="literal">nullptr</span>;</span><br><span class="line">		IndexBufferUploader = <span class="literal">nullptr</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>





<h3 id="绘制Box"><a href="#绘制Box" class="headerlink" title="绘制Box"></a>绘制Box</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;../Common/d3dUtil.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;DXApp.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;../Common/UploadBuffer.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;../Common/MathHelper.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> DirectX;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> DirectX::PackedVector;</span><br><span class="line"><span class="keyword">using</span> Microsoft::WRL::ComPtr;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  _DEBUG 1</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Vertex</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	XMFLOAT3 Pos;</span><br><span class="line">	XMFLOAT4 Color;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ObjectConstants</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	XMFLOAT4X4 WorldViewProj=MathHelper::<span class="built_in">Identity4x4</span>();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyBox</span>:</span><span class="keyword">public</span> DXApp</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">MyBox</span>(HINSTANCE instance);</span><br><span class="line">	<span class="built_in">MyBox</span>(<span class="keyword">const</span> MyBox&amp; rhs)=<span class="keyword">delete</span>;</span><br><span class="line">	MyBox&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> MyBox&amp; rhs)=<span class="keyword">delete</span>;</span><br><span class="line">	~<span class="built_in">MyBox</span>();</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">Initialize</span><span class="params">()</span><span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnMouseDown</span><span class="params">(WPARAM btnState, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span><span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnMouseUp</span><span class="params">(WPARAM btnState, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span><span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnMouseMove</span><span class="params">(WPARAM btnState, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span><span class="keyword">override</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">BuildDescriptorHeaps</span><span class="params">()</span></span>;<span class="comment">//常量缓冲区描述符堆</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">BuildConstantBuffers</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">BuildRootSignature</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">BuildShadersAndInputLayout</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">BuildBoxGeometry</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">BuildPSO</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Update</span><span class="params">(<span class="keyword">const</span> GameTimer&amp; gt)</span><span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Draw</span><span class="params">(<span class="keyword">const</span> GameTimer&amp; gt)</span><span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnResize</span><span class="params">()</span><span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">	ComPtr&lt;ID3D12DescriptorHeap&gt; mCbvHeap = <span class="literal">nullptr</span>;</span><br><span class="line">	ComPtr&lt;ID3D12RootSignature&gt; mRootSignature = <span class="literal">nullptr</span>;</span><br><span class="line">	std::unique_ptr&lt;UploadBuffer&lt;ObjectConstants&gt;&gt; mObjectCB = <span class="literal">nullptr</span>;</span><br><span class="line">	<span class="comment">//封装的几何体结构体的指针</span></span><br><span class="line">	std::unique_ptr&lt;MeshGeometry&gt; mBoxGeo = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//编译材质参数</span></span><br><span class="line">	ComPtr&lt;ID3DBlob&gt; mvsByteCode = <span class="literal">nullptr</span>;</span><br><span class="line">	ComPtr&lt;ID3DBlob&gt; mpsByteCode = <span class="literal">nullptr</span>;</span><br><span class="line">	<span class="comment">//输入布局描述</span></span><br><span class="line">	std::vector&lt;D3D12_INPUT_ELEMENT_DESC&gt; mInputLayout;</span><br><span class="line">	</span><br><span class="line">	ComPtr&lt;ID3D12PipelineState&gt; mPSO = <span class="literal">nullptr</span>;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	XMFLOAT4X4 mWorld = MathHelper::<span class="built_in">Identity4x4</span>();</span><br><span class="line">	XMFLOAT4X4 mView = MathHelper::<span class="built_in">Identity4x4</span>();</span><br><span class="line">	XMFLOAT4X4 mProj = MathHelper::<span class="built_in">Identity4x4</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">float</span> mTheta = <span class="number">1.5f</span>*XM_PI;</span><br><span class="line">	<span class="keyword">float</span> mPhi = XM_PIDIV2;</span><br><span class="line">	<span class="keyword">float</span> mRadius = <span class="number">5.0f</span>;</span><br><span class="line">	POINT mLastMousePos;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">MyBox::<span class="built_in">MyBox</span>(HINSTANCE instance):<span class="built_in">DXApp</span>(instance)</span><br><span class="line">&#123;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">MyBox::~<span class="built_in">MyBox</span>()</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MyBox::Update</span><span class="params">(<span class="keyword">const</span> GameTimer&amp; gt)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 将球坐标（球面坐标）转换为笛卡尔坐标系</span></span><br><span class="line">	<span class="keyword">float</span> x = mRadius * <span class="built_in">sinf</span>(mPhi)*<span class="built_in">cosf</span>(mTheta);</span><br><span class="line">	<span class="keyword">float</span> z = mRadius * <span class="built_in">sinf</span>(mPhi)*<span class="built_in">sinf</span>(mTheta);</span><br><span class="line">	<span class="keyword">float</span> y = mRadius * <span class="built_in">cosf</span>(mPhi);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 构建观察矩阵</span></span><br><span class="line">	XMVECTOR pos = <span class="built_in">XMVectorSet</span>(x, y, z, <span class="number">1.0f</span>);</span><br><span class="line">	XMVECTOR target = <span class="built_in">XMVectorZero</span>();</span><br><span class="line">	XMVECTOR up = <span class="built_in">XMVectorSet</span>(<span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>);</span><br><span class="line"></span><br><span class="line">	XMMATRIX view = <span class="built_in">XMMatrixLookAtLH</span>(pos, target, up);</span><br><span class="line">	<span class="built_in">XMStoreFloat4x4</span>(&amp;mView, view);<span class="comment">//观察矩阵</span></span><br><span class="line"></span><br><span class="line">	XMMATRIX world = <span class="built_in">XMLoadFloat4x4</span>(&amp;mWorld);</span><br><span class="line">	XMMATRIX proj = <span class="built_in">XMLoadFloat4x4</span>(&amp;mProj);</span><br><span class="line">	XMMATRIX worldViewProj = world * view*proj;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 用最新的 worldViewProj 矩阵来更新常量缓冲区</span></span><br><span class="line">	ObjectConstants objConstants;</span><br><span class="line">	<span class="built_in">XMStoreFloat4x4</span>(&amp;objConstants.WorldViewProj, <span class="built_in">XMMatrixTranspose</span>(worldViewProj));</span><br><span class="line">	mObjectCB-&gt;<span class="built_in">CopyData</span>(<span class="number">0</span>, objConstants);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MyBox::Draw</span><span class="params">(<span class="keyword">const</span> GameTimer&amp; gt)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(mDirectCmdListAlloc-&gt;<span class="built_in">Reset</span>());</span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(mCommandList-&gt;<span class="built_in">Reset</span>(mDirectCmdListAlloc.<span class="built_in">Get</span>(), mPSO.<span class="built_in">Get</span>()));</span><br><span class="line"></span><br><span class="line">	mCommandList-&gt;<span class="built_in">RSSetViewports</span>(<span class="number">1</span>,&amp;mScreenViewport);</span><br><span class="line">	mCommandList-&gt;<span class="built_in">RSSetScissorRects</span>(<span class="number">1</span>,&amp;mScissorRect);</span><br><span class="line">	<span class="comment">//指示资源使用情况的状态转换。</span></span><br><span class="line">	mCommandList-&gt;<span class="built_in">ResourceBarrier</span>(<span class="number">1</span>,&amp;CD3DX12_RESOURCE_BARRIER::<span class="built_in">Transition</span>(<span class="built_in">CurrentBackBuffer</span>(),D3D12_RESOURCE_STATE_PRESENT,D3D12_RESOURCE_STATE_RENDER_TARGET));</span><br><span class="line">	<span class="comment">//清理后台缓冲区和深度缓冲区</span></span><br><span class="line">	mCommandList-&gt;<span class="built_in">ClearRenderTargetView</span>(<span class="built_in">CurrentBackBufferView</span>(),Colors::LightSteelBlue,<span class="number">0</span>,<span class="literal">nullptr</span>);</span><br><span class="line">	mCommandList-&gt;<span class="built_in">ClearDepthStencilView</span>(<span class="built_in">DepthStencilView</span>(),D3D12_CLEAR_FLAG_DEPTH | D3D12_CLEAR_FLAG_STENCIL,<span class="number">1.0f</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="literal">nullptr</span>);</span><br><span class="line">	<span class="comment">//指定要渲染的缓冲区</span></span><br><span class="line">	mCommandList-&gt;<span class="built_in">OMSetRenderTargets</span>(<span class="number">1</span> , &amp;<span class="built_in">CurrentBackBufferView</span>(),<span class="literal">true</span>, &amp;<span class="built_in">DepthStencilView</span>());</span><br><span class="line"></span><br><span class="line">	<span class="comment">//指定cbv描述符堆成员为一个</span></span><br><span class="line">	ID3D12DescriptorHeap* descriptorHeaps[]=&#123;mCbvHeap.<span class="built_in">Get</span>()&#125;;</span><br><span class="line">	mCommandList-&gt;<span class="built_in">SetDescriptorHeaps</span>(_countof(descriptorHeaps),descriptorHeaps);</span><br><span class="line">	<span class="comment">//设置根签名</span></span><br><span class="line">	mCommandList-&gt;<span class="built_in">SetGraphicsRootSignature</span>(mRootSignature.<span class="built_in">Get</span>());</span><br><span class="line"></span><br><span class="line">	<span class="comment">//顶点缓冲区视图和渲染流水线上的一个输入槽绑定</span></span><br><span class="line">	mCommandList-&gt;<span class="built_in">IASetVertexBuffers</span>(<span class="number">0</span>,<span class="number">1</span>,&amp;mBoxGeo-&gt;<span class="built_in">VertexBufferView</span>());</span><br><span class="line">	mCommandList-&gt;<span class="built_in">IASetIndexBuffer</span>(&amp;mBoxGeo-&gt;<span class="built_in">IndexBufferView</span>());</span><br><span class="line">	mCommandList-&gt;<span class="built_in">IASetPrimitiveTopology</span>(D3D11_PRIMITIVE_TOPOLOGY_TRIANGLELIST);<span class="comment">//这里是DX11版本，没有12版本</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//描述符表与渲染流水线绑定</span></span><br><span class="line">	mCommandList-&gt;<span class="built_in">SetGraphicsRootDescriptorTable</span>(<span class="number">0</span>,mCbvHeap-&gt;<span class="built_in">GetGPUDescriptorHandleForHeapStart</span>());</span><br><span class="line"></span><br><span class="line">	mCommandList-&gt;<span class="built_in">DrawIndexedInstanced</span>(mBoxGeo-&gt;DrawArgs[<span class="string">&quot;box&quot;</span>].IndexCount,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	mCommandList-&gt;<span class="built_in">ResourceBarrier</span>(<span class="number">1</span>,&amp;CD3DX12_RESOURCE_BARRIER::<span class="built_in">Transition</span>(<span class="built_in">CurrentBackBuffer</span>(), D3D12_RESOURCE_STATE_RENDER_TARGET, D3D12_RESOURCE_STATE_PRESENT));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(mCommandList-&gt;<span class="built_in">Close</span>());</span><br><span class="line"></span><br><span class="line">	<span class="comment">//提交命令列表，交换前后台缓冲区</span></span><br><span class="line">	ID3D12CommandList* cmdLists[]=&#123;mCommandList.<span class="built_in">Get</span>()&#125;;</span><br><span class="line">	mCommandQueue-&gt;<span class="built_in">ExecuteCommandLists</span>(_countof(cmdLists),cmdLists);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(mSwapChain-&gt;<span class="built_in">Present</span>(<span class="number">0</span>,<span class="number">0</span>));</span><br><span class="line">	mCurrBackBuffer=(mCurrBackBuffer+<span class="number">1</span>)%SwapChainBufferCount;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">FlushCommandQueue</span>();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MyBox::OnResize</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DXApp::<span class="built_in">OnResize</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// The window resized, so update the aspect ratio and recompute the projection matrix.</span></span><br><span class="line">	XMMATRIX P = <span class="built_in">XMMatrixPerspectiveFovLH</span>(<span class="number">0.25f</span>*MathHelper::Pi, <span class="built_in">AspectRatio</span>(), <span class="number">1.0f</span>, <span class="number">1000.0f</span>);</span><br><span class="line">	<span class="built_in">XMStoreFloat4x4</span>(&amp;mProj, P);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MyBox::OnMouseDown</span><span class="params">(WPARAM btnState, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	mLastMousePos.x = x;</span><br><span class="line">	mLastMousePos.y = y;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">SetCapture</span>(mhMainWnd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MyBox::OnMouseUp</span><span class="params">(WPARAM btnState, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">ReleaseCapture</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MyBox::OnMouseMove</span><span class="params">(WPARAM btnState, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> ((btnState &amp; MK_LBUTTON) != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//  根据鼠标的移动距离计算旋转角度，令每个像素按此角度的1/4旋转</span></span><br><span class="line">		<span class="keyword">float</span> dx = <span class="built_in">XMConvertToRadians</span>(<span class="number">0.25f</span>*<span class="keyword">static_cast</span>&lt;<span class="keyword">float</span>&gt;(x - mLastMousePos.x));</span><br><span class="line">		<span class="keyword">float</span> dy = <span class="built_in">XMConvertToRadians</span>(<span class="number">0.25f</span>*<span class="keyword">static_cast</span>&lt;<span class="keyword">float</span>&gt;(y - mLastMousePos.y));</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 根据鼠标输入来更新摄像机绕立方体旋转的角度</span></span><br><span class="line">		mTheta -= dx;</span><br><span class="line">		mPhi -= dy;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//限制角度mPhi的范围</span></span><br><span class="line">		mPhi = MathHelper::<span class="built_in">Clamp</span>(mPhi, <span class="number">0.1f</span>, MathHelper::Pi - <span class="number">0.1f</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> ((btnState &amp; MK_RBUTTON) != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// 使场景中的每个像素按鼠标移动距离的0.005倍进行缩放</span></span><br><span class="line">		<span class="keyword">float</span> dx = <span class="number">0.005f</span>*<span class="keyword">static_cast</span>&lt;<span class="keyword">float</span>&gt;(x - mLastMousePos.x);</span><br><span class="line">		<span class="keyword">float</span> dy = <span class="number">0.005f</span>*<span class="keyword">static_cast</span>&lt;<span class="keyword">float</span>&gt;(y - mLastMousePos.y);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 根据鼠标的输入更新摄像机的可视范围半径</span></span><br><span class="line">		mRadius += dx - dy;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 限制可视半径范围</span></span><br><span class="line">		mRadius = MathHelper::<span class="built_in">Clamp</span>(mRadius, <span class="number">3.0f</span>, <span class="number">15.0f</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	mLastMousePos.x = x;</span><br><span class="line">	mLastMousePos.y = y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MyBox::BuildDescriptorHeaps</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	D3D12_DESCRIPTOR_HEAP_DESC cbvHeapDesc;</span><br><span class="line">	cbvHeapDesc.Flags=D3D12_DESCRIPTOR_HEAP_FLAG_SHADER_VISIBLE;<span class="comment">//创建着色器程序访问的描述符时需要指定visible</span></span><br><span class="line">	cbvHeapDesc.NodeMask=<span class="number">0</span>;</span><br><span class="line">	cbvHeapDesc.NumDescriptors=<span class="number">1</span>;</span><br><span class="line">	cbvHeapDesc.Type=D3D12_DESCRIPTOR_HEAP_TYPE_CBV_SRV_UAV;</span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateDescriptorHeap</span>(&amp;cbvHeapDesc,<span class="built_in">IID_PPV_ARGS</span>(&amp;mCbvHeap)));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MyBox::BuildConstantBuffers</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">	<span class="comment">//此常量缓冲区存储了绘制n个物体所需的常量数据</span></span><br><span class="line">	mObjectCB=std::make_unique&lt;UploadBuffer&lt;ObjectConstants&gt;&gt;(md3dDevice.<span class="built_in">Get</span>(),<span class="number">1</span>,<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">	UINT objCBByteSize=d3dUtil::<span class="built_in">CalcConstantBufferByteSize</span>(<span class="built_in"><span class="keyword">sizeof</span></span>(ObjectConstants));</span><br><span class="line">	<span class="comment">//缓冲区的起始地址	</span></span><br><span class="line">	D3D12_GPU_VIRTUAL_ADDRESS cbAddress=mObjectCB-&gt;<span class="built_in">Resource</span>()-&gt;<span class="built_in">GetGPUVirtualAddress</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> boxCBufIndex=<span class="number">0</span>;</span><br><span class="line">	cbAddress += boxCBufIndex*objCBByteSize;</span><br><span class="line"></span><br><span class="line">	D3D12_CONSTANT_BUFFER_VIEW_DESC cbvDesc;</span><br><span class="line">	cbvDesc.BufferLocation = cbAddress;</span><br><span class="line">	cbvDesc.SizeInBytes = d3dUtil::<span class="built_in">CalcConstantBufferByteSize</span>(<span class="built_in"><span class="keyword">sizeof</span></span>(ObjectConstants));</span><br><span class="line"></span><br><span class="line">	md3dDevice-&gt;<span class="built_in">CreateConstantBufferView</span>(&amp;cbvDesc,mCbvHeap-&gt;<span class="built_in">GetCPUDescriptorHandleForHeapStart</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MyBox::BuildRootSignature</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CD3DX12_ROOT_PARAMETER slotRootParameter[<span class="number">1</span>];<span class="comment">//根签名表</span></span><br><span class="line"></span><br><span class="line">	CD3DX12_DESCRIPTOR_RANGE cbvTable;</span><br><span class="line">	<span class="comment">//1：表中的描述符数量，0：将此段描述符区域绑定至此基准着色器寄存器</span></span><br><span class="line">	cbvTable.<span class="built_in">Init</span>(D3D12_DESCRIPTOR_RANGE_TYPE_CBV,<span class="number">1</span>,<span class="number">0</span>);</span><br><span class="line">	<span class="comment">//1：描述符区域的数量；table:指向描述符区域数组的指针</span></span><br><span class="line">	slotRootParameter[<span class="number">0</span>].<span class="built_in">InitAsDescriptorTable</span>(<span class="number">1</span>,&amp;cbvTable);</span><br><span class="line">	<span class="comment">// 根签名由一组根参数构成</span></span><br><span class="line">	<span class="function">CD3DX12_ROOT_SIGNATURE_DESC <span class="title">rootSigDesc</span><span class="params">(<span class="number">1</span>,slotRootParameter,<span class="number">0</span>,<span class="literal">nullptr</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">	D3D12_ROOT_SIGNATURE_FLAG_ALLOW_INPUT_ASSEMBLER_INPUT_LAYOUT)</span></span>;</span><br><span class="line"></span><br><span class="line">	ComPtr&lt;ID3DBlob&gt; serializedRootSig = <span class="literal">nullptr</span>;</span><br><span class="line">	ComPtr&lt;ID3DBlob&gt; errorBlob=<span class="literal">nullptr</span>;</span><br><span class="line">	HRESULT hr=<span class="built_in">D3D12SerializeRootSignature</span>(&amp;rootSigDesc,D3D_ROOT_SIGNATURE_VERSION_1,</span><br><span class="line">	serializedRootSig.<span class="built_in">GetAddressOf</span>(),errorBlob.<span class="built_in">GetAddressOf</span>());</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (errorBlob!=<span class="literal">nullptr</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		::<span class="built_in">OutputDebugStringA</span>((<span class="keyword">char</span>*)errorBlob-&gt;<span class="built_in">GetBufferPointer</span>());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(hr);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateRootSignature</span>(</span><br><span class="line">	<span class="number">0</span>,serializedRootSig-&gt;<span class="built_in">GetBufferPointer</span>(),</span><br><span class="line">	serializedRootSig-&gt;<span class="built_in">GetBufferSize</span>(),</span><br><span class="line">	<span class="built_in">IID_PPV_ARGS</span>(&amp;mRootSignature)</span><br><span class="line">	));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MyBox::BuildShadersAndInputLayout</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HRESULT hr = S_OK;</span><br><span class="line">	mvsByteCode = d3dUtil::<span class="built_in">CompileShader</span>(<span class="string">L&quot;Shaders\\color.hlsl&quot;</span>, <span class="literal">nullptr</span>, <span class="string">&quot;VS&quot;</span>, <span class="string">&quot;vs_5_0&quot;</span>);</span><br><span class="line">	mpsByteCode = d3dUtil::<span class="built_in">CompileShader</span>(<span class="string">L&quot;Shaders\\color.hlsl&quot;</span>, <span class="literal">nullptr</span>, <span class="string">&quot;PS&quot;</span>, <span class="string">&quot;ps_5_0&quot;</span>);</span><br><span class="line"></span><br><span class="line">	mInputLayout=</span><br><span class="line">	&#123;</span><br><span class="line">		&#123;<span class="string">&quot;POSITION&quot;</span>, <span class="number">0</span>, DXGI_FORMAT_R32G32B32_FLOAT, <span class="number">0</span>, <span class="number">0</span>, D3D12_INPUT_CLASSIFICATION_PER_VERTEX_DATA, <span class="number">0</span> &#125;,</span><br><span class="line">		&#123;<span class="string">&quot;COLOR&quot;</span>, <span class="number">0</span>, DXGI_FORMAT_R32G32B32A32_FLOAT, <span class="number">0</span>, <span class="number">12</span>, D3D12_INPUT_CLASSIFICATION_PER_VERTEX_DATA, <span class="number">0</span>&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MyBox::BuildBoxGeometry</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	std::array&lt;Vertex,8&gt; verteices=</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">Vertex</span>(&#123; <span class="built_in">XMFLOAT3</span>(<span class="number">-1.0f</span>, <span class="number">-1.0f</span>, <span class="number">-1.0f</span>), <span class="built_in">XMFLOAT4</span>(Colors::Red) &#125;),</span><br><span class="line">		<span class="built_in">Vertex</span>(&#123; <span class="built_in">XMFLOAT3</span>(<span class="number">-1.0f</span>, +<span class="number">1.0f</span>, <span class="number">-1.0f</span>), <span class="built_in">XMFLOAT4</span>(Colors::Green) &#125;),</span><br><span class="line">		<span class="built_in">Vertex</span>(&#123; <span class="built_in">XMFLOAT3</span>(+<span class="number">1.0f</span>, +<span class="number">1.0f</span>, <span class="number">-1.0f</span>), <span class="built_in">XMFLOAT4</span>(Colors::Blue) &#125;),</span><br><span class="line">		<span class="built_in">Vertex</span>(&#123; <span class="built_in">XMFLOAT3</span>(+<span class="number">1.0f</span>, <span class="number">-1.0f</span>, <span class="number">-1.0f</span>), <span class="built_in">XMFLOAT4</span>(Colors::White) &#125;),</span><br><span class="line">		<span class="built_in">Vertex</span>(&#123; <span class="built_in">XMFLOAT3</span>(<span class="number">-1.0f</span>, <span class="number">-1.0f</span>, +<span class="number">1.0f</span>), <span class="built_in">XMFLOAT4</span>(Colors::Blue) &#125;),</span><br><span class="line">		<span class="built_in">Vertex</span>(&#123; <span class="built_in">XMFLOAT3</span>(<span class="number">-1.0f</span>, +<span class="number">1.0f</span>, +<span class="number">1.0f</span>), <span class="built_in">XMFLOAT4</span>(Colors::White) &#125;),</span><br><span class="line">		<span class="built_in">Vertex</span>(&#123; <span class="built_in">XMFLOAT3</span>(+<span class="number">1.0f</span>, +<span class="number">1.0f</span>, +<span class="number">1.0f</span>), <span class="built_in">XMFLOAT4</span>(Colors::Red) &#125;),</span><br><span class="line">		<span class="built_in">Vertex</span>(&#123; <span class="built_in">XMFLOAT3</span>(+<span class="number">1.0f</span>, <span class="number">-1.0f</span>, +<span class="number">1.0f</span>), <span class="built_in">XMFLOAT4</span>(Colors::Green) &#125;)</span><br><span class="line">	&#125;;</span><br><span class="line">	std::array&lt;std::<span class="keyword">uint16_t</span>, 36&gt; indices = </span><br><span class="line"></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// front face</span></span><br><span class="line">			<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>,</span><br><span class="line">			<span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>,</span><br><span class="line"></span><br><span class="line">			<span class="comment">// back face</span></span><br><span class="line">			<span class="number">4</span>, <span class="number">6</span>, <span class="number">5</span>,</span><br><span class="line">			<span class="number">4</span>, <span class="number">7</span>, <span class="number">6</span>,</span><br><span class="line"></span><br><span class="line">			<span class="comment">// left face</span></span><br><span class="line">			<span class="number">4</span>, <span class="number">5</span>, <span class="number">1</span>,</span><br><span class="line">			<span class="number">4</span>, <span class="number">1</span>, <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">			<span class="comment">// right face</span></span><br><span class="line">			<span class="number">3</span>, <span class="number">2</span>, <span class="number">6</span>,</span><br><span class="line">			<span class="number">3</span>, <span class="number">6</span>, <span class="number">7</span>,</span><br><span class="line"></span><br><span class="line">			<span class="comment">// top face</span></span><br><span class="line">			<span class="number">1</span>, <span class="number">5</span>, <span class="number">6</span>,</span><br><span class="line">			<span class="number">1</span>, <span class="number">6</span>, <span class="number">2</span>,</span><br><span class="line"></span><br><span class="line">			<span class="comment">// bottom face</span></span><br><span class="line">			<span class="number">4</span>, <span class="number">0</span>, <span class="number">3</span>,</span><br><span class="line">			<span class="number">4</span>, <span class="number">3</span>, <span class="number">7</span></span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> UINT vbByteSize = (UINT)verteices.<span class="built_in">size</span>() * <span class="built_in"><span class="keyword">sizeof</span></span>(Vertex);</span><br><span class="line">	<span class="keyword">const</span> UINT ibByteSize = (UINT)indices.<span class="built_in">size</span>() * <span class="built_in"><span class="keyword">sizeof</span></span>(std::<span class="keyword">uint16_t</span>);</span><br><span class="line"></span><br><span class="line">	mBoxGeo=std::make_unique&lt;MeshGeometry&gt;();</span><br><span class="line">	mBoxGeo-&gt;Name = <span class="string">&quot;boxGeo&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(<span class="built_in">D3DCreateBlob</span>(vbByteSize,&amp;mBoxGeo-&gt;VertexBufferCPU));</span><br><span class="line">	<span class="built_in">CopyMemory</span>(mBoxGeo-&gt;VertexBufferCPU-&gt;<span class="built_in">GetBufferPointer</span>(),verteices.<span class="built_in">data</span>(),vbByteSize);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(<span class="built_in">D3DCreateBlob</span>(ibByteSize, &amp;mBoxGeo-&gt;IndexBufferCPU));</span><br><span class="line">	<span class="built_in">CopyMemory</span>(mBoxGeo-&gt;IndexBufferCPU-&gt;<span class="built_in">GetBufferPointer</span>(), indices.<span class="built_in">data</span>(), ibByteSize);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//创建顶点/索引默认缓冲区</span></span><br><span class="line">	mBoxGeo-&gt;VertexBufferGPU = d3dUtil::<span class="built_in">CreateDefaultBuffer</span>(</span><br><span class="line">	md3dDevice.<span class="built_in">Get</span>(),mCommandList.<span class="built_in">Get</span>(),verteices.<span class="built_in">data</span>(),vbByteSize,mBoxGeo-&gt;VertexBufferUploader);</span><br><span class="line">	mBoxGeo-&gt;IndexBufferGPU= d3dUtil::<span class="built_in">CreateDefaultBuffer</span>(</span><br><span class="line">	md3dDevice.<span class="built_in">Get</span>(),mCommandList.<span class="built_in">Get</span>(),indices.<span class="built_in">data</span>(),ibByteSize,mBoxGeo-&gt;IndexBufferUploader);</span><br><span class="line">	<span class="comment">//缓冲区数据</span></span><br><span class="line">	<span class="comment">//字节跨度</span></span><br><span class="line">	mBoxGeo-&gt;VertexByteStride=<span class="built_in"><span class="keyword">sizeof</span></span>(Vertex);</span><br><span class="line">	mBoxGeo-&gt;VertexBufferByteSize=vbByteSize;</span><br><span class="line">	mBoxGeo-&gt;IndexFormat=DXGI_FORMAT_R16_UINT;</span><br><span class="line">	mBoxGeo-&gt;IndexBufferByteSize=ibByteSize;</span><br><span class="line"></span><br><span class="line">	SubmeshGeometry subMesh;</span><br><span class="line">	subMesh.IndexCount=(UINT) indices.<span class="built_in">size</span>();</span><br><span class="line">	subMesh.StartIndexLocation=<span class="number">0</span>;</span><br><span class="line">	subMesh.BaseVertexLocation=<span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 一个结构体能够存储一组顶点/索引缓冲区中的多个几何体</span></span><br><span class="line">	<span class="comment">//用下列容器来定义子网格几何体，就能单独绘制其中的子网格</span></span><br><span class="line">	mBoxGeo-&gt;DrawArgs[<span class="string">&quot;box&quot;</span>]=subMesh;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MyBox::BuildPSO</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//流水线状态描述</span></span><br><span class="line">	D3D12_GRAPHICS_PIPELINE_STATE_DESC psoDesc;</span><br><span class="line">	<span class="comment">//将数据的缓冲区用0来填充,使用一块内存区域前对其进行清空处理可以避免内存数据的不确定性。</span></span><br><span class="line">	<span class="built_in">ZeroMemory</span>(&amp;psoDesc,<span class="built_in"><span class="keyword">sizeof</span></span>(D3D12_GRAPHICS_PIPELINE_STATE_DESC));</span><br><span class="line">	psoDesc.InputLayout=&#123;mInputLayout.<span class="built_in">data</span>(),(UINT)mInputLayout.<span class="built_in">size</span>()&#125;;</span><br><span class="line">	psoDesc.pRootSignature=mRootSignature.<span class="built_in">Get</span>();</span><br><span class="line">	psoDesc.VS=</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">reinterpret_cast</span>&lt;BYTE*&gt;(mvsByteCode-&gt;<span class="built_in">GetBufferPointer</span>()),</span><br><span class="line">		mvsByteCode-&gt;<span class="built_in">GetBufferSize</span>()</span><br><span class="line">	&#125;;</span><br><span class="line">	psoDesc.PS=</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">reinterpret_cast</span>&lt;BYTE*&gt;(mpsByteCode-&gt;<span class="built_in">GetBufferPointer</span>()),</span><br><span class="line">		mpsByteCode-&gt;<span class="built_in">GetBufferSize</span>()</span><br><span class="line">	&#125;;</span><br><span class="line">	psoDesc.RasterizerState = <span class="built_in">CD3DX12_RASTERIZER_DESC</span>(D3D12_DEFAULT);	<span class="comment">//光栅化状态</span></span><br><span class="line">	psoDesc.BlendState= <span class="built_in">CD3DX12_BLEND_DESC</span>(D3D12_DEFAULT);</span><br><span class="line">	psoDesc.DepthStencilState = <span class="built_in">CD3DX12_DEPTH_STENCIL_DESC</span>(D3D12_DEFAULT);</span><br><span class="line">	psoDesc.SampleMask=UINT_MAX;</span><br><span class="line">	psoDesc.PrimitiveTopologyType=D3D12_PRIMITIVE_TOPOLOGY_TYPE_TRIANGLE;</span><br><span class="line">	psoDesc.NumRenderTargets=<span class="number">1</span>;</span><br><span class="line">	psoDesc.RTVFormats[<span class="number">0</span>]=mBackBufferFormat;</span><br><span class="line">	psoDesc.SampleDesc.Count= m4xMsaaState?<span class="number">4</span>:<span class="number">1</span>;</span><br><span class="line">	psoDesc.SampleDesc.Quality=m4xMsaaState?(m4xMsaaState<span class="number">-1</span>):<span class="number">0</span>;</span><br><span class="line">	psoDesc.DSVFormat=mDepthStencilFormat;</span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateGraphicsPipelineState</span>(&amp;psoDesc,<span class="built_in">IID_PPV_ARGS</span>(&amp;mPSO)));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">MyBox::Initialize</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!DXApp::<span class="built_in">Initialize</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//准备初始化命令之前线重置命令列表</span></span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(mCommandList-&gt;<span class="built_in">Reset</span>(mDirectCmdListAlloc.<span class="built_in">Get</span>(),<span class="literal">nullptr</span>));</span><br><span class="line"></span><br><span class="line">	<span class="built_in">BuildDescriptorHeaps</span>();</span><br><span class="line">	<span class="built_in">BuildConstantBuffers</span>();</span><br><span class="line">	<span class="built_in">BuildRootSignature</span>();</span><br><span class="line">	<span class="built_in">BuildShadersAndInputLayout</span>();</span><br><span class="line">	<span class="built_in">BuildBoxGeometry</span>();</span><br><span class="line">	<span class="built_in">BuildPSO</span>();</span><br><span class="line"></span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(mCommandList-&gt;<span class="built_in">Close</span>());</span><br><span class="line">	ID3D12CommandList* cmdLists[]=&#123;mCommandList.<span class="built_in">Get</span>()&#125;;</span><br><span class="line">	mCommandQueue-&gt;<span class="built_in">ExecuteCommandLists</span>(_countof(cmdLists),cmdLists);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">FlushCommandQueue</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> WINAPI <span class="title">WinMain</span><span class="params">(_In_ HINSTANCE hInstance, _In_opt_ HINSTANCE hPrevInstance, _In_ LPSTR lpCmdLine, _In_ <span class="keyword">int</span> nShowCmd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Enable run-time memory check for debug builds.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(DEBUG) | defined(_DEBUG)</span></span><br><span class="line">	_CrtSetDbgFlag(_CRTDBG_ALLOC_MEM_DF | _CRTDBG_LEAK_CHECK_DF);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">try</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="function">MyBox <span class="title">theApp</span><span class="params">(hInstance)</span></span>;</span><br><span class="line">		<span class="keyword">if</span> (!theApp.<span class="built_in">Initialize</span>())</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> theApp.<span class="built_in">Run</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in"><span class="keyword">catch</span></span> (DxException&amp; e)</span><br><span class="line">	&#123;</span><br><span class="line">	</span><br><span class="line">		<span class="built_in">MessageBox</span>(<span class="literal">nullptr</span>, e.<span class="built_in">ToString</span>().<span class="built_in">c_str</span>(), <span class="string">L&quot;HR Failed&quot;</span>, MB_OK);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>








      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://supervj.top/2020/06/24/LearnDX12_RenderPipline/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://img.supervj.top/imgHEAD_Icon.png">
      <meta itemprop="name" content="VJ东">
      <meta itemprop="description" content=" 如果我们不曾相遇 ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="月光林地">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/06/24/LearnDX12_RenderPipline/" class="post-title-link" itemprop="url">DX学习笔记（三）：渲染流水线</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-06-24 00:00:00" itemprop="dateCreated datePublished" datetime="2020-06-24T00:00:00+08:00">2020-06-24</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-08-02 16:40:37" itemprop="dateModified" datetime="2021-08-02T16:40:37+08:00">2021-08-02</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/graphics/" itemprop="url" rel="index"><span itemprop="name">graphics</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    
      <a title="changyan" href="/2020/06/24/LearnDX12_RenderPipline/#SOHUCS" itemprop="discussionUrl">
        <span id="url::http://supervj.top/2020/06/24/LearnDX12_RenderPipline/" class="cy_cmt_count" data-xid="2020/06/24/LearnDX12_RenderPipline/" itemprop="commentCount"></span>
      </a>
    
  </span>
  
  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>12k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>11 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="渲染流水线"><a href="#渲染流水线" class="headerlink" title="渲染流水线"></a>渲染流水线</h2><p>平行线最终会相交于<code>消失点</code>，又称为<code>灭点</code></p>
<p><code>物体重叠</code>：即不同命的物体能够遮挡住其后侧物体的局部</p>
<p>3D实体对象是通过<code>三角形网格</code>来近似表示的</p>
<h3 id="颜色"><a href="#颜色" class="headerlink" title="颜色"></a>颜色</h3><p>分量式乘法:<code>(r,g,b)*(a,b,c)=(ra,gb,bc)</code></p>
<h5 id="128位颜色"><a href="#128位颜色" class="headerlink" title="128位颜色"></a>128位颜色</h5><p>每个分量用浮点表示，即4D向量 (r,g,b,a)</p>
<p><em><strong>0&lt;=r,g,b,a&lt;=1</strong></em></p>
<p><code>DirectXMath</code>库对分量式乘法的支持</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">XMVECTOR XM_CAKKCIBV <span class="title">XMColorModulate</span> <span class="params">(FXMVECTOR C1,FXMVECTOR C2)</span></span>;<span class="comment">//返回C1*C2</span></span><br></pre></td></tr></table></figure>

<h5 id="32位颜色"><a href="#32位颜色" class="headerlink" title="32位颜色"></a>32位颜色</h5><p>每个分量仅分配1个字节，因此每个占用8字节的颜色分量就分别描述256种不同的颜色强度</p>
<p>即0代表无强度，256代表最大强度</p>
<p><code>DirectXMath</code>库<code>(include&lt;DirectXPackedVector.h&gt;)</code>在<code>DirectX::PackedVector</code>命名空间提供了相应函数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> DirectX</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> PackedVector</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">XMCOLOR</span></span></span><br><span class="line"><span class="class">        &#123;</span></span><br><span class="line">            <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">            &#123;</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">                &#123;</span></span><br><span class="line">                    <span class="keyword">uint8_t</span> b;  <span class="comment">// Blue:    0/255 to 255/255</span></span><br><span class="line">            		<span class="keyword">uint8_t</span> g;  <span class="comment">// Green:   0/255 to 255/255</span></span><br><span class="line">            		<span class="keyword">uint8_t</span> r;  <span class="comment">// Red:     0/255 to 255/255</span></span><br><span class="line">            		<span class="keyword">uint8_t</span> a;  <span class="comment">// Alpha:   0/255 to 255/255</span></span><br><span class="line">                    </span><br><span class="line">                &#125;;<span class="keyword">uint32_t</span> c;</span><br><span class="line">                <span class="built_in">XMCOLOR</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">    			<span class="built_in">XMCOLOR</span>(<span class="keyword">const</span> XMCOLOR&amp;) = <span class="keyword">default</span>;</span><br><span class="line">                XMCOLOR&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> XMCOLOR&amp;) = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">XMCOLOR</span>(XMCOLOR&amp;&amp;) = <span class="keyword">default</span>;</span><br><span class="line">                XMCOLOR&amp; <span class="keyword">operator</span>=(XMCOLOR&amp;&amp;) = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">                <span class="function">XM_CONSTEXPR <span class="title">XMCOLOR</span><span class="params">(<span class="keyword">uint32_t</span> Color)</span> : c(Color) &#123;</span>&#125;</span><br><span class="line">                <span class="built_in">XMCOLOR</span>(<span class="keyword">float</span> _r, <span class="keyword">float</span> _g, <span class="keyword">float</span> _b, <span class="keyword">float</span> _a);</span><br><span class="line">                <span class="function"><span class="keyword">explicit</span> <span class="title">XMCOLOR</span><span class="params">(_In_reads_(<span class="number">4</span>) <span class="keyword">const</span> <span class="keyword">float</span> *pArray)</span></span>;</span><br><span class="line"></span><br><span class="line">                <span class="function"><span class="keyword">operator</span> <span class="title">uint32_t</span> <span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> c; &#125;</span><br><span class="line"></span><br><span class="line">                XMCOLOR&amp; <span class="keyword">operator</span>= (<span class="keyword">const</span> <span class="keyword">uint32_t</span> Color) &#123; c = Color; <span class="keyword">return</span> *<span class="keyword">this</span>; &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过将<code>[0,255]</code>映射到<code>[0,1]</code>即可完成32位到128位的转换</p>
<p>转换函数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">XMVECTOR XM_CALLCONV <span class="title">XMLoadColor</span><span class="params">( <span class="keyword">const</span> XMCOLOR* pSource)</span></span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> XM_CALLCONV <span class="title">XMStoreColor</span><span class="params">( XMCOLOR* pDestination, FXMVECTOR V )</span></span>;</span><br></pre></td></tr></table></figure>



<h3 id="渲染流水线概述"><a href="#渲染流水线概述" class="headerlink" title="渲染流水线概述"></a>渲染流水线概述</h3><p>渲染流水线(rendering pipeline)是以摄像机位观察视角而生成的2D图像的一系列完整步骤</p>
<p>​     </p>
<p><img src="https://img.supervj.top/xuanran.png"></p>
<h3 id="输入装配阶段"><a href="#输入装配阶段" class="headerlink" title="输入装配阶段"></a>输入装配阶段</h3><p>输入装配阶段：从显存中读取集合数据(顶点和索引，vertex and index)</p>
<p>再装配为几何图元（几何基元），如三角形和线条</p>
<ul>
<li>顶点缓冲区：将顶点与渲染流水线绑定的特殊结构体</li>
</ul>
<h5 id="图元拓扑-primitive-topology"><a href="#图元拓扑-primitive-topology" class="headerlink" title="图元拓扑(primitive topology)"></a>图元拓扑(primitive topology)</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> STDMETHODCALLTYPE <span class="title">IASetPrimitiveTopology</span><span class="params">( </span></span></span><br><span class="line"><span class="params"><span class="function">            _In_  D3D12_PRIMITIVE_TOPOLOGY PrimitiveTopology)</span> </span>= <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> </span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">D3D_PRIMITIVE_TOPOLOGY</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_UNDEFINED	= <span class="number">0</span>,</span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_POINTLIST	= <span class="number">1</span>,</span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_LINELIST	= <span class="number">2</span>,</span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_LINESTRIP	= <span class="number">3</span>,</span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_TRIANGLELIST	= <span class="number">4</span>,</span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_TRIANGLESTRIP	= <span class="number">5</span>,</span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_LINELIST_ADJ	= <span class="number">10</span>,</span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_LINESTRIP_ADJ	= <span class="number">11</span>,</span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_TRIANGLELIST_ADJ	= <span class="number">12</span>,</span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_TRIANGLESTRIP_ADJ	= <span class="number">13</span>,</span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_1_CONTROL_POINT_PATCHLIST	= <span class="number">33</span>,</span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_2_CONTROL_POINT_PATCHLIST	= <span class="number">34</span>,</span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_3_CONTROL_POINT_PATCHLIST	= <span class="number">35</span>,</span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_4_CONTROL_POINT_PATCHLIST	= <span class="number">36</span>,</span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_5_CONTROL_POINT_PATCHLIST	= <span class="number">37</span>,</span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_6_CONTROL_POINT_PATCHLIST	= <span class="number">38</span>,</span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_7_CONTROL_POINT_PATCHLIST	= <span class="number">39</span>,</span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_8_CONTROL_POINT_PATCHLIST	= <span class="number">40</span>,</span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_9_CONTROL_POINT_PATCHLIST	= <span class="number">41</span>,</span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_10_CONTROL_POINT_PATCHLIST	= <span class="number">42</span>,</span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_11_CONTROL_POINT_PATCHLIST	= <span class="number">43</span>,</span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_12_CONTROL_POINT_PATCHLIST	= <span class="number">44</span>,</span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_13_CONTROL_POINT_PATCHLIST	= <span class="number">45</span>,</span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_14_CONTROL_POINT_PATCHLIST	= <span class="number">46</span>,</span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_15_CONTROL_POINT_PATCHLIST	= <span class="number">47</span>,</span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_16_CONTROL_POINT_PATCHLIST	= <span class="number">48</span>,</span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_17_CONTROL_POINT_PATCHLIST	= <span class="number">49</span>,</span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_18_CONTROL_POINT_PATCHLIST	= <span class="number">50</span>,</span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_19_CONTROL_POINT_PATCHLIST	= <span class="number">51</span>,</span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_20_CONTROL_POINT_PATCHLIST	= <span class="number">52</span>,</span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_21_CONTROL_POINT_PATCHLIST	= <span class="number">53</span>,</span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_22_CONTROL_POINT_PATCHLIST	= <span class="number">54</span>,</span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_23_CONTROL_POINT_PATCHLIST	= <span class="number">55</span>,</span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_24_CONTROL_POINT_PATCHLIST	= <span class="number">56</span>,</span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_25_CONTROL_POINT_PATCHLIST	= <span class="number">57</span>,</span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_26_CONTROL_POINT_PATCHLIST	= <span class="number">58</span>,</span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_27_CONTROL_POINT_PATCHLIST	= <span class="number">59</span>,</span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_28_CONTROL_POINT_PATCHLIST	= <span class="number">60</span>,</span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_29_CONTROL_POINT_PATCHLIST	= <span class="number">61</span>,</span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_30_CONTROL_POINT_PATCHLIST	= <span class="number">62</span>,</span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_31_CONTROL_POINT_PATCHLIST	= <span class="number">63</span>,</span><br><span class="line">        D3D_PRIMITIVE_TOPOLOGY_32_CONTROL_POINT_PATCHLIST	= <span class="number">64</span>,</span><br><span class="line">        D3D10_PRIMITIVE_TOPOLOGY_UNDEFINED	= D3D_PRIMITIVE_TOPOLOGY_UNDEFINED,</span><br><span class="line">        D3D10_PRIMITIVE_TOPOLOGY_POINTLIST	= D3D_PRIMITIVE_TOPOLOGY_POINTLIST,</span><br><span class="line">        D3D10_PRIMITIVE_TOPOLOGY_LINELIST	= D3D_PRIMITIVE_TOPOLOGY_LINELIST,</span><br><span class="line">        D3D10_PRIMITIVE_TOPOLOGY_LINESTRIP	= D3D_PRIMITIVE_TOPOLOGY_LINESTRIP,</span><br><span class="line">        D3D10_PRIMITIVE_TOPOLOGY_TRIANGLELIST	= D3D_PRIMITIVE_TOPOLOGY_TRIANGLELIST,</span><br><span class="line">        D3D10_PRIMITIVE_TOPOLOGY_TRIANGLESTRIP	= D3D_PRIMITIVE_TOPOLOGY_TRIANGLESTRIP,</span><br><span class="line">        D3D10_PRIMITIVE_TOPOLOGY_LINELIST_ADJ	= D3D_PRIMITIVE_TOPOLOGY_LINELIST_ADJ,</span><br><span class="line">        D3D10_PRIMITIVE_TOPOLOGY_LINESTRIP_ADJ	= D3D_PRIMITIVE_TOPOLOGY_LINESTRIP_ADJ,</span><br><span class="line">        D3D10_PRIMITIVE_TOPOLOGY_TRIANGLELIST_ADJ	= D3D_PRIMITIVE_TOPOLOGY_TRIANGLELIST_ADJ,</span><br><span class="line">        D3D10_PRIMITIVE_TOPOLOGY_TRIANGLESTRIP_ADJ	= D3D_PRIMITIVE_TOPOLOGY_TRIANGLESTRIP_ADJ,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_UNDEFINED	= D3D_PRIMITIVE_TOPOLOGY_UNDEFINED,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_POINTLIST	= D3D_PRIMITIVE_TOPOLOGY_POINTLIST,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_LINELIST	= D3D_PRIMITIVE_TOPOLOGY_LINELIST,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_LINESTRIP	= D3D_PRIMITIVE_TOPOLOGY_LINESTRIP,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_TRIANGLELIST	= D3D_PRIMITIVE_TOPOLOGY_TRIANGLELIST,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_TRIANGLESTRIP	= D3D_PRIMITIVE_TOPOLOGY_TRIANGLESTRIP,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_LINELIST_ADJ	= D3D_PRIMITIVE_TOPOLOGY_LINELIST_ADJ,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_LINESTRIP_ADJ	= D3D_PRIMITIVE_TOPOLOGY_LINESTRIP_ADJ,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_TRIANGLELIST_ADJ	= D3D_PRIMITIVE_TOPOLOGY_TRIANGLELIST_ADJ,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_TRIANGLESTRIP_ADJ	= D3D_PRIMITIVE_TOPOLOGY_TRIANGLESTRIP_ADJ,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_1_CONTROL_POINT_PATCHLIST	= D3D_PRIMITIVE_TOPOLOGY_1_CONTROL_POINT_PATCHLIST,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_2_CONTROL_POINT_PATCHLIST	= D3D_PRIMITIVE_TOPOLOGY_2_CONTROL_POINT_PATCHLIST,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_3_CONTROL_POINT_PATCHLIST	= D3D_PRIMITIVE_TOPOLOGY_3_CONTROL_POINT_PATCHLIST,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_4_CONTROL_POINT_PATCHLIST	= D3D_PRIMITIVE_TOPOLOGY_4_CONTROL_POINT_PATCHLIST,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_5_CONTROL_POINT_PATCHLIST	= D3D_PRIMITIVE_TOPOLOGY_5_CONTROL_POINT_PATCHLIST,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_6_CONTROL_POINT_PATCHLIST	= D3D_PRIMITIVE_TOPOLOGY_6_CONTROL_POINT_PATCHLIST,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_7_CONTROL_POINT_PATCHLIST	= D3D_PRIMITIVE_TOPOLOGY_7_CONTROL_POINT_PATCHLIST,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_8_CONTROL_POINT_PATCHLIST	= D3D_PRIMITIVE_TOPOLOGY_8_CONTROL_POINT_PATCHLIST,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_9_CONTROL_POINT_PATCHLIST	= D3D_PRIMITIVE_TOPOLOGY_9_CONTROL_POINT_PATCHLIST,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_10_CONTROL_POINT_PATCHLIST	= D3D_PRIMITIVE_TOPOLOGY_10_CONTROL_POINT_PATCHLIST,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_11_CONTROL_POINT_PATCHLIST	= D3D_PRIMITIVE_TOPOLOGY_11_CONTROL_POINT_PATCHLIST,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_12_CONTROL_POINT_PATCHLIST	= D3D_PRIMITIVE_TOPOLOGY_12_CONTROL_POINT_PATCHLIST,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_13_CONTROL_POINT_PATCHLIST	= D3D_PRIMITIVE_TOPOLOGY_13_CONTROL_POINT_PATCHLIST,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_14_CONTROL_POINT_PATCHLIST	= D3D_PRIMITIVE_TOPOLOGY_14_CONTROL_POINT_PATCHLIST,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_15_CONTROL_POINT_PATCHLIST	= D3D_PRIMITIVE_TOPOLOGY_15_CONTROL_POINT_PATCHLIST,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_16_CONTROL_POINT_PATCHLIST	= D3D_PRIMITIVE_TOPOLOGY_16_CONTROL_POINT_PATCHLIST,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_17_CONTROL_POINT_PATCHLIST	= D3D_PRIMITIVE_TOPOLOGY_17_CONTROL_POINT_PATCHLIST,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_18_CONTROL_POINT_PATCHLIST	= D3D_PRIMITIVE_TOPOLOGY_18_CONTROL_POINT_PATCHLIST,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_19_CONTROL_POINT_PATCHLIST	= D3D_PRIMITIVE_TOPOLOGY_19_CONTROL_POINT_PATCHLIST,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_20_CONTROL_POINT_PATCHLIST	= D3D_PRIMITIVE_TOPOLOGY_20_CONTROL_POINT_PATCHLIST,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_21_CONTROL_POINT_PATCHLIST	= D3D_PRIMITIVE_TOPOLOGY_21_CONTROL_POINT_PATCHLIST,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_22_CONTROL_POINT_PATCHLIST	= D3D_PRIMITIVE_TOPOLOGY_22_CONTROL_POINT_PATCHLIST,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_23_CONTROL_POINT_PATCHLIST	= D3D_PRIMITIVE_TOPOLOGY_23_CONTROL_POINT_PATCHLIST,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_24_CONTROL_POINT_PATCHLIST	= D3D_PRIMITIVE_TOPOLOGY_24_CONTROL_POINT_PATCHLIST,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_25_CONTROL_POINT_PATCHLIST	= D3D_PRIMITIVE_TOPOLOGY_25_CONTROL_POINT_PATCHLIST,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_26_CONTROL_POINT_PATCHLIST	= D3D_PRIMITIVE_TOPOLOGY_26_CONTROL_POINT_PATCHLIST,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_27_CONTROL_POINT_PATCHLIST	= D3D_PRIMITIVE_TOPOLOGY_27_CONTROL_POINT_PATCHLIST,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_28_CONTROL_POINT_PATCHLIST	= D3D_PRIMITIVE_TOPOLOGY_28_CONTROL_POINT_PATCHLIST,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_29_CONTROL_POINT_PATCHLIST	= D3D_PRIMITIVE_TOPOLOGY_29_CONTROL_POINT_PATCHLIST,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_30_CONTROL_POINT_PATCHLIST	= D3D_PRIMITIVE_TOPOLOGY_30_CONTROL_POINT_PATCHLIST,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_31_CONTROL_POINT_PATCHLIST	= D3D_PRIMITIVE_TOPOLOGY_31_CONTROL_POINT_PATCHLIST,</span><br><span class="line">        D3D11_PRIMITIVE_TOPOLOGY_32_CONTROL_POINT_PATCHLIST	= D3D_PRIMITIVE_TOPOLOGY_32_CONTROL_POINT_PATCHLIST</span><br><span class="line">    &#125; 	D3D_PRIMITIVE_TOPOLOGY;</span><br></pre></td></tr></table></figure>

<p>示例</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//通过线列表来绘制对象</span></span><br><span class="line">mCommandList-&gt;<span class="built_in">IASetPrimitiveTopology</span>(D3D_PRIMITIVE_TOPOLOGY_LINELIST);</span><br><span class="line"><span class="comment">//通过三角形列表来绘制对象</span></span><br><span class="line">mCommandList-&gt;<span class="built_in">IASetPrimitiveTopology</span>(D3D_PRIMITIVE_TOPOLOGY_TRIANGLELIST);</span><br><span class="line"><span class="comment">//通过三角形带来绘制对象</span></span><br><span class="line">mCommandList-&gt;<span class="built_in">IASetPrimitiveTopology</span>(D3D_PRIMITIVE_TOPOLOGY_TRIANGLESTRIP);</span><br></pre></td></tr></table></figure>

<ul>
<li>点列表 <code>D3D_PRIMITIVE_TOPOLOGY_POINTLIST</code></li>
<li>线条带 <code>D3D_PRIMITIVE_TOPOLOGY_LINESTRIP</code></li>
<li>线列表 <code>D3D_PRIMITIVE_TOPOLOGY_LINELIST</code></li>
<li>三角形带 <code>D3D_PRIMITIVE_TOPOLOGY_TRIANGLESTRIP</code></li>
</ul>
<p><img src="https://img.supervj.top/img/tuyuantuopu_1.jpg"></p>
<ul>
<li>剔除(culling)问题：奇数与偶数三角形的绕序(环绕顺序)即装配图元的顶点顺序是不同的</li>
</ul>
<p>CPU会对偶数三角形的<code>前两个顶点</code>顺序进行调换已达到有奇数三角形绕序相同</p>
<blockquote>
<p>正确的应该是后<strong>两个顶点</strong>顺序调换，而OpenGL中才是前两个顶点调换</p>
</blockquote>
<ul>
<li>三角形列表</li>
</ul>
<p><code>D3D_PRIMITIVE_TOPOLOGY_TRIANGLELIST</code></p>
<p>三角形列表与三角形带的区别是，三角形列表的三角形可以彼此分离，所以每n*3个顶点组成n个三角形</p>
<ul>
<li>具有邻接数据的图元拓扑</li>
</ul>
<p>对于有邻接数据的三角形列表，每个三角形都有3个与之相邻的<code>邻接三角形</code></p>
<p>借助<code>顶点缓冲区</code>和<code>索引缓冲区</code>将它们随主三角形一并提交至渲染流水线</p>
<p>并且要把拓扑类型指定为<code>D3D12_PRIMITIVE_TOPOLOGY_TRIANGLELIST_ADJ</code>让渲染流水线知道如何以顶点缓冲区的顶点来构建主三角形和其邻接三角形；</p>
<p>邻接图元的顶点只作为集合着色器的输入数据，并不会被绘制</p>
<p><img src="https://img.supervj.top/img/DX/tuyuantuopu_2.jpg"></p>
<h5 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Vertex quad[<span class="number">6</span>]=&#123;</span><br><span class="line">    v0,v1,v2,<span class="comment">//三角形0</span></span><br><span class="line">    v0,v2,v3 <span class="comment">//三角形1</span></span><br><span class="line">&#125;；</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>绕序</strong>：为三角形指定顶点顺序</li>
</ul>
<p>用<code>顶点列表</code>和<code>索引列表</code>组合起来构成三角形</p>
<p>如</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Vertex v[<span class="number">9</span>]=&#123;v0,v1,v2,v3,v4,v5,v6,v7,v8&#125;;</span><br><span class="line">UINT indexList[<span class="number">24</span>]=&#123;</span><br><span class="line">    <span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,</span><br><span class="line">    <span class="number">0</span>,<span class="number">2</span>,<span class="number">3</span>,</span><br><span class="line">    <span class="number">0</span>,<span class="number">3</span>,<span class="number">4</span>,</span><br><span class="line">    <span class="number">0</span>,<span class="number">4</span>,<span class="number">5</span>,</span><br><span class="line">    <span class="number">0</span>,<span class="number">5</span>,<span class="number">6</span>,</span><br><span class="line">    <span class="number">0</span>,<span class="number">6</span>,<span class="number">7</span>,</span><br><span class="line">    <span class="number">0</span>,<span class="number">7</span>,<span class="number">8</span>,</span><br><span class="line">    <span class="number">0</span>,<span class="number">8</span>,<span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="顶点着色阶段"><a href="#顶点着色阶段" class="headerlink" title="顶点着色阶段"></a>顶点着色阶段</h3><ul>
<li>世界变换：将局部坐标系内的坐标转换到世界坐标系</li>
<li>世界矩阵：上述变换的矩阵</li>
</ul>
<p>$$<br>W=SRT<br>$$</p>
<ul>
<li>观察空间:相机的局部坐标系，亦称视觉空间、摄像机空间等</li>
<li>取景变换：世界空间至观察空间的变换；此变换的矩阵叫做<code>观察矩阵</code></li>
</ul>
<p>观察矩阵函数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> XMMATRIX XM_CALLCONV <span class="title">XMMatrixLookAtLH</span></span></span><br><span class="line"><span class="function"><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    FXMVECTOR EyePosition, </span></span></span><br><span class="line"><span class="params"><span class="function">    FXMVECTOR FocusPosition, </span></span></span><br><span class="line"><span class="params"><span class="function">    FXMVECTOR UpDirection</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure>

<p>示例</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">XMVECTOR eyePos=<span class="built_in">XMVectorSet</span>(<span class="number">100</span>,<span class="number">100</span>,<span class="number">100</span>,<span class="number">1</span>);</span><br><span class="line">XMVECTOR target=<span class="built_in">XMVectorZero</span>();</span><br><span class="line">XMVECTOR up=<span class="built_in">XMVectorSet</span>(<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">XMMATRIX V=<span class="built_in">XMMatrixLookAtLH</span>(eyePos,target,up);<span class="comment">//返回观察矩阵</span></span><br><span class="line">XMVECTOR v2=<span class="built_in">XMVector3TransformCoord</span>(target,V);</span><br><span class="line">cout&lt;&lt;v2;<span class="comment">//输出得到(0,0,173.2),即在观察空间的坐标</span></span><br></pre></td></tr></table></figure>

<ul>
<li>顶点的投影线：顶点到观察点的连线</li>
<li>透视投影变换：3D顶点<strong>v</strong>变换至其投影线与3D投影平面的交点<strong>v<sup>、</sup></strong></li>
</ul>
<blockquote>
<p>近平面(近裁剪面)<code>n</code>,远平面<code>f</code>，垂直视场角<code>α</code>，纵横比<code>r</code>，4个参数定义了以原点作为投影的中心，以<code>Z</code>轴进行观察的平截头体</p>
</blockquote>
<p>纵横比<br>$$<br>r=w/h<br>$$<br>w:投影窗口的宽度</p>
<p>h:投影窗口的高度</p>
<blockquote>
<p>如果后台缓冲区与投影窗口纵横比不一致，在映射的过程中会产生非均匀缩放（不等比例缩放），导致图像拉伸</p>
</blockquote>
<ul>
<li><p>NDC：规格化设备坐标(Normalized Device Coordinates)</p>
</li>
<li><p>透视除法（齐次除法）：顶点与投影矩阵相乘以后，对每个坐标除以<code>w=z</code></p>
</li>
<li><p>归一化深度值：通过函数 <code>g(z)</code>把<code>z</code>坐标从<code>[n,f]</code>映射到区间<code>[0,1]</code></p>
</li>
</ul>
<p>$$<br>g(z)=A+ {B \over z}<br>$$</p>
<ul>
<li>透视投影矩阵</li>
</ul>
<p>$$<br>P=\begin{bmatrix}1\over rtan({\alpha \over 2}) &amp; 0 &amp; 0 &amp; 0\<br>0 &amp; 1\over{tan({\alpha\over 2})} &amp; 0 &amp; 0 \<br>0 &amp; 0 &amp; f\over {f-n} &amp; 1 \<br>0 &amp; &amp; 0 &amp; -nf\over{f-n} &amp; 0<br>\end{bmatrix}<br>$$</p>
<blockquote>
<p>在顶点乘以投影矩阵后，集合体会处于所谓的<code>齐次裁剪空间</code>或者<code>投影空间</code></p>
<p>完成<strong>透视除法</strong>以后，便是**规格化设备坐标(NDC)**了</p>
</blockquote>
<ul>
<li>XMMatrixPerspectiveFovLH</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> XMMATRIX XM_CALLCONV <span class="title">XMMatrixPerspectiveFovLH</span></span></span><br><span class="line"><span class="function"><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">float</span> FovAngleY, <span class="comment">//用弧度值表示的垂直视场角</span></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">float</span> AspectRatio, <span class="comment">//纵横比：宽度/高度</span></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">float</span> NearZ, <span class="comment">//近平面距离</span></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">float</span> FarZ<span class="comment">//到远平面距离</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure>

<p>示例</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">XMMATRIX M2=<span class="built_in">XMMatrixPerspectiveFovLH</span>(<span class="number">0.25f</span>*XM_PI,<span class="number">1092</span>/<span class="number">1080</span>,<span class="number">1.0</span>,<span class="number">1000</span>);</span><br><span class="line">	cout&lt;&lt;M2;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>2.41421 0       0       0<br>0       2.41421 0       0<br>0       0       1.001   1<br>0       0       -1.001  0</p>
</blockquote>
<h3 id="曲面细分阶段"><a href="#曲面细分阶段" class="headerlink" title="曲面细分阶段"></a>曲面细分阶段</h3><p>利用镶嵌化处理技术对网格中的三角形进行细分，以此来增加物体表面上的三角形数量。</p>
<p>再将这些新增的三角形偏移到适当的位置，使网格表现出更加细腻的细节</p>
<ul>
<li>曲面细分的优点</li>
</ul>
<ol>
<li>实现LOD</li>
<li>在内存中只维护<strong>低模</strong>，在有需求时动态增添三角形，从而节省资源</li>
<li>处理动画和物理时使用低模，渲染时使用处理过的高模</li>
</ol>
<h3 id="几何着色器阶段"><a href="#几何着色器阶段" class="headerlink" title="几何着色器阶段"></a>几何着色器阶段</h3><p>几何着色器阶段接受输入是完整的图元</p>
<p>与顶点着色器相比，几何着色器可以创建或者修改几何体</p>
<p>比如，将一个点或者一条线扩展为一个四边形</p>
<h3 id="裁剪"><a href="#裁剪" class="headerlink" title="裁剪"></a>裁剪</h3><p>对视锥体之外的物体进行裁剪</p>
<blockquote>
<p>苏泽兰-霍奇曼裁剪算法</p>
</blockquote>
<h3 id="光栅化阶段"><a href="#光栅化阶段" class="headerlink" title="光栅化阶段"></a>光栅化阶段</h3><p>光栅化阶段(RS,栅格化)：投影主屏幕上的3D三角形计算出对应的像素颜色</p>
<ul>
<li>视口变换：裁剪完成后，硬件通过透视除法将物体从齐次空间变换为规格化设备坐标（NDC）。此后顶点<code>x、y</code>坐标会以像素单位表示</li>
<li>背面剔除：将背面朝向的三角形从渲染流水线中除去</li>
<li>透视矫正插值：为得到2D空间的顶点的插值属性，对3D空间的三角形属性进行线性插值，即利用三角形属性计算出内部像素的属性</li>
<li>像素着色器阶段(pixel shader)：针对每个像素片段进行处理，根据顶点的差值属性作为输入来计算像素颜色，亦可实现如逐像素光照(per-pixel lighting)、反射以及阴影等复杂效果</li>
<li>输入合并阶段：上述阶段生成的像素片段送至渲染流水线的输出合并阶段(OM)。丢弃部分像素(如未通过深度测试等)，剩下的写入后台缓冲区，执行混合(blend)操作（透明效果也混合实现的）</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://supervj.top/2020/06/23/Mardown%E6%95%B0%E5%AD%A6%E5%85%AC%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://img.supervj.top/imgHEAD_Icon.png">
      <meta itemprop="name" content="VJ东">
      <meta itemprop="description" content=" 如果我们不曾相遇 ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="月光林地">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/06/23/Mardown%E6%95%B0%E5%AD%A6%E5%85%AC%E5%BC%8F/" class="post-title-link" itemprop="url">Markdown(Typora)数学公式</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-06-23 00:00:00" itemprop="dateCreated datePublished" datetime="2020-06-23T00:00:00+08:00">2020-06-23</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-08-02 16:17:45" itemprop="dateModified" datetime="2021-08-02T16:17:45+08:00">2021-08-02</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/math/" itemprop="url" rel="index"><span itemprop="name">math</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    
      <a title="changyan" href="/2020/06/23/Mardown%E6%95%B0%E5%AD%A6%E5%85%AC%E5%BC%8F/#SOHUCS" itemprop="discussionUrl">
        <span id="url::http://supervj.top/2020/06/23/Mardown%E6%95%B0%E5%AD%A6%E5%85%AC%E5%BC%8F/" class="cy_cmt_count" data-xid="2020/06/23/Mardown数学公式/" itemprop="commentCount"></span>
      </a>
    
  </span>
  
  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4.4k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>4 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>Ctrl+Shift+M激活公式</p>
</blockquote>
<h3 id="上下标"><a href="#上下标" class="headerlink" title="上下标"></a>上下标</h3><p><code>a^2+\ b_&#123;y_3&#125;</code></p>
<p>$$<br>a^2+\ b_{y_3}<br>$$</p>
<h3 id="括号"><a href="#括号" class="headerlink" title="括号"></a>括号</h3><ul>
<li>中小括号</li>
</ul>
<p><code>(a+b)*[c+2]</code><br>$$<br>(a+b)*[c+2]<br>$$</p>
<ul>
<li>大括号需要加<code>\</code></li>
</ul>
<p><code>\&#123;1,2,3 \&#125;</code><br>$$<br>{1,2,3 }<br>$$</p>
<ul>
<li>尖括号</li>
</ul>
<p><code>\langle x \rangle</code><br>$$<br>\langle x \rangle<br>$$</p>
<ul>
<li>上下取整</li>
</ul>
<p><code>\lceil x \rceil+\lfloor y\rfloor</code><br>$$<br>\lceil x \rceil+\lfloor y\rfloor<br>$$</p>
<ul>
<li>特殊括号</li>
</ul>
<p><code>\begin&#123;pmatrix&#125; 1\ 2\\ 3\ 4 \end&#123;pmatrix&#125;\\ \begin&#123;bmatrix&#125; 1\ 2\\ 3\ 4 \end&#123;bmatrix&#125;\\ \begin&#123;Bmatrix&#125; 1\ 2\\ 3\ 4 \end&#123;Bmatrix&#125;\\ \begin&#123;vmatrix&#125; 1&amp; 2\\ 3&amp; 4 \end&#123;vmatrix&#125;\\ \begin&#123;Vmatrix&#125; 1&amp; 2\\ 3&amp; 4 \end&#123;Vmatrix&#125;\\</code><br>$$<br>\begin{pmatrix} 1\ 2\ 3\ 4 \end{pmatrix}\<br>\begin{bmatrix} 1\ 2\ 3\ 4 \end{bmatrix}\<br>\begin{Bmatrix} 1\ 2\ 3\ 4 \end{Bmatrix}\<br>\begin{vmatrix} 1&amp; 2\ 3&amp; 4 \end{vmatrix}\<br>\begin{Vmatrix} 1 &amp; 2\ 3 &amp; 4 \end{Vmatrix}\<br>$$</p>
<h3 id="希腊字母"><a href="#希腊字母" class="headerlink" title="希腊字母"></a>希腊字母</h3><p><code>1.\alpha\ A\\ 2.\beta\ B\\ 3.\gamma\ \Gamma\\ 4.\delta\ \Delta\\ 5.\epsilon\ E\\ 6.\zeta\ Z\\ 7.\eta\ H\\ 8.\theta\ \Theta\\ 9.\iota\ I\\ 10.\kappa\ K\\ 11.\lambda\ \Lambda\\ 12.\mu\ M\\ 13.\nu\ N\\ 14.\xi\ \Xi\\ 15.\omicron\ O\\ 16.\pi\ \Pi\\ 17.\rho\ P\\ 18.\sigma\ \Sigma\\ 19.\tau\ T\\ 20.\upsilon\ \Upsilon\\ 21.\phi\ \Phi\\ 22.\chi\ X\\ 23.\psi\ \Psi\\ 24.\omega\ \Omega\\</code><br>$$<br>1.\alpha\ A\<br>2.\beta\ B\<br>3.\gamma\ \Gamma\<br>4.\delta\ \Delta\<br>5.\epsilon\ E\<br>6.\zeta\ Z\<br>7.\eta\ H\<br>8.\theta\ \Theta\<br>9.\iota\ I\<br>10.\kappa\ K\<br>11.\lambda\ \Lambda\<br>12.\mu\ M\<br>13.\nu\ N\<br>14.\xi\ \Xi\<br>15.\omicron\ O\<br>16.\pi\ \Pi\<br>17.\rho\ P\<br>18.\sigma\ \Sigma\<br>19.\tau\ T\<br>20.\upsilon\ \Upsilon\<br>21.\phi\ \Phi\<br>22.\chi\ X\<br>23.\psi\ \Psi\<br>24.\omega\ \Omega\<br>$$</p>
<h3 id="根式分式"><a href="#根式分式" class="headerlink" title="根式分式"></a>根式分式</h3><p><code>\sqrt[x+y]&#123;\frac ab&#125;+\sqrt&#123;c+2\over 50+x&#125;</code><br>$$<br>\sqrt[x+y]{\frac ab}+\sqrt{c+2\over 50+x}<br>$$</p>
<h3 id="字体"><a href="#字体" class="headerlink" title="字体"></a>字体</h3><p><code>ABCabc+\ \mathbb&#123; ABCabc&#125;+\ \Bbb&#123; ABCabc黑板粗体&#125;\\ ABCabc+\mathbf&#123;ABCabc黑体&#125;\\ ABCabc+\mathtt&#123;ABCabc打印字体&#125; \\ ABCabc+\mathrm&#123;ABCabc罗马字体&#125; \\ ABCabc+\mathscr&#123;ABCabc手写字体&#125; \\ ABCabc+\mathfrak&#123;ABCabc德国字体Fraktur&#125; </code><br>$$<br>ABCabc+\ \mathbb{ ABCabc}+\ \Bbb{ ABCabc黑板粗体}\<br>ABCabc+\mathbf{ABCabc黑体}\<br>ABCabc+\mathtt{ABCabc打印字体} \<br>ABCabc+\mathrm{ABCabc罗马字体} \<br>ABCabc+\mathscr{ABCabc手写字体} \<br>ABCabc+\mathfrak{ABCabc德国字体Fraktur}<br>$$</p>
<h3 id="表格"><a href="#表格" class="headerlink" title="表格"></a>表格</h3><p><code>\begin&#123;array&#125;&#123;c|lcr&#125; n &amp; \text&#123;Left&#125; &amp; \text&#123;Center&#125; &amp; \text&#123;Right&#125; \\ \hline 1 &amp; 0.24 &amp; 1 &amp; 125 \\ 2 &amp; -1 &amp; 189 &amp; -8 \\ 3 &amp; -20 &amp; 2000 &amp; 1+10i \\ \end&#123;array&#125;</code><br>$$<br>\begin{array}{c|lcr} n &amp; \text{Left} &amp; \text{Center} &amp; \text{Right} \ \hline 1 &amp; 0.24 &amp; 1 &amp; 125 \ 2 &amp; -1 &amp; 189 &amp; -8 \ 3 &amp; -20 &amp; 2000 &amp; 1+10i \ \end{array}<br>$$</p>
<h3 id="矩阵"><a href="#矩阵" class="headerlink" title="矩阵"></a>矩阵</h3><p><code>\begin&#123;matrix&#125; 1 &amp; x &amp; x^2 \\ 1 &amp; y &amp; y^2 \\ 1 &amp; z &amp; z^2 \end&#123;matrix&#125;</code><br>$$<br>\begin{matrix} 1 &amp; x &amp; x^2 \ 1 &amp; y &amp; y^2 \ 1 &amp; z &amp; z^2 \end{matrix}<br>$$</p>
<h3 id="向量等顶部符号"><a href="#向量等顶部符号" class="headerlink" title="向量等顶部符号"></a>向量等顶部符号</h3><p><code>\vec&#123;abc&#125; \ ,\overline b\ ,\overrightarrow&#123;cde&#125; \ ,\dot c\ , \dot &#123;adb&#125;\ ,\ddot&#123;acd&#125;\ ,\dddot&#123;adfe&#125;</code><br>$$<br>\vec{abc} \ ,\overline b\ ,\overrightarrow{cde} \ ,\dot c\ , \dot {adb}\ ,\ddot{acd}\ ,\dddot{adfe}<br>$$</p>
<h3 id="对其"><a href="#对其" class="headerlink" title="对其"></a>对其</h3><p>需要使用&amp;来指示需要对齐的位置</p>
<p><code>\begin&#123;align&#125; \sqrt&#123;37&#125; &amp; = \sqrt&#123;\frac&#123;73^2-1&#125;&#123;12^2&#125;&#125; \\ &amp; = \sqrt&#123;\frac&#123;73^2&#125;&#123;12^2&#125; \cdot \frac&#123;73^2-1&#125;&#123;73^2&#125;&#125; \\ &amp; = \frac&#123;73&#125;&#123;12&#125; \sqrt&#123;1 - \frac&#123;1&#125;&#123;73^2&#125;&#125; \\ &amp; \approx \frac&#123;73&#125;&#123;12&#125; \left( 1 - \frac&#123;1&#125;&#123;2 \cdot 73^2&#125; \right) \end&#123;align&#125;</code><br>$$<br>\begin{align} \sqrt{37} &amp; = \sqrt{\frac{73^2-1}{12^2}} \ &amp; = \sqrt{\frac{73^2}{12^2} \cdot \frac{73^2-1}{73^2}} \ &amp; = \frac{73}{12} \sqrt{1 - \frac{1}{73^2}} \ &amp; \approx \frac{73}{12} \left( 1 - \frac{1}{2 \cdot 73^2} \right) \end{align}<br>$$</p>
<h3 id="分类表达式"><a href="#分类表达式" class="headerlink" title="分类表达式"></a>分类表达式</h3><p><code>f(n) = \begin&#123;cases&#125; n/2, &amp; \text&#123;if $n$ is even&#125; \\ 3n+1, &amp; \text&#123;if $n$ is odd&#125; \end&#123;cases&#125;</code><br>$$<br>f(n) = \begin{cases} n/2, &amp; \text{if $n$ is even} \ 3n+1, &amp; \text{if $n$ is odd} \end{cases}<br>$$<br><code>\left. \begin&#123;array&#125;&#123;l&#125; \text&#123;if $n$ is even:&#125; &amp; n/2 \\ \text&#123;if $n$ is odd:&#125; &amp; 3n+1 \end&#123;array&#125; \right\&#125; = f(n)</code><br>$$<br>\left. \begin{array}{l} \text{if $n$ is even:} &amp; n/2 \ \text{if $n$ is odd:} &amp; 3n+1 \end{array} \right} = f(n)<br>$$</p>
<h3 id="公式标记与引用"><a href="#公式标记与引用" class="headerlink" title="公式标记与引用"></a>公式标记与引用</h3><p><code>a:= x^2-y^3 \tag&#123;公式1&#125;\label&#123;公式1&#125;</code><br>$$<br>a:= x^2-y^3 \tag{公式1}\label{公式1}<br>$$<br><code>a+y^3 \stackrel&#123;\eqref&#123;公式1&#125;&#125;=x^2</code></p>
<p>$$<br>a+y^3 \stackrel{\eqref{公式1}}=x^2<br>$$</p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p><code>\to \rightarrow \leftarrow \Rightarrow \Leftarrow \mapsto</code><br>$$<br>\to \rightarrow \leftarrow \Rightarrow \Leftarrow \mapsto<br>$$<br><code>\lt \gt \le \ge \neq</code><br>$$<br>\lt \gt \le \ge \neq<br>$$</p>
<p><code>\sin x\\ \arctan_y\\ \lim_&#123;1\to\infty&#125;\\</code><br>$$<br>\sin x\<br>\arctan_y\<br>\lim_{1\to\infty}\<br>$$<br><code>\sum_1^n\ ,\int_1^&#123;x+y&#125;\ </code><br>$$<br>\sum_1^n\ ,\int_1^{x+y}<br>$$</p>
<h3 id="合集图片"><a href="#合集图片" class="headerlink" title="合集图片"></a>合集图片</h3><p><img src="https://img.supervj.top/img/DX/20190703164359871.png" alt="20190703164359871"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://supervj.top/2020/06/23/LearnDX12_Math/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://img.supervj.top/imgHEAD_Icon.png">
      <meta itemprop="name" content="VJ东">
      <meta itemprop="description" content=" 如果我们不曾相遇 ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="月光林地">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/06/23/LearnDX12_Math/" class="post-title-link" itemprop="url">DX学习笔记（一）：数学基础</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-06-23 00:00:00" itemprop="dateCreated datePublished" datetime="2020-06-23T00:00:00+08:00">2020-06-23</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-08-02 16:40:19" itemprop="dateModified" datetime="2021-08-02T16:40:19+08:00">2021-08-02</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/graphics/" itemprop="url" rel="index"><span itemprop="name">graphics</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    
      <a title="changyan" href="/2020/06/23/LearnDX12_Math/#SOHUCS" itemprop="discussionUrl">
        <span id="url::http://supervj.top/2020/06/23/LearnDX12_Math/" class="cy_cmt_count" data-xid="2020/06/23/LearnDX12_Math/" itemprop="commentCount"></span>
      </a>
    
  </span>
  
  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>10k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>9 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="向量代数"><a href="#向量代数" class="headerlink" title="向量代数"></a>向量代数</h2><h3 id="向量"><a href="#向量" class="headerlink" title="向量"></a>向量</h3><p>DirectX3D采用的左手坐标系</p>
<ul>
<li>左手坐标系：伸出左手，手指方向对准X轴正方向，弯曲手指对象Y轴正方向，大拇指指的就是Z轴正方向</li>
</ul>
<h5 id="向量的基本运算"><a href="#向量的基本运算" class="headerlink" title="向量的基本运算"></a>向量的基本运算</h5><ul>
<li><p>两个向量相等。即u=v。当且仅当u和v的每个分量相等，即u<sub>x</sub>=v<sub>x</sub>,u<sub>y</sub>=v<sub>y</sub>, u<sub>z</sub>=v<sub>z</sub></p>
</li>
<li><p>向量的加法即两个向量对应分量都相加</p>
</li>
<li><p>向量与标量相乘即每一个分量与标量相乘</p>
</li>
<li><p>向量减法与加法类似</p>
</li>
</ul>
<p>向量加法的几何意义u+v，即u的尾部与v的头部重合</p>
<h5 id="向量的长度和单位向量"><a href="#向量的长度和单位向量" class="headerlink" title="向量的长度和单位向量"></a>向量的长度和单位向量</h5><ul>
<li>3D向量的模可以用2次毕达哥拉斯定理（勾股定理）计算得到</li>
</ul>
<blockquote>
<p><img src="https://img.supervj.top/img/DX/image-20200118213350051.png" alt="image-20200118213350051"></p>
</blockquote>
<ul>
<li>一个向量的长度变为单位长度称为向量的<strong>规范化（normalizing）</strong>,具体实现方法是</li>
</ul>
<blockquote>
<p><img src="https://img.supervj.top/img/DX/image-20200118213401165.png" alt="image-20200118213401165"></p>
</blockquote>
<h3 id="点积"><a href="#点积" class="headerlink" title="点积"></a>点积</h3><ul>
<li>点积（dot product）是一种计算结果为标量值的向量乘法</li>
</ul>
<blockquote>
<p><img src="https://img.supervj.top/img/DX/image-20200118213420038.png" alt="image-20200118213420038"></p>
</blockquote>
<ul>
<li>如果u·v=0，那么u和v正交（垂直）</li>
<li>如果u·v&gt;0,那么夹角为锐角，即小于90°</li>
<li>如果&gt;0,那么夹角为钝角</li>
</ul>
<h5 id="正交投影"><a href="#正交投影" class="headerlink" title="正交投影"></a>正交投影</h5><blockquote>
<p><img src="https://img.supervj.top/img/DX/image-20200118213446595.png" alt="image-20200118213446595"></p>
</blockquote>
<p>即向量p是v在n向量上的投影</p>
<p>一般的投影公式如下</p>
<blockquote>
<p><img src="https://img.supervj.top/img/DX/image-20200118213508242.png" alt="image-20200118213508242"></p>
</blockquote>
<h3 id="正交化"><a href="#正交化" class="headerlink" title="正交化"></a>正交化</h3><p>如果向量集里面所有向量都相互正交，那么此向量集是<strong>规范正交</strong></p>
<h5 id="格拉姆-施密特正交化"><a href="#格拉姆-施密特正交化" class="headerlink" title="格拉姆-施密特正交化"></a><strong>格拉姆-施密特正交化</strong></h5><blockquote>
<p><img src="https://img.supervj.top/img/DX/image-20200118213545042.png" alt="image-20200118213545042"></p>
</blockquote>
<p>从文字上描述即，将向量v添加到规范正交集中时，需要用<strong>v减去这个规范正交集中的所有其他向量{w1,w2…}方向上的分量投影</strong>，这样确保新加入的v与该集合中的其他放量相互正交</p>
<ul>
<li>假设有向量集{v0,v1}，将其规范正交至集{w0,w1}</li>
</ul>
<p>则需要进行如下操作</p>
<blockquote>
<p><img src="https://img.supervj.top/img/DX/image-20200118213557536.png" alt="image-20200118213557536"></p>
</blockquote>
<ul>
<li>如果是三维向量集{v0,v1,v2}，至规范正交集{w0,w1,w2}</li>
</ul>
<p>则进行如下操作</p>
<blockquote>
<p><img src="https://img.supervj.top/img/DX/image-20200118213605437.png" alt="image-20200118213605437"></p>
<p><img src="https://img.supervj.top/img/DX/image-20200118213614501.png" alt="image-20200118213614501"></p>
</blockquote>
<h3 id="叉积"><a href="#叉积" class="headerlink" title="叉积"></a>叉积</h3><p>叉积公式</p>
<blockquote>
<p><img src="https://img.supervj.top/img/DX/image-20200118213635523.png" alt="image-20200118213635523"></p>
</blockquote>
<p>两个向量叉积的意义即得到正交于两个向量的向量，采用的左手坐标系，即手指指向一个向量，通过向内弯曲小于等于180°的角度后到达另外一个向量，则大拇指方向是叉积所得向量的方向</p>
<h5 id="用叉积类规范正交化"><a href="#用叉积类规范正交化" class="headerlink" title="用叉积类规范正交化"></a>用叉积类规范正交化</h5><blockquote>
<p><img src="https://img.supervj.top/img/DX/image-20200118213701332.png" alt="image-20200118213701332"></p>
</blockquote>
<h3 id="点"><a href="#点" class="headerlink" title="点"></a>点</h3><p>点（x,y,z）即从原点至该点的向量</p>
<h3 id="用DirectXMath库"><a href="#用DirectXMath库" class="headerlink" title="用DirectXMath库"></a>用DirectXMath库</h3><h5 id="DirectXMath变量的使用规范"><a href="#DirectXMath变量的使用规范" class="headerlink" title="DirectXMath变量的使用规范"></a>DirectXMath变量的使用规范</h5><ul>
<li>局部变量或全局变量用XMVECTOR类型</li>
<li>对于类中的数据成员，用XMFLOAT2\XMFLOAT3和XMFLOAT4类型</li>
<li>在运算之前，通过加载函数将XMFLOATn类型转换成XMVECTOR类型</li>
<li>用XMVECTOR实例来进行运算</li>
<li>通过存储函数将XMVECTOR类型转换为XMFLOATn类型</li>
</ul>
<h5 id="加载方法和存储方法"><a href="#加载方法和存储方法" class="headerlink" title="加载方法和存储方法"></a>加载方法和存储方法</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将数据从XMFLOAT2类型加载到XMVECTOR类型</span></span><br><span class="line"><span class="function">XMVECTOR XM_CALLCONV <span class="title">XMLoadFloat2</span><span class="params">(<span class="keyword">const</span> XMFLOAT2* pSource)</span></span>;</span><br><span class="line"><span class="comment">//将数据从XMFLOAT3类型加载到XMVECTOR类型，XMFLOAT4类似</span></span><br><span class="line"><span class="function">XMVECTOR XM_CALLCONV <span class="title">XMLoadFloat3</span><span class="params">(<span class="keyword">const</span> XMFLOAT3* pSource)</span></span>;</span><br><span class="line"><span class="comment">//将数据从XMVECTOR类型存储到XMFLOAT2类型，XMFLOAT3以及XMFLOAT4方法类似</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> XM_CALLCONV <span class="title">XMStoreFloat2</span><span class="params">(XMFLOAT2* pDestination,FXMVECTOR V)</span></span>;</span><br><span class="line"><span class="comment">//********************//</span></span><br><span class="line"><span class="comment">//得到XMVECTOR实例中的一个分量或者将一个方脸转换为XMVECTOR类型</span></span><br><span class="line"><span class="function"><span class="keyword">float</span> XM_CALLCONV <span class="title">XMVectorGetX</span><span class="params">(FXMVECTOR V)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">float</span> XM_CALLCONV <span class="title">XMVectorGetY</span><span class="params">(FXMVECTOR V)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">float</span> XM_CALLCONV <span class="title">XMVectorGetZ</span><span class="params">(FXMVECTOR V)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">float</span> XM_CALLCONV <span class="title">XMVectorGetX</span><span class="params">(FXMVECTOR V)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">XMVECTOR XM_CALLCONV <span class="title">XMVectorSetX</span><span class="params">(FXMVECTOR V,<span class="keyword">float</span> x)</span></span>;</span><br><span class="line"><span class="function">XMVECTOR XM_CALLCONV <span class="title">XMVectorSetY</span><span class="params">(FXMVECTOR V,<span class="keyword">float</span> y)</span></span>;</span><br><span class="line"><span class="function">XMVECTOR XM_CALLCONV <span class="title">XMVectorSetZ</span><span class="params">(FXMVECTOR V,<span class="keyword">float</span> z)</span></span>;.</span><br><span class="line"><span class="function">XMVECTOR XM_CALLCONV <span class="title">XMVectorSetW</span><span class="params">(FXMVECTOR V,<span class="keyword">float</span> w)</span></span>;</span><br></pre></td></tr></table></figure>



<h5 id="参数传递"><a href="#参数传递" class="headerlink" title="参数传递"></a>参数传递</h5><h6 id="传递规则"><a href="#传递规则" class="headerlink" title="传递规则"></a>传递规则</h6><ul>
<li>前三个 XMVECTOR 参数用类型 <code>FXMVECTOR</code></li>
<li>第四个 XMVECTOR 参数用 <code>GXMVECTOR</code></li>
<li>第5、6个 XMVECTOR 参数用 <code>HXMVECTOR</code></li>
<li>其余的 XMVECTOR 参数用 <code>CXMVECTOR</code></li>
</ul>
<blockquote>
<p>在32位windows系统，编译器将根据**_fastcall**调用约定将前3个XMVECTOR参数传递到寄存器，其余放到栈</p>
<p>在32位windows系统，编译器将根据**_vectorcall**调用约定将前6个XMVECTOR参数传递到寄存器，其余放到栈上</p>
<p>其余平台上的定义，可以参见 <code>DirectXMath</code>库文档中的  <code>Library Internals</code>下的 <code>Calling Converntions</code> 部分的<code>[DirectXMath]</code></p>
</blockquote>
<h5 id="常向量"><a href="#常向量" class="headerlink" title="常向量"></a>常向量</h5><p>XMVECTOR类型的常量实例用 <strong><code>XMVECTORF32</code></strong> 表示</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> XMVECTORF32 v1 = &#123; <span class="number">0.5f</span>,<span class="number">1.0f</span>,<span class="number">1.0f</span>,<span class="number">1.0f</span> &#125;;</span><br></pre></td></tr></table></figure>

<p>XMVECTORF32是一种16字节对齐的结构体，数学库中有将他转换至XMVECTOR类型的运算符</p>
<p>另外也可以用<code>XMVECTORU32</code>类型来创建由证书数据构成的XMVECTOR常向量</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> XMVECTORU32 v2 = &#123; <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span> &#125;;</span><br></pre></td></tr></table></figure>

<h5 id="重载运算符"><a href="#重载运算符" class="headerlink" title="重载运算符"></a>重载运算符</h5><p>XMVECTOR类型针对向量的加法、减法和标量乘法都重载了运算符，如下</p>
<blockquote>
<p><img src="https://img.supervj.top/img/DX/image-20200118215001131.png" alt="image-20200118215001131"></p>
</blockquote>
<h5 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h5><p>DirectXMath库定义了一组于PI有关的常用数学常量近似值</p>
<blockquote>
<p><img src="https://img.supervj.top/img/DX/image-20200118215207615.png" alt="image-20200118215207615"></p>
</blockquote>
<p>另外还有角度和弧度之间的转化以及比较大小的函数</p>
<blockquote>
<p><img src="https://img.supervj.top/img/DX/image-20200118215348688.png" alt="image-20200118215348688"></p>
<p><img src="https://img.supervj.top/img/DX/image-20200118215354016.png" alt="image-20200118215354016"></p>
</blockquote>
<h5 id="Setter函数"><a href="#Setter函数" class="headerlink" title="Setter函数"></a>Setter函数</h5><p>DirectXMath库提供了下列函数，用来设置XMVECTOR类型中的数据</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//返回零向量</span></span><br><span class="line"><span class="function">XMVECTOR XM_CALLCONV <span class="title">XMVectorZero</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">//返回&#123;1，1，1，1&#125;</span></span><br><span class="line"><span class="function">XMVECTOR XM_CALLCONV <span class="title">XMVectorSplatOne</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">//返回&#123;x,y,z,w&#125;</span></span><br><span class="line"><span class="function">XMVECTOR XM_CALLCONV <span class="title">XMVectorSet</span><span class="params">(<span class="keyword">float</span> x,<span class="keyword">float</span> y,<span class="keyword">float</span> z,<span class="keyword">float</span> w)</span></span>;</span><br><span class="line"><span class="comment">//返回&#123;value),value),value),value)&#125;</span></span><br><span class="line"><span class="function">XMVECTOR XM_CALLCONV <span class="title">XMVectorReplicate</span><span class="params">(<span class="keyword">float</span> value)</span></span>;</span><br><span class="line"><span class="comment">//返回&#123;Vx，Vx，Vx，Vx&#125;，同理；用SplateY，SplayteZ可以返回P&#123;Vy...&#125;,或者&#123;Vz..&#125;</span></span><br><span class="line"><span class="function">XMVECTOR XM_CALLCONV <span class="title">XMVectorSplateX</span><span class="params">(FXMVECTOR V)</span></span>;    </span><br></pre></td></tr></table></figure>

<h5 id="使用案例"><a href="#使用案例" class="headerlink" title="使用案例"></a>使用案例</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;DirectXMath.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;DirectXPackedVector.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> DirectX;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> DirectX::PackedVector;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 重写了&lt;&lt;运算符，使得cout函数可以输出XMVECTOR</span></span><br><span class="line">ostream&amp; XM_CALLCONV <span class="keyword">operator</span>&lt;&lt;(ostream&amp; os, FXMVECTOR v)</span><br><span class="line">&#123;</span><br><span class="line">	XMFLOAT4 dest;</span><br><span class="line">	<span class="built_in">XMStoreFloat4</span>(&amp;dest, v);</span><br><span class="line">	os &lt;&lt; <span class="string">&quot;(&quot;</span> &lt;&lt; dest.x &lt;&lt; <span class="string">&quot;,&quot;</span> &lt;&lt; dest.y &lt;&lt; <span class="string">&quot;,&quot;</span> &lt;&lt; dest.z &lt;&lt;<span class="string">&quot;,&quot;</span>&lt;&lt;dest.w&lt;&lt; <span class="string">&quot;)&quot;</span> &lt;&lt; endl;</span><br><span class="line">	<span class="keyword">return</span> os;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">XMVerifyCPUSupport</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;directx math not supported&quot;</span> &lt;&lt; endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> XMVECTORF32 v1 = &#123; <span class="number">0.5f</span>,<span class="number">1.0f</span>,<span class="number">1.0f</span>,<span class="number">1.0f</span> &#125;;</span><br><span class="line">	XMVECTOR v2 = <span class="built_in">XMVectorReplicate</span>(<span class="number">0.99f</span>);</span><br><span class="line">	XMVECTOR v3 = &#123; <span class="number">.5</span>f,<span class="number">.5</span>f,<span class="number">.5</span>f,<span class="number">.5</span>f &#125;;</span><br><span class="line">	XMVECTOR v4 = <span class="built_in">XMVectorSet</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>);</span><br><span class="line">	XMVECTOR v5 = <span class="built_in">XMVectorSplatOne</span>();</span><br><span class="line">	XMVECTOR v6 = <span class="built_in">XMVectorZero</span>();</span><br><span class="line">	XMVECTOR v7 = <span class="built_in">XMVectorSplatZ</span>(v4);</span><br><span class="line">	cout &lt;&lt; v1 &lt;&lt; v2 &lt;&lt; v3 &lt;&lt; v4 &lt;&lt; v5 &lt;&lt; v6 &lt;&lt; v7;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><img src="https://img.supervj.top/img/DX/image-20200118221313633.png" alt="image-20200118221313633"></p>
</blockquote>
<h5 id="向量函数"><a href="#向量函数" class="headerlink" title="向量函数"></a>向量函数</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">XMVECTOR v1 = <span class="built_in">XMVectorSet</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">4</span>);</span><br><span class="line">	XMVECTOR v2 = <span class="built_in">XMVectorSet</span>(<span class="number">-1</span>, <span class="number">-1</span>, <span class="number">-1</span>, <span class="number">5</span>);</span><br><span class="line">	XMVECTOR v3 = <span class="built_in">XMVectorSet</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span> ,<span class="number">0</span>);</span><br><span class="line">	XMVECTOR a = <span class="built_in">XMVector4Length</span>(v1);<span class="comment">//||v1||2,2_范数，即平方和的更号</span></span><br><span class="line">	XMVECTOR b = <span class="built_in">XMVector4LengthSq</span>(v1);<span class="comment">//||v1||1,1_范数，即平方和</span></span><br><span class="line">	XMVECTOR c = v1 - v2;<span class="comment">//减法</span></span><br><span class="line">	XMVECTOR d = <span class="number">10</span> * v1;<span class="comment">//乘法</span></span><br><span class="line">	XMVECTOR e = <span class="built_in">XMVector4Normalize</span>(v1);<span class="comment">//标准化，即v1/|v1|</span></span><br><span class="line">	XMVECTOR f = <span class="built_in">XMVector3Dot</span>(v1,v2);<span class="comment">//v1·v1</span></span><br><span class="line">	XMVECTOR g = <span class="built_in">XMVector3Cross</span>(v1, v2);<span class="comment">//v1*v1</span></span><br><span class="line">	XMVECTOR projw, perpw;</span><br><span class="line">	<span class="built_in">XMVector3ComponentsFromNormal</span>(&amp;projw, &amp;perpw, v1, v3);<span class="comment">//求v1在v3的proj和perp</span></span><br><span class="line">	XMVECTOR angle = <span class="built_in">XMVector4AngleBetweenVectors</span>(v1, v2);<span class="comment">//2个向量的夹角</span></span><br><span class="line"></span><br><span class="line">cout &lt;&lt; a&lt;&lt;b&lt;&lt;c&lt;&lt;d&lt;&lt;e&lt;&lt;f&lt;&lt;g&lt;&lt;projw&lt;&lt;perpw&lt;&lt;angle;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p><img src="https://img.supervj.top/img/DX/image-20200119135645869.png" alt="image-20200119135645869"></p>
</blockquote>
<h5 id="浮点数的误差"><a href="#浮点数的误差" class="headerlink" title="浮点数的误差"></a>浮点数的误差</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">XMVector Epsilon=&#123;<span class="number">0.1</span>，<span class="number">0.1</span>，<span class="number">0.1</span>，<span class="number">0.1</span>&#125;；</span><br><span class="line"><span class="keyword">bool</span> IsEqual = <span class="built_in">XMVectorNearEqual</span>(v1, v2，Epsilon);<span class="comment">//约等于来解决</span></span><br></pre></td></tr></table></figure>

<h2 id="矩阵代数"><a href="#矩阵代数" class="headerlink" title="矩阵代数"></a>矩阵代数</h2><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>m*n的矩阵M，即由m行，n列构成的矩形阵列</p>
<ul>
<li>A<sub>1.*</sub></li>
<li>A<sub>*.1</sub></li>
</ul>
<p><img src="https://img.supervj.top/img/DX/image-20200120070458975.png" alt="image-20200120070458975"></p>
<p><img src="https://img.supervj.top/img/DX/image-20200120070505831.png" alt="image-20200120070505831"></p>
<h3 id="乘法"><a href="#乘法" class="headerlink" title="乘法"></a>乘法</h3><ul>
<li>矩阵<strong>AxB</strong>乘法的前提条件：A的列数必须于B的行数相同</li>
</ul>
<p>乘法公式</p>
<blockquote>
<p><img src="https://img.supervj.top/img/DX/image-20200120070807173.png" alt="image-20200120070807173"></p>
</blockquote>
<ul>
<li>即矩阵A的第<strong>i</strong>个行向量于B的第<strong>j</strong>个列向量点积</li>
</ul>
<blockquote>
<p><img src="https://img.supervj.top/img/DX/image-20200120070906956.png" alt="image-20200120070906956"></p>
</blockquote>
<ul>
<li>行列数不相等的矩阵乘法不满足交换律即 <strong>AB≠BA</strong></li>
</ul>
<h5 id="向量于矩阵乘法"><a href="#向量于矩阵乘法" class="headerlink" title="向量于矩阵乘法"></a>向量于矩阵乘法</h5><blockquote>
<p><img src="https://img.supervj.top/img/DX/image-20200120071122512.png" alt="image-20200120071122512"></p>
<p><img src="https://img.supervj.top/img/DX/image-20200120071219317.png" alt="image-20200120071219317"></p>
</blockquote>
<h3 id="转置矩阵"><a href="#转置矩阵" class="headerlink" title="转置矩阵"></a>转置矩阵</h3><p><strong>转置矩阵（transpose matrix）</strong>是将原矩阵阵列的 行与列进行互换 即mn的矩阵变成nm的矩阵</p>
<p>**M **的转置矩阵记作 <strong>M<sup>t</sup></strong></p>
<ul>
<li>转置矩阵具有下列性质</li>
</ul>
<blockquote>
<p><strong><img src="https://img.supervj.top/img/DX/image-20200120071623379.png" alt="image-20200120071623379"></strong></p>
</blockquote>
<h3 id="单位矩阵"><a href="#单位矩阵" class="headerlink" title="单位矩阵"></a>单位矩阵</h3><p><strong>单位矩阵(identity matrix)<strong>是一种主对角线上的元素都是</strong>1</strong>，其他元素都是0的方阵，如</p>
<blockquote>
<p><img src="https://img.supervj.top/img/DX/image-20200120071758210.png" alt="image-20200120071758210"></p>
</blockquote>
<ul>
<li>任何单位与单位矩阵相乘，得到的依然是原来的矩阵，而且满足交换律</li>
</ul>
<blockquote>
<p>MI=IM=M</p>
</blockquote>
<h3 id="矩阵的行列式"><a href="#矩阵的行列式" class="headerlink" title="矩阵的行列式"></a>矩阵的行列式</h3><p>行列式记作： <strong>det A</strong></p>
<ul>
<li>当且仅当det A≠0时，方阵A是可逆的</li>
</ul>
<h5 id="余子阵"><a href="#余子阵" class="headerlink" title="余子阵"></a>余子阵</h5><p>n x n的矩阵A，<strong>余子阵（minor matrix）</strong> <img src="https://img.supervj.top/img/DX/image-20200120191929162.png" alt="image-20200120191929162">即从A中去除第 <strong>i</strong> 行和第 <strong>j</strong> 列的**(n-1)*(n-1)**矩阵</p>
<blockquote>
<p><img src="https://img.supervj.top/img/DX/image-20200120200716480.png" alt="image-20200120200716480"></p>
<p><img src="https://img.supervj.top/img/DX/image-20200120200727115.png" alt="image-20200120200727115"></p>
<p><img src="https://img.supervj.top/img/DX/image-20200120200736692.png" alt="image-20200120200736692"></p>
</blockquote>
<h5 id="行列式"><a href="#行列式" class="headerlink" title="行列式"></a>行列式</h5><p><img src="https://img.supervj.top/img/DX/image-20200120200844209.png" alt="image-20200120200844209"></p>
<ul>
<li>对于2 x 2 的矩阵来说，行列式公式为：</li>
</ul>
<p><img src="https://img.supervj.top/img/DX/image-20200120200914468.png" alt="image-20200120200914468"></p>
<ul>
<li>3 x 3的矩阵，行列式公式为：</li>
</ul>
<blockquote>
<p><img src="https://img.supervj.top/img/DX/image-20200120201007378.png" alt="image-20200120201007378"></p>
</blockquote>
<ul>
<li>4 x 4的矩阵，行列式公式为：</li>
</ul>
<blockquote>
<p><img src="https://img.supervj.top/img/DX/image-20200120201040699.png" alt="image-20200120201040699"></p>
</blockquote>
<ul>
<li>案例：</li>
</ul>
<blockquote>
<p><img src="https://img.supervj.top/img/DX/image-20200120201108843.png" alt="image-20200120201108843"></p>
</blockquote>
<blockquote>
<p><strong>一个矩阵的行列式就是一个平行多面体的（定向的）体积，这个多面体的每条边对应着对应矩阵的列。如果学生得知了这个秘密（在纯粹的代数式的教育中，这个秘密被仔细的隐藏了起来），那么行列式的整个理论都将成为多重线性形式理论的一部分。倘若用别的方式来定义行列式，任何敏感的人都将会永远痛恨诸如行列式，Jacobian式，以及隐函数定理这些东西。</strong></p>
<p>​                          <strong>——俄国数学家阿诺尔德（Vladimir Arnold）《论数学教育》</strong></p>
</blockquote>
<h3 id="伴随矩阵"><a href="#伴随矩阵" class="headerlink" title="伴随矩阵"></a>伴随矩阵</h3><p><img src="https://img.supervj.top/img/DX/image-20200120201159666.png" alt="image-20200120201159666"></p>
<p>如果A中的每个元素分别计算出C<sub>ij</sub>,并将它至于矩阵C<sub>A</sub>中的第 <strong>i</strong> 行，第 <strong>j</strong> 列，那么将获得矩阵A的 <strong>代数余子式矩阵(cofactor matrix of A)</strong></p>
<blockquote>
<p><img src="https://img.supervj.top/img/DX/image-20200120201605278.png" alt="image-20200120201605278"></p>
</blockquote>
<p>取矩阵C<sub>A</sub>的转置矩阵，得到<strong>矩阵A的伴随矩阵（adjoint matrix of A）</strong>，记作</p>
<blockquote>
<p><img src="https://img.supervj.top/img/DX/image-20200120204905556.png" alt="image-20200120204905556"></p>
</blockquote>
<h3 id="逆矩阵"><a href="#逆矩阵" class="headerlink" title="逆矩阵"></a>逆矩阵</h3><ul>
<li>只有方阵才有逆矩阵</li>
<li>n x n矩阵M的逆也是一个n x n的矩阵，记作 M<sup>-1</sup></li>
<li>不是每个方阵都有逆矩阵，存在逆矩阵的方阵称为<strong>可逆矩阵（invertible matrix）</strong>，不存在逆矩阵的叫做<strong>奇异矩阵（singular matrix）</strong></li>
<li>可逆矩阵的逆矩阵是唯一的</li>
<li>可逆矩阵有逆矩阵相乘等到单位方阵： MM<sup>-1</sup>=M<sup>-1</sup>M=I，矩阵与其逆矩阵妈祖交换律</li>
</ul>
<p>逆矩阵的推导公式</p>
<blockquote>
<p><img src="https://img.supervj.top/img/DX/image-20200120205253567.png" alt="image-20200120205253567"></p>
</blockquote>
<ul>
<li>案例，<img src="https://img.supervj.top/img/DX/image-20200120205340831.png" alt="image-20200120205340831"></li>
</ul>
<blockquote>
<p><img src="https://img.supervj.top/img/DX/image-20200120205418259.png" alt="image-20200120205418259"></p>
</blockquote>
<ul>
<li><img src="https://img.supervj.top/img/DX/image-20200120205505699.png" alt="image-20200120205505699"></li>
</ul>
<blockquote>
<p><img src="https://img.supervj.top/img/DX/image-20200120205519977.png" alt="image-20200120205519977"></p>
</blockquote>
<ul>
<li><img src="https://img.supervj.top/img/DX/image-20200120211359396.png" alt="image-20200120211359396"></li>
</ul>
<h3 id="DirectXMath库处理矩阵阵列"><a href="#DirectXMath库处理矩阵阵列" class="headerlink" title="DirectXMath库处理矩阵阵列"></a>DirectXMath库处理矩阵阵列</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">ostream&amp; XM_CALLCONV <span class="keyword">operator</span>&lt;&lt;(ostream&amp; os, FXMVECTOR v)</span><br><span class="line">&#123;</span><br><span class="line">	XMFLOAT4 dest;</span><br><span class="line">	<span class="built_in">XMStoreFloat4</span>(&amp;dest, v);</span><br><span class="line">	os &lt;&lt; <span class="string">&quot;(&quot;</span> &lt;&lt; dest.x &lt;&lt; <span class="string">&quot;,&quot;</span> &lt;&lt; dest.y &lt;&lt; <span class="string">&quot;,&quot;</span> &lt;&lt; dest.z &lt;&lt;<span class="string">&quot;,&quot;</span>&lt;&lt;dest.w&lt;&lt; <span class="string">&quot;)&quot;</span> ;</span><br><span class="line">	<span class="keyword">return</span> os;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ostream&amp; XM_CALLCONV <span class="keyword">operator</span>&lt;&lt;(ostream&amp; os, FXMMATRIX v)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">4</span>;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		os &lt;&lt; <span class="built_in">XMVectorGetX</span>(v.r[i]) &lt;&lt; <span class="string">&quot;\t&quot;</span>;</span><br><span class="line">		os &lt;&lt; <span class="built_in">XMVectorGetY</span>(v.r[i]) &lt;&lt; <span class="string">&quot;\t&quot;</span>;</span><br><span class="line">		os &lt;&lt; <span class="built_in">XMVectorGetZ</span>(v.r[i]) &lt;&lt; <span class="string">&quot;\t&quot;</span>;</span><br><span class="line">		os &lt;&lt; <span class="built_in">XMVectorGetW</span>(v.r[i]) &lt;&lt; <span class="string">&quot;\t&quot;</span>;</span><br><span class="line">		os &lt;&lt; endl;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> os;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">XMVerifyCPUSupport</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;directx math not supported&quot;</span> &lt;&lt; endl;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">XMMATRIX <span class="title">A</span></span></span><br><span class="line"><span class="function">	<span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="number">0.0f</span>, <span class="number">2.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">4.0f</span>, <span class="number">0.0f</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="number">1.0f</span>, <span class="number">2.0f</span>, <span class="number">3.0f</span>, <span class="number">1.0f</span></span></span></span><br><span class="line"><span class="params"><span class="function">	)</span></span>;</span><br><span class="line"></span><br><span class="line">		XMMATRIX B = <span class="built_in">XMMatrixIdentity</span>();<span class="comment">//单位矩阵，斜线都是1</span></span><br><span class="line">	XMMATRIX C = A * B;<span class="comment">//矩阵乘法，AI=A；</span></span><br><span class="line">	XMMATRIX D = <span class="built_in">XMMatrixTranspose</span>(A);<span class="comment">//转置矩阵，行列反转</span></span><br><span class="line">	XMVECTOR det = <span class="built_in">XMMatrixDeterminant</span>(A);<span class="comment">//得到（det A,det A,det A,det A）</span></span><br><span class="line">	XMMATRIX E = <span class="built_in">XMMatrixInverse</span>(&amp;det, A);<span class="comment">//返回M逆矩阵</span></span><br><span class="line">	XMMATRIX F = A * E;<span class="comment">//矩阵与逆矩阵乘积等于单位矩阵</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	cout &lt;&lt; A &lt;&lt; endl &lt;&lt; B &lt;&lt; endl &lt;&lt; C &lt;&lt; endl &lt;&lt; D &lt;&lt; endl &lt;&lt; E &lt;&lt; endl &lt;&lt; det &lt;&lt; endl &lt;&lt; F;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><img src="https://img.supervj.top/img/DX/image-20200120211048937.png" alt="image-20200120211048937"></p>
</blockquote>
<h2 id="变换"><a href="#变换" class="headerlink" title="变换"></a>变换</h2><h3 id="线性变换"><a href="#线性变换" class="headerlink" title="线性变换"></a>线性变换</h3><p>线性变换函数满足</p>
<h6 id="线性变换函数公式"><a href="#线性变换函数公式" class="headerlink" title="线性变换函数公式"></a>线性变换函数公式</h6><blockquote>
<p> <img src="https://img.supervj.top/img/DX/image-20200121070851768.png" alt="image-20200121070851768"></p>
</blockquote>
<h5 id="矩阵表示法"><a href="#矩阵表示法" class="headerlink" title="矩阵表示法"></a>矩阵表示法</h5><p>**u=(x,y,z)**也可以写作</p>
<h6 id="矩阵表示法公式"><a href="#矩阵表示法公式" class="headerlink" title="矩阵表示法公式"></a>矩阵表示法公式</h6><h6 id=""><a href="#" class="headerlink" title=""></a><img src="https://img.supervj.top/img/DX/image-20200121071106597.png" alt="image-20200121071106597"></h6><h6 id="R3-标准基向量"><a href="#R3-标准基向量" class="headerlink" title="R3,标准基向量"></a>R<sup>3</sup>,标准基向量</h6><p><strong>i=(1,0,0), j=(0,1,0), k=(0,0,1)</strong></p>
<h6 id="矩阵表示法公式2"><a href="#矩阵表示法公式2" class="headerlink" title="矩阵表示法公式2"></a>矩阵表示法公式2</h6><p><img src="https://img.supervj.top/img/DX/image-20200121071255330.png" alt="image-20200121071255330"></p>
<p>根据线性组合，上述公式可以改写成</p>
<h6 id="线性变换的矩阵表示法"><a href="#线性变换的矩阵表示法" class="headerlink" title="线性变换的矩阵表示法"></a>线性变换的矩阵表示法</h6><p><img src="https://img.supervj.top/img/DX/image-20200121071642398.png" alt="image-20200121071642398"></p>
<p>我们称矩阵 <strong>A</strong>是线性变换的矩阵表示法</p>
<h5 id="缩放"><a href="#缩放" class="headerlink" title="缩放"></a>缩放</h5><h6 id="定义-1"><a href="#定义-1" class="headerlink" title="定义"></a>定义</h6><p><img src="https://img.supervj.top/img/DX/image-20200121071743966.png" alt="image-20200121071743966"></p>
<ul>
<li>S就是一种线性变换</li>
</ul>
<blockquote>
<p><img src="https://img.supervj.top/img/DX/image-20200121071817696.png" alt="image-20200121071817696"></p>
</blockquote>
<h6 id="缩放变换的矩阵表达式"><a href="#缩放变换的矩阵表达式" class="headerlink" title="缩放变换的矩阵表达式"></a>缩放变换的矩阵表达式</h6><blockquote>
<p> <img src="https://img.supervj.top/img/DX/image-20200121071907341.png" alt="image-20200121071907341"></p>
</blockquote>
<ul>
<li>缩放矩阵的逆矩阵</li>
</ul>
<blockquote>
<p><img src="https://img.supervj.top/img/DX/image-20200623102531554.png" alt="image-20200623102531554"></p>
</blockquote>
<ul>
<li>案例</li>
</ul>
<p><img src="https://img.supervj.top/img/DX/image-20200623102549550.png" alt="image-20200623102549550"></p>
<h5 id="旋转"><a href="#旋转" class="headerlink" title="旋转"></a>旋转</h5><h6 id="旋转矩阵基础公式"><a href="#旋转矩阵基础公式" class="headerlink" title="旋转矩阵基础公式"></a>旋转矩阵基础公式</h6><blockquote>
<p><img src="https://img.supervj.top/img/DX/image-20200121153741133.png" alt="image-20200121153741133"></p>
<p><img src="https://img.supervj.top/img/DX/image-20200623102608770.png" alt="image-20200623102608770"></p>
</blockquote>
<ul>
<li><p>上述公式里，<em><strong>c=cosθ</strong></em> 而且 <em><strong>s=sinθ</strong></em></p>
</li>
<li><p>旋转矩阵有个特性：每个行向量都为单位长度且两两正交，即这些行向量都是<strong>规范正交(orthonormal)</strong></p>
</li>
<li><p>若一个矩阵的行向量都是规范正交的，则此矩阵为<strong>正交矩阵（orthogonal matrix）</strong></p>
</li>
</ul>
<h6 id="正交矩阵的逆矩阵"><a href="#正交矩阵的逆矩阵" class="headerlink" title="正交矩阵的逆矩阵"></a>正交矩阵的逆矩阵</h6><blockquote>
<p><img src="https://img.supervj.top/img/DX/image-20200121154123112.png" alt="image-20200121154123112"></p>
</blockquote>
<h6 id="通俗公式"><a href="#通俗公式" class="headerlink" title="通俗公式"></a>通俗公式</h6><p>如果选择绕<em><strong>x、y、z</strong></em>轴旋转，即分别取 <em><strong>n =（1，0，0）、n =（0，1，0）、n =（0，0，1）</strong></em>，那么对应的旋转矩阵是</p>
<blockquote>
<p><img src="https://img.supervj.top/img/DX/image-20200121154343881.png" alt="image-20200121154343881"></p>
</blockquote>
<h6 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h6><blockquote>
<p><img src="https://img.supervj.top/img/DX/image-20200121154450682.png" alt="image-20200121154450682"></p>
</blockquote>
<h3 id="仿射变换"><a href="#仿射变换" class="headerlink" title="仿射变换"></a>仿射变换</h3><h4 id="齐次坐标"><a href="#齐次坐标" class="headerlink" title="齐次坐标"></a>齐次坐标</h4><ul>
<li><em><strong>（x,y,z,0）</strong></em>表示向量</li>
<li><em><strong>（x,y,z,1）</strong></em>表示点</li>
</ul>
<h5 id="仿射变换定义"><a href="#仿射变换定义" class="headerlink" title="仿射变换定义"></a>仿射变换定义</h5><ul>
<li>仿射变换：一个线性变换加上一个平移变量 <em><strong>b</strong></em>,即</li>
</ul>
<blockquote>
<p> <em><strong>α(u)=τ(u)+b</strong></em></p>
</blockquote>
<ul>
<li>或者用矩阵表示法,A是一个线性变换的矩阵表示</li>
</ul>
<blockquote>
<p> <img src="https://img.supervj.top/img/DX/image-20200121160932351.png" alt="image-20200121160932351"></p>
</blockquote>
<ul>
<li>如果w=1把坐标扩充为齐次坐标，那么把上述公式简化成</li>
</ul>
<blockquote>
<p><img src="https://img.supervj.top/img/DX/image-20200121161200597.png" alt="image-20200121161200597"></p>
</blockquote>
<h5 id="平移"><a href="#平移" class="headerlink" title="平移"></a>平移</h5><h6 id="恒等变换"><a href="#恒等变换" class="headerlink" title="恒等变换"></a>恒等变换</h6><p><strong>恒等变换</strong>是一种直接返回其输入参数的线性变换，如 <em><strong>I(u)=u</strong></em></p>
<p>如果将平移变换定义为仿射变换，贼其中的线性变换就是一种恒等变换，即</p>
<blockquote>
<p><img src="https://img.supervj.top/img/DX/image-20200121161843458.png" alt="image-20200121161843458"></p>
</blockquote>
<h6 id="平移矩阵"><a href="#平移矩阵" class="headerlink" title="平移矩阵"></a>平移矩阵</h6><p><img src="https://img.supervj.top/img/DX/image-20200121161704819.png" alt="image-20200121161704819"></p>
<h6 id="平移矩阵的逆矩阵"><a href="#平移矩阵的逆矩阵" class="headerlink" title="平移矩阵的逆矩阵"></a>平移矩阵的逆矩阵</h6><p><img src="https://img.supervj.top/img/DX/image-20200121161727755.png" alt="image-20200121161727755"></p>
<h6 id="案例-1"><a href="#案例-1" class="headerlink" title="案例"></a>案例</h6><p><img src="https://img.supervj.top/img/DX/image-20200121161922233.png" alt="image-20200121161922233"></p>
<h5 id="缩放和旋转的放射矩阵"><a href="#缩放和旋转的放射矩阵" class="headerlink" title="缩放和旋转的放射矩阵"></a>缩放和旋转的放射矩阵</h5><ul>
<li>如果放射变换的 b=0 ,则放射变换就是线性变换</li>
<li>意味着，可以通过一个 4 x 4 的放射矩阵表达任意线性变换</li>
</ul>
<h6 id="4x4的缩放矩阵"><a href="#4x4的缩放矩阵" class="headerlink" title="4x4的缩放矩阵"></a>4x4的缩放矩阵</h6><p><img src="https://img.supervj.top/img/DX/image-20200121163133298.png" alt="image-20200121163133298"></p>
<h6 id="4x4的旋转矩阵"><a href="#4x4的旋转矩阵" class="headerlink" title="4x4的旋转矩阵"></a>4x4的旋转矩阵</h6><p><img src="https://img.supervj.top/img/DX/image-20200121163151822.png" alt="image-20200121163151822"></p>
<h5 id="仿射变换矩阵的几何意义"><a href="#仿射变换矩阵的几何意义" class="headerlink" title="仿射变换矩阵的几何意义"></a>仿射变换矩阵的几何意义</h5><p><img src="https://img.supervj.top/img/DX/image-20200121163854031.png" alt="image-20200121163854031"></p>
<h4 id="变换的复合"><a href="#变换的复合" class="headerlink" title="变换的复合"></a>变换的复合</h4><p>假设<em><strong>S</strong></em>为缩放矩阵，<em><strong>T</strong></em>为平移矩阵，<em><strong>R</strong></em>为旋转矩阵</p>
<p>因为矩阵乘法（不满足交换律），所以我么可以定义<em><strong>C=SRT</strong></em>，即把3个矩阵变成1个，方便计算</p>
<h4 id="坐标变换"><a href="#坐标变换" class="headerlink" title="坐标变换"></a>坐标变换</h4><h5 id="坐标变换矩阵-标架变换矩阵公式"><a href="#坐标变换矩阵-标架变换矩阵公式" class="headerlink" title="坐标变换矩阵/标架变换矩阵公式"></a>坐标变换矩阵/标架变换矩阵公式</h5><h5 id="-1"><a href="#-1" class="headerlink" title=""></a><img src="https://img.supervj.top/img/DX/image-20200121170431813.png" alt="image-20200121170431813"></h5><h5 id="结合律"><a href="#结合律" class="headerlink" title="结合律"></a>结合律</h5><ul>
<li>3个标架<strong>F,G,H</strong></li>
<li><strong>A</strong>：<strong>F</strong>转换到<strong>G</strong>的变换矩阵</li>
<li><strong>B</strong>：<strong>G</strong>转换到<strong>H</strong>的变换矩阵</li>
<li><em><strong>p<sub>F</sub></strong></em>:<strong>F</strong>中的一个向量</li>
<li>求：此向量在标架H中的坐标<em><strong>P<sub>H</sub></strong></em></li>
</ul>
<p>***(p<sub>F</sub>***<strong>A)B</strong>=<em><strong>P<sub>H</sub></strong></em></p>
<p><em><strong>(p<sub>G</sub></strong></em><strong>)B</strong>=<em><strong>P<sub>H</sub></strong></em></p>
<ul>
<li>由于矩阵乘法满足结合律，所以</li>
</ul>
<p><em><strong>p<sub>F</sub></strong></em>(<strong>AB</strong>)=<em><strong>P<sub>H</sub></strong></em></p>
<h5 id="逆矩阵-1"><a href="#逆矩阵-1" class="headerlink" title="逆矩阵"></a>逆矩阵</h5><p><em><strong>p<sub>F</sub>A</strong></em>=<em><strong>P<sub>H</sub></strong></em></p>
<p><em><strong>P<sub>F</sub></strong></em>=<em><strong>p<sub>H</sub>A<sup>-1</sup></strong></em></p>
<h4 id="变换矩阵与坐标变换矩阵"><a href="#变换矩阵与坐标变换矩阵" class="headerlink" title="变换矩阵与坐标变换矩阵"></a>变换矩阵与坐标变换矩阵</h4><p>在数学上，可以将<strong>改变几何体的变换</strong>解释为<strong>坐标变换</strong>，反之亦然</p>
<h4 id="DirectXMath库的变换函数"><a href="#DirectXMath库的变换函数" class="headerlink" title="DirectXMath库的变换函数"></a>DirectXMath库的变换函数</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;DirectXMath.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;DirectXPackedVector.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> DirectX;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> DirectX::PackedVector;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ostream&amp; <span class="keyword">operator</span>&lt;&lt;( ostream&amp; os, FXMVECTOR v)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">	XMFLOAT4 value;</span><br><span class="line">	<span class="built_in">XMStoreFloat4</span>(&amp;value, v);</span><br><span class="line">	os &lt;&lt; <span class="string">&quot;(&quot;</span> &lt;&lt; value.x &lt;&lt; <span class="string">&quot;,&quot;</span> &lt;&lt; value.y &lt;&lt; <span class="string">&quot;,&quot;</span> &lt;&lt; value.z &lt;&lt; <span class="string">&quot;,&quot;</span> &lt;&lt; value.w &lt;&lt; <span class="string">&quot;)&quot;</span> &lt;&lt; endl;</span><br><span class="line">	<span class="keyword">return</span> os;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ostream&amp; <span class="keyword">operator</span>&lt;&lt;(ostream&amp; os, FXMMATRIX M)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">4</span>;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		os  &lt;&lt; <span class="built_in">XMVectorGetX</span>(M.r[i]) &lt;&lt; <span class="string">&quot;\t&quot;</span> ;</span><br><span class="line">		os  &lt;&lt; <span class="built_in">XMVectorGetY</span>(M.r[i]) &lt;&lt; <span class="string">&quot;\t&quot;</span> ;</span><br><span class="line">		os  &lt;&lt; <span class="built_in">XMVectorGetZ</span>(M.r[i]) &lt;&lt; <span class="string">&quot;\t&quot;</span> ;</span><br><span class="line">		os  &lt;&lt; <span class="built_in">XMVectorGetW</span>(M.r[i]) &lt;&lt; <span class="string">&quot;\t&quot;</span> ;</span><br><span class="line">		os &lt;&lt; endl;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> os;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	XMMATRIX m1 =</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="number">1.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span>, <span class="number">1.0f</span>,</span><br><span class="line">		<span class="number">2.0f</span>, <span class="number">2.0f</span>, <span class="number">2.0f</span>, <span class="number">2.0f</span>,</span><br><span class="line">		<span class="number">3.0f</span>, <span class="number">3.0f</span>, <span class="number">3.0f</span>, <span class="number">3.0f</span>,</span><br><span class="line">		<span class="number">4.0f</span>, <span class="number">4.0f</span>, <span class="number">4.0f</span>, <span class="number">4.0f</span></span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="comment">//缩放系数</span></span><br><span class="line">	XMMATRIX Scale1 = <span class="built_in">XMMatrixScaling</span>(<span class="number">1.0f</span>, <span class="number">2.0f</span>, <span class="number">3.0f</span>);<span class="comment">//缩放矩阵1</span></span><br><span class="line">	XMVECTOR v1 = <span class="built_in">XMVectorSet</span>(<span class="number">0.1</span>, <span class="number">0.1</span>, <span class="number">0.1</span>, <span class="number">0.1</span>);</span><br><span class="line">	XMMATRIX Scale2 = <span class="built_in">XMMatrixScalingFromVector</span>(v1);<span class="comment">//缩放矩阵2，根据Vector</span></span><br><span class="line"></span><br><span class="line">	XMMATRIX RotX = <span class="built_in">XMMatrixRotationX</span>(<span class="number">90.f</span>);<span class="comment">//X轴旋转矩阵</span></span><br><span class="line">	XMMATRIX RotY = <span class="built_in">XMMatrixRotationY</span>(<span class="number">45.f</span>);</span><br><span class="line">	XMMATRIX RotZ = <span class="built_in">XMMatrixRotationZ</span>(<span class="number">-180.f</span>);</span><br><span class="line">	XMVECTOR Axis= <span class="built_in">XMVectorSet</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">	XMMATRIX RotAxis = <span class="built_in">XMMatrixRotationAxis</span>(Axis, <span class="number">45.f</span>);<span class="comment">//根据自定义轴旋转</span></span><br><span class="line">	XMMATRIX TransT = <span class="built_in">XMMatrixTranslation</span>(<span class="number">100.f</span>, <span class="number">10.f</span>, <span class="number">-20.f</span>);<span class="comment">//位移矩阵</span></span><br><span class="line">	XMVECTOR vTransCoord = <span class="built_in">XMVector3TransformCoord</span>(v1, TransT);<span class="comment">//移动向量</span></span><br><span class="line">	XMVECTOR vTransNormal = <span class="built_in">XMVector3TransformNormal</span>(v1, TransT);</span><br><span class="line"></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;m=&quot;</span> &lt;&lt; endl &lt;&lt; m1  &lt;&lt; endl;</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;m*scale1=&quot;</span> &lt;&lt; endl&lt;&lt; m1* Scale1 &lt;&lt; endl;</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;m*scale2==&quot;</span> &lt;&lt; endl &lt;&lt; m1*Scale2 &lt;&lt; endl;</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;RotX==&quot;</span> &lt;&lt; endl &lt;&lt; RotX &lt;&lt; endl;</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;m*RotX==&quot;</span> &lt;&lt; endl &lt;&lt; m1 * RotX &lt;&lt; endl;</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;v1:TransCoord==&quot;</span> &lt;&lt; endl &lt;&lt; vTransCoord &lt;&lt; endl;</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;v1:TransNormal==&quot;</span> &lt;&lt; endl &lt;&lt; vTransNormal &lt;&lt; endl;</span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><img src="https://img.supervj.top/img/DX/image-20200121182846768.png" alt="image-20200121182846768"></p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://supervj.top/2020/06/22/LearnDX12_Init/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://img.supervj.top/imgHEAD_Icon.png">
      <meta itemprop="name" content="VJ东">
      <meta itemprop="description" content=" 如果我们不曾相遇 ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="月光林地">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/06/22/LearnDX12_Init/" class="post-title-link" itemprop="url">DX学习笔记（二）：DX初始化</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-06-22 00:00:00" itemprop="dateCreated datePublished" datetime="2020-06-22T00:00:00+08:00">2020-06-22</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-08-02 16:40:31" itemprop="dateModified" datetime="2021-08-02T16:40:31+08:00">2021-08-02</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/graphics/" itemprop="url" rel="index"><span itemprop="name">graphics</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    
      <a title="changyan" href="/2020/06/22/LearnDX12_Init/#SOHUCS" itemprop="discussionUrl">
        <span id="url::http://supervj.top/2020/06/22/LearnDX12_Init/" class="cy_cmt_count" data-xid="2020/06/22/LearnDX12_Init/" itemprop="commentCount"></span>
      </a>
    
  </span>
  
  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>43k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>39 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Direct3D初始化"><a href="#Direct3D初始化" class="headerlink" title="Direct3D初始化"></a>Direct3D初始化</h2><h3 id="预备知识"><a href="#预备知识" class="headerlink" title="预备知识"></a>预备知识</h3><h5 id="组件对象模型"><a href="#组件对象模型" class="headerlink" title="组件对象模型"></a>组件对象模型</h5><p>组件对象模型<em><strong>（Component Object Model,COM）</strong></em>:不受DirectX语言束缚，并且向后兼容的技术</p>
<ul>
<li>获得COM接口需要借助特定函数，而不是C++的new</li>
<li>删除COM有Release方法，而不是delete</li>
<li><code>Mirrosoft::WRL::ComPtr</code>类是Window是下的<em><strong>COM</strong></em>对象的智能指针</li>
<li>当<em><strong>ComPtr</strong></em>出作用域时，它会自动调用Release方法</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Get: 返回一个指向此底层COM接口的指针，此方法常用于把原始COM接口指针作为参数传给函数</span></span><br><span class="line">ComPtr&lt;ID3D12RootSignature&gt; mRootSignature;</span><br><span class="line">...</span><br><span class="line">    <span class="comment">//SetGraphicsRootSignature需要获取ID3D12RootSignature*类型的参数</span></span><br><span class="line">    mCommandList-&gt;<span class="built_in">SetGraphicsRootSignature</span>(mRootSignature.<span class="built_in">Get</span>());</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//GetAddressOf:返回指向此底层COM接口指针的地址，此函数可以利用函数参数返回COM接口的指针</span></span><br><span class="line">ComPtr&lt;ID3D12CommandAlllocator&gt; mDirectCmdListAlloc;</span><br><span class="line">...</span><br><span class="line">    <span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateCommandAllocator</span>(</span><br><span class="line">        D3D12_COMMAND_LIST_TYPE_DIRECT,</span><br><span class="line">    mDirectCmdListAlloc.<span class="built_in">GetAddressOf</span>());</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Reset:将此ComPtr实例设置为nullptr释放与之相关的所有引用，同时减少COM接口引用次数，此方法功能与将ComPtr目标实例赋值nullptr效果相同</span></span><br></pre></td></tr></table></figure>

<h5 id="纹理格式"><a href="#纹理格式" class="headerlink" title="纹理格式"></a>纹理格式</h5><p>2D纹理是一种由数据元素构成的矩阵，每个元素存储的都是一个像素的颜色</p>
<ul>
<li><p><strong>DXGI_FORMAT_R32G32B32_FLOAT</strong>:每个元素由2个32位无符号整数分量构成，<strong>存储的不一定是颜色信息</strong></p>
</li>
<li><p><strong>DXGI_FORMAT_R16G16B16A16_UNORM</strong>:每个元素由4个8位无符号分量构成，每个分量都被映射到**[0，1]**的区间</p>
</li>
<li><p><strong>DXGI_FORMAT_R32G32_UINT</strong>:每个元素由2个32位无符号整数分量构成</p>
</li>
<li><p><strong>DXGI_FORMAT_R8G8B8A8_UNORM</strong>:每个元素由4个8位无符号分量构成，每个分量都被映射到**[0，1]**的区间</p>
</li>
<li><p><strong>DXGI_FORMAT_R8G8B8A8_SNORM</strong>:每个元素由4个8位无符号分量构成，每个分量都被映射到**[-1，1]**的区间</p>
</li>
<li><p><strong>DXGI_FORMAT_R9G9B9A9_SINT</strong>:每个元素由4个8位无符号分量构成，每个分量都被映射到**[-128，127]**的区间</p>
</li>
<li><p><strong>DXGI_FORMAT_R8G8B8A8_UINT</strong>:每个元素由4个8位无符号分量构成，每个分量都被映射到**[0，255]**的区间</p>
</li>
</ul>
<p>其他格式</p>
<ul>
<li>DXGI_FORMAT_R16G16B16A16_TYPELESS:每个元素由4个16位无符号分量构成，<strong>但是没有指出数据类型</strong></li>
</ul>
<h5 id="交换链和页面翻转"><a href="#交换链和页面翻转" class="headerlink" title="交换链和页面翻转"></a>交换链和页面翻转</h5><p><img src="https://img.supervj.top/img/PathOptimization/image-20200122072822631.png"></p>
<ul>
<li>前台缓冲区和后台缓冲区在绘制渲染过程中互换，这种操作称为：<strong>呈现（presenting，亦有译作提交、显示）</strong></li>
<li>前后台缓冲区构成了交换链，Direct3D中用==<code>IDXGISwapChain</code>==接口来表示</li>
<li>这个接口不仅储存了前后台缓冲区的纹理，还提供了修改缓冲区大小(<em><strong>IDXGISwapChain::ResiezeBuffers</strong></em>)和呈现缓冲区内容(<em><strong>IDXGISwapChain::Present</strong></em>)的方法</li>
<li>使用2个缓冲区的情况称为<em><strong>双缓冲(double buffering,亦有译作双重缓冲、双倍缓冲等)</strong></em></li>
<li>还可以用更多的缓冲区，使用3个缓冲区就叫作<em><strong>三重缓冲（triple buffering）</strong></em></li>
</ul>
<h5 id="深度缓冲"><a href="#深度缓冲" class="headerlink" title="深度缓冲"></a>深度缓冲</h5><p><strong>深度缓冲区（depth buffer）</strong>：存储的非图像数据，而是特定像素的深度信息</p>
<ul>
<li>深度值范围 <em><strong>0.0-1.0</strong></em></li>
<li><strong>0.0</strong>代表观察者在<em><strong>视锥体</strong></em>（视域体、视景体、视截体、视体），即观察者能看到的空间范围</li>
<li><strong>1.0</strong>代表观察者在视锥体中嫩通过看到的离自己最远的像素</li>
<li>如果后台缓冲区的分辨率位<em>1280x1024</em>,那么深度缓冲去也应当由<em>1280x1024</em></li>
</ul>
<p><strong>深度缓冲区的原理</strong>：计算每个像素的深度值，并执行<em><strong>深度测试（depth test）</strong></em>，具有最小深度值的像素会最终写入后台缓冲</p>
<p>深度缓冲区也是一种纹理，用如下格式来创建</p>
<ol>
<li>DXGI_FORMAT_D32_FLOAT_S8X24_UINT:占用64位，取其中的32位指定一个浮点型深度缓冲区，另有8位无符号整数分配给<em><strong>模板缓冲区(stencil buffer)</strong></em>,并且将该元素映射到[<em><strong>0,255</strong></em>]</li>
<li> DXGI_FORMAT_D32_FLOAT:指定一个32位浮点型深度缓冲区</li>
<li> DXGI_FORMAT_D24_UNORM_指定一个无符号的24位深度缓冲区，并将该元素映射到[<em><strong>0,1</strong></em>]区间；另有8位无符号整数分配给<em><strong>模板缓冲区(stencil buffer)</strong></em>,并且将该元素映射到[<em><strong>0,255</strong></em>]</li>
<li>DXGI_FORMAT_D16_UNORM:指定一个16位浮点型深度缓冲区，并将该元素映射到[<em><strong>0,1</strong></em>]区间</li>
</ol>
<h5 id="资源与描述符"><a href="#资源与描述符" class="headerlink" title="资源与描述符"></a>资源与描述符</h5><blockquote>
<p>资源-&gt;中间层（即描述符）-&gt;GPU</p>
</blockquote>
<p><strong>描述符</strong></p>
<ul>
<li>一种把送往GPU的资源进行描述的轻量级结构；</li>
<li> 绘制所需的资源通过描述符绑定到渲染流水线上；</li>
<li> 为GPU解释资源，如告知Direct3D某个资源如何使用（绑定到流水线的哪个阶段）；</li>
<li> 指定欲绑定资源中的局部数据</li>
</ul>
<h6 id="常见描述符"><a href="#常见描述符" class="headerlink" title="常见描述符"></a>常见描述符</h6><ol>
<li><em><strong>CBV/SRV/UAV</strong></em> ：分表表示常量缓冲区(constant buffer view)、着色器资源视图(shader resource view)和无序访问试图(unordered access view)3种资源；</li>
<li>***采样器(sampler，亦有译作取样器)***：表示采样器资源（用于纹理）</li>
<li><em><strong>RTV</strong></em>:渲染目标视图资源(render target view)</li>
<li><em><strong>DSV</strong></em>：深度/模板视图资源(depth/stencil view)</li>
</ol>
<p><strong>描述符堆</strong>：存放某种特定类描述符的内存，可以看作是描述符数组</p>
<h5 id="多重采样"><a href="#多重采样" class="headerlink" title="多重采样"></a>多重采样</h5><h6 id="超级采样（SSAA）"><a href="#超级采样（SSAA）" class="headerlink" title="超级采样（SSAA）"></a>超级采样（SSAA）</h6><p>超级采样：反走样技术</p>
<ul>
<li>使用4倍于屏幕分辨率大小的后台缓冲区和深度缓冲去；</li>
<li>3D场景以这种更大的分辨率渲染到后台缓冲区中；</li>
<li>当数据要从后台缓冲区调往屏幕显示的时候，会将后台缓冲区按4个像素一组进行解析（降采样,downsample），把放大的采样点数降低回原来采样点数每组用求平均值的方法得到相对平滑的像素颜色</li>
<li>实际上是通过软件的方式提升了画面分辨率</li>
<li>超级采样是高开销的操作，因为限速处理数量和占用内存大小都增加到了4倍，因此Direct3D支持一种<strong>性能和效果</strong>折中的反走样技术：<em><strong>多重采样(multisampling)</strong></em>,记作<em><strong>MSAA</strong></em></li>
</ul>
<h6 id="多重采样（MSAA）"><a href="#多重采样（MSAA）" class="headerlink" title="多重采样（MSAA）"></a>多重采样（MSAA）</h6><ul>
<li>多重采样不需要对每个子像素都进行计算</li>
<li>而是仅计算一次像素中心的颜色，在基于可视性和覆盖性将得到的颜色信息分享给其子像素</li>
</ul>
<h6 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h6><ul>
<li><p>超级采样：图像颜色要根据每一个像素来计算，因此每个子像素都可以各具不的颜色；开销更大但是更精确</p>
</li>
<li><p>多重采样：每个像素只需要计算一次，最后假尼姑得到的颜色数据复制到多边形覆盖的所有可见子像素中</p>
</li>
</ul>
<h5 id="用Direct3D进行多重采样"><a href="#用Direct3D进行多重采样" class="headerlink" title="用Direct3D进行多重采样"></a>用Direct3D进行多重采样</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">DXGI_SAMPLE_DESC</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    UINT count;<span class="comment">//指定了每个像素的采样次数，采样次数越多，代价越高</span></span><br><span class="line">    UINT Quality;;<span class="comment">//指示用户期望的图像质量级别，不同厂家而言，这个参数相差很多</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据给定的纹理格式和采样数量，用<code>ID3D12Device::CheckFeatureSupport</code>方法查询对应的质量级别</p>
<ul>
<li>考虑到多重采样会占用内存资源，又为了保证程序性能等原因，通常会把采样数量设定位 <em><strong>4 或 8</strong></em></li>
<li>如果不希望使用多重采样，可以设置采样数量位1，质量设置为0</li>
</ul>
<h5 id="功能级别"><a href="#功能级别" class="headerlink" title="功能级别"></a>功能级别</h5><p>Direct3D 11开始引用了<em><strong>功能级别(feature level)</strong></em>,代码里用 <code>D3D_FEATURE_LEVEL</code>表示</p>
 <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">D3D_FEATURE_LEVEL</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    D3D_FEATURE_LEVEL_9_1 = <span class="number">0x9100</span>,</span><br><span class="line">    D3D_FEATURE_LEVEL_9_2 = <span class="number">0x9200</span>,</span><br><span class="line">    D3D_FEATURE_LEVEL_9_3 = <span class="number">0x9300</span>,</span><br><span class="line">    D3D_FEATURE_LEVEL_10_0 = <span class="number">0xa000</span>,</span><br><span class="line">    D3D_FEATURE_LEVEL_10_1 = <span class="number">0xa100</span>,</span><br><span class="line">    D3D_FEATURE_LEVEL_11_0 = <span class="number">0xb000</span>,</span><br><span class="line">    D3D_FEATURE_LEVEL_11_1 = <span class="number">0xb100</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>功能级别为不同级别所支持的功能进行严格界定</li>
</ul>
<h5 id="DirectX图形学基础结构"><a href="#DirectX图形学基础结构" class="headerlink" title="DirectX图形学基础结构"></a>DirectX图形学基础结构</h5><p>DirectX图形学基础结构(DXGI)是一种与<em><strong>Direct3D配合使用的API</strong></em></p>
<p>如，<code>IDXGIFactory</code>是DXGI中的关键接口之一，用于创建<code>IDXGISwapChain</code>接口以及枚举<strong>显示适配器</strong></p>
<p>一个系统可能由数个显示设备，我们称每一台显示设备都是一个<strong>显示输出</strong>，用<code>IDXGIOutput</code>接口来表示</p>
<h5 id="功能支持的检测"><a href="#功能支持的检测" class="headerlink" title="功能支持的检测"></a>功能支持的检测</h5><p><code>ID3D12Device::CheckFeatureSupport</code>方法是检测当前图形驱动对多重过采样的支持，圆形如下</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HRESULT <span class="title">ID3D12Device::CheckFeatureSupport</span><span class="params">(D3D12_FEATURE Feature,<span class="keyword">void</span>* pFeatureSuportData,UINT FeatureSupportDataSize)</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>***Feature:***枚举类型<code>D3D12_FEATURE</code>中的成员之一，用于指定我们希望检测的功能支持类型，具体如下</p>
<ul>
<li>D2D12_FEATURE_D3D12_OPTIONS:检测当前图形驱动对Direct3D 12各种功能的支持情况</li>
<li>D3D12_FEATURE_ARCHITECTURE:检测图形适配器中GPU的硬件体系架构特性</li>
<li>D3D12_FEATURE_FEATURE_LEVELS:检测对功能级别的支持情况</li>
<li>D3D12_FEATURE_FORMAT_SUPPORT:检测对给定纹理格式的支持情况</li>
<li>D3D12_FEATURE_MULTISAMPLE_QUALITY_LEVELS:检测对多重采样功能的支持情况</li>
</ul>
</li>
<li><p><em><strong>pFeatureSuportData</strong></em>：指向某种数据结构的指针，该结构中存有检索到的特定功能支持的信息，<strong>此结构体的具体类型取决于Feature参数</strong></p>
<ul>
<li>D3D12_FEATURE_D3D12_OPTIONS:返回一个D3D12_FEATURE_DATA_D3D12_OPTIONS实例</li>
<li>D3D12_FEATURE_ARCHITECTURE:返回D3D12_FEATURE_ARCHITECTURE实例</li>
<li>D3D12_FEATURE_FEATURE_LEVELS:同上类推</li>
<li>D3D12_FEATURE_FORMAT_SUPPORT：同上类推</li>
<li>D3D12_FEATURE_MULTISAMPLE_QUALITY_LEVELS：同上类推</li>
</ul>
</li>
<li><p>FeatureSupportDataSize：传回<em><strong>pFeatureSuportData</strong></em>参数中的数据结构大小</p>
</li>
</ul>
<h5 id="资源驻留"><a href="#资源驻留" class="headerlink" title="资源驻留"></a>资源驻留</h5><p>Direct3D12中，应用程序通过控制资源在显存中的去留，主动管理资源的驻留情况（<code>Direct3D11中则有系统自动管理</code>）</p>
<p>一般情况，资源创建时就会驻留在显存中，被销毁时则清出。但是通过下面方法我们可以自己管理资源的驻留</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HRESULT <span class="title">ID3D12Device::MakeResident</span><span class="params">(UINT NumObjects,ID3D12Pageable* <span class="keyword">const</span> *ppObjects)</span></span>;</span><br><span class="line"><span class="function">HRESULT <span class="title">ID3D12Device::Evict</span><span class="params">(UINT NumObjects,ID3D12Pageable* <span class="keyword">const</span> *ppObjects)</span></span>;</span><br></pre></td></tr></table></figure>

<p>这两个方法的第二个参数都是<code>ID3D12Pageable</code>资源数组，第一个参数表示该数组资源的数量</p>
<h3 id="CPU和GPU的交互"><a href="#CPU和GPU的交互" class="headerlink" title="CPU和GPU的交互"></a>CPU和GPU的交互</h3><ul>
<li>每个GPU都至少维护这一个命令队列(command queue，本质上是环形缓冲区，即ring buffer)。</li>
<li>借助Direct3D API，CPU可以用命令列表(command list)将命令提交到这个队列中去</li>
<li>新加入的命令不会立即执行</li>
<li>假如命令列表空空如也，那么GPU会闲置</li>
<li>假如命令列表填满，那么CPU会在某个时刻保持空闲</li>
</ul>
<p>在Direct3D 12中，命令队列被抽象为==<code>ID3D12CommandQueue</code>==接口来表示，通过填写<code>D3D12_COMMAND_QUEUE_DESC</code>结构体来表示队列，在通过调用<code>ID3D12Device::CreateCommandQueue</code>方法来创建。</p>
<h5 id="命令队列"><a href="#命令队列" class="headerlink" title="命令队列"></a>命令队列</h5><h6 id="创建命令队列"><a href="#创建命令队列" class="headerlink" title="创建命令队列"></a>创建命令队列</h6><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建队列智能指针</span></span><br><span class="line">Microsoft::WRL::ComPtr&lt;ID3D12CommandQueue&gt; mCommandQueue;</span><br><span class="line">...;</span><br><span class="line"></span><br><span class="line">D3D12_COMMAND_QUEUE_DESC queueDesc = &#123;&#125;;</span><br><span class="line">queueDesc.Type = D3D12_COMMAND_LIST_TYPE_DIRECT;</span><br><span class="line">queueDesc.Flags = D3D12_COMMAND_QUEUE_FLAG_NONE;</span><br><span class="line"><span class="comment">//创建队列方法</span></span><br><span class="line"> <span class="comment">//IID_PPV_ARGS辅助宏本质是将ppType强制转换为void**类型</span></span><br><span class="line"><span class="comment">//Direct3D 12中创建接口实例的API时，大多数都有一个参数是类型void**的待创接口COM ID</span></span><br><span class="line"><span class="built_in">ThrowIfFailed</span>(md3dDevice&gt;<span class="built_in">CreateCommandQueue</span>(&amp;queueDesc,<span class="built_in">IID_PPV_ARGS</span>(&amp;mCommandQueue))); </span><br><span class="line"></span><br><span class="line">...;</span><br><span class="line"><span class="comment">//添加命令到命令列表里</span></span><br><span class="line"><span class="comment">//第一个参数是待执行的命令列表数组的数量</span></span><br><span class="line"><span class="comment">//第二个参数是待执行的命令列表数组</span></span><br><span class="line"> mCommandQueue-&gt;<span class="built_in">ExecuteCommandLists</span>(_countof(cmdsLists), cmdsLists);</span><br><span class="line"><span class="comment">//下列两个方法不是执行命令，而是将命令添加到命令列表里，还是需要通过ExecuteCommandLists方法才将命令真正加入到命令列表</span></span><br><span class="line"> mCommandQueue-&gt;<span class="built_in">DrawIndexedInstanced</span>(<span class="number">36</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line"> mCommandQueue-&gt;<span class="built_in">RSSetViewports</span>(<span class="number">1</span>,&amp;mScreenViewport);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//结束记录命令</span></span><br><span class="line"><span class="comment">//必须在调用ExecuteCommandLists方法之前先关闭</span></span><br><span class="line"> mCommandQueue-&gt;<span class="built_in">Close</span>();</span><br></pre></td></tr></table></figure>

<h6 id="内存分配器"><a href="#内存分配器" class="headerlink" title="内存分配器"></a>内存分配器</h6><p>内存分配器：存储命令列表里的命令，执行<code>ID3D12CommandQueue::ExecuteCommandLists</code>方法时，<strong>命令队列</strong>就会引用<strong>分配器里的命令</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> HRESULT STDMETHODCALLTYPE <span class="title">CreateCommandAllocator</span><span class="params">( </span></span></span><br><span class="line"><span class="params"><span class="function">            _In_  D3D12_COMMAND_LIST_TYPE type,</span></span></span><br><span class="line"><span class="params"><span class="function">            REFIID riid,</span></span></span><br><span class="line"><span class="params"><span class="function">            _COM_Outptr_  <span class="keyword">void</span> **ppCommandAllocator)</span> </span>= <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>type</code>:命令列表类型<ul>
<li><code>D3D12_COMMAND_LIST_TYPE_DIRECT</code>:GPU可直接执行的命令</li>
<li><code>D3D12_COMMAND_LIST_TYPE_BUNDLE</code>:打包的命令列表，一般不用</li>
</ul>
</li>
<li><code>riid</code>：适配接口的COM ID</li>
<li><code>ppCommandAllocator</code>:输出指向所建命令分配器的指针</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//内存管理指针</span></span><br><span class="line">Microsoft::WRL::ComPtr&lt;ID3D12CommandAllocator&gt; mDirectCmdListAlloc;</span><br><span class="line">...;</span><br><span class="line"></span><br><span class="line"><span class="comment">//第一个参数：此命令分配器相关联的命令列表类型，具体见下图</span></span><br><span class="line"><span class="comment">//第二个参数：内存分配器地址</span></span><br><span class="line"><span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateCommandAllocator</span>(</span><br><span class="line">		D3D12_COMMAND_LIST_TYPE_DIRECT,</span><br><span class="line">		<span class="built_in">IID_PPV_ARGS</span>(mDirectCmdListAlloc.<span class="built_in">GetAddressOf</span>())));</span><br></pre></td></tr></table></figure>





<h6 id="创建命令列表"><a href="#创建命令列表" class="headerlink" title="创建命令列表"></a>创建命令列表</h6><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//原型</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> HRESULT STDMETHODCALLTYPE <span class="title">CreateCommandList</span><span class="params">( </span></span></span><br><span class="line"><span class="params"><span class="function">            _In_  UINT nodeMask,</span></span></span><br><span class="line"><span class="params"><span class="function">            _In_  D3D12_COMMAND_LIST_TYPE type,</span></span></span><br><span class="line"><span class="params"><span class="function">            _In_  ID3D12CommandAllocator *pCommandAllocator,</span></span></span><br><span class="line"><span class="params"><span class="function">            _In_opt_  ID3D12PipelineState *pInitialState,</span></span></span><br><span class="line"><span class="params"><span class="function">            REFIID riid,</span></span></span><br><span class="line"><span class="params"><span class="function">            _COM_Outptr_  <span class="keyword">void</span> **ppCommandList)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//实例</span></span><br><span class="line"><span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateCommandList</span>(</span><br><span class="line">		<span class="number">0</span>,</span><br><span class="line">		D3D12_COMMAND_LIST_TYPE_DIRECT,</span><br><span class="line">		mDirectCmdListAlloc.<span class="built_in">Get</span>(), <span class="comment">// Associated command allocator</span></span><br><span class="line">		<span class="literal">nullptr</span>,                   <span class="comment">// Initial PipelineStateObject</span></span><br><span class="line">		<span class="built_in">IID_PPV_ARGS</span>(mCommandList.<span class="built_in">GetAddressOf</span>())));</span><br></pre></td></tr></table></figure>

<ol>
<li>nodeMask:如果只有1个GPU，设置成0；多个GPU用于关联的物理GPU</li>
<li>type:命令列表类型</li>
<li>pCommandAllocator:所建命令列表关联的命令分配器，类型必须匹配</li>
<li>pInitialState:指定命令列表的渲染流水线初始状态，一般可以设置为<code>nullptr</code></li>
<li>riid:待创建的<code>ID3D12CommandList</code>接口的<code>COM ID</code></li>
<li>ppCommandList:输出指向所建命令列表的指针</li>
</ol>
<h6 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h6><ul>
<li>可以创建多个关联同一个命令分配器的命令列表</li>
<li>但是不能同时用他们记录命令</li>
<li>其中一个命令列表在记录命令时，必须关闭同一分配器的其他命令列表</li>
<li>要保证命令列表中的所有命令都会按顺序连续的添加到命令分配器内</li>
<li>当创建或重置一个命令列表时，它会处于“<em><strong>打开</strong></em> ”状态，所以同时为同一命令列表分配器创建两个命令列表会报错</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ID3D12CommandQueue::<span class="built_in">ExecuteCommandList</span>(C)；<span class="comment">//把命令添加到命令列表</span></span><br><span class="line">    <span class="comment">/*将命令列表恢复到初始状态，借此继续复用其底层内存；</span></span><br><span class="line"><span class="comment">    重置列表不会影响命令队列的命令，内存分配器在当中维护</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    ID3D12GraphicsCommandLIst::<span class="built_in">Reset</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//GPU提交了一整帧的渲染命令后，我们可能还要为了绘制下一帧服用命令分配器的内存</span></span><br><span class="line"><span class="comment">//注意：在没有确定GPU执行完命令分配器的所有命令之前，千万不要重置命令分配器</span></span><br><span class="line">ID3D12CommandAllocator::<span class="built_in">Reset</span>();</span><br></pre></td></tr></table></figure>

<h5 id="GPU与CPU的同步"><a href="#GPU与CPU的同步" class="headerlink" title="GPU与CPU的同步"></a>GPU与CPU的同步</h5><p><strong>刷新命令队列</strong>：CPU会等待GPU完成所有命令处理，直到到达指定的***围栏点(fence point)***为止。</p>
<p>创建围栏</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HRESULT <span class="title">ID3D12Device::CreateFence</span><span class="params">(UINT64 InitialValue,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  D3D12_FENSE_FLAGS Flags,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 REFIID riid,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 <span class="keyword">void</span>** ppFence)</span></span>;</span><br><span class="line"><span class="comment">//示例</span></span><br><span class="line"> Microsoft::WRL::ComPtr&lt;ID3D12Fence&gt; mFence;</span><br><span class="line"><span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateFence</span>(<span class="number">0</span>, D3D12_FENCE_FLAG_NONE,</span><br><span class="line">		<span class="built_in">IID_PPV_ARGS</span>(&amp;mFence)));</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">D3DApp::FlushCommandQueue</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 增加围栏值，接下来将命令标记到此围栏点</span></span><br><span class="line">    mCurrentFence++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 向命令队列添加一条用来设置新围栏点的命令</span></span><br><span class="line">    <span class="comment">//由于这条命令有交给GPU处理，所以在GPU处理完命令队列中此Signal()的所有命令之前</span></span><br><span class="line">    <span class="comment">//它不会设置新的围栏点</span></span><br><span class="line">    <span class="built_in">ThrowIfFailed</span>(mCommandQueue-&gt;<span class="built_in">Signal</span>(mFence.<span class="built_in">Get</span>(), mCurrentFence));</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 在CPU等待GPU，直到后者执行完这个围栏点之前的所有命令</span></span><br><span class="line">    <span class="keyword">if</span>(mFence-&gt;<span class="built_in">GetCompletedValue</span>() &lt; mCurrentFence)</span><br><span class="line">	&#123;</span><br><span class="line">		HANDLE eventHandle = <span class="built_in">CreateEventEx</span>(<span class="literal">nullptr</span>, <span class="literal">false</span>, <span class="literal">false</span>, EVENT_ALL_ACCESS);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 若GPU命令中当前的围栏点（即执行到Signal()指令，修改了围栏点），则激发预定事件 </span></span><br><span class="line">        <span class="built_in">ThrowIfFailed</span>(mFence-&gt;<span class="built_in">SetEventOnCompletion</span>(mCurrentFence, eventHandle));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 等待GPU命中围栏，激发事件</span></span><br><span class="line">		<span class="built_in">WaitForSingleObject</span>(eventHandle, INFINITE);</span><br><span class="line">        <span class="built_in">CloseHandle</span>(eventHandle);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="资源转换"><a href="#资源转换" class="headerlink" title="资源转换"></a>资源转换</h5><p><strong>资源冒险</strong>：当GPU的写操作还没有完成或者还没有开始，却开始读取资源的情况</p>
<p>为了解决资源冒险问题，Direct3D设计了一组相关状态，如资源在创建的时候会初一默认状态，直到应用程序通过方法将其转换为另一种状态。</p>
<p><strong>转换资源屏障(<em>transition resource barrier</em></strong>):通过一个API调用来转换多个资源要用到的数组</p>
<h3 id="初始化Direct3D"><a href="#初始化Direct3D" class="headerlink" title="初始化Direct3D"></a>初始化Direct3D</h3><ul>
<li>初始化流程</li>
</ul>
<ol>
<li>用<code>D3D12CreateDevice</code>函数创建<code>ID3D12Device</code>接口实例</li>
<li>创建一个<code>ID3D12Fence</code>对象，并且查询描述符的大小</li>
<li>检测用户设备对<code>4X MSAA</code>质量级别的支持情况</li>
<li>一次创建命令队列、命令列表分配器和主命令列表</li>
<li>描述并创建交换链</li>
<li>创建应用程序所需的描述符堆</li>
<li>调整后台缓冲区的大小，并为它创建渲染图标视图</li>
<li>创建深度/模板缓冲区及与之关联的深度/模板视图</li>
<li>设置视口(viewport)和裁剪矩形(scissor rectangle)</li>
</ol>
<h5 id="创建设备"><a href="#创建设备" class="headerlink" title="创建设备"></a>创建设备</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HRESULT WINAPI <span class="title">D3D12CreateDevice</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ IUnknown* pAdapter,</span></span></span><br><span class="line"><span class="params"><span class="function">    D3D_FEATURE_LEVEL MinimumFeatureLevel,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ REFIID riid, <span class="comment">// Expected: ID3D12Device</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _COM_Outptr_opt_ <span class="keyword">void</span>** ppDevice )</span></span>;</span><br></pre></td></tr></table></figure>

<p>案例</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Try to create hardware device.</span></span><br><span class="line">HRESULT hardwareResult = <span class="built_in">D3D12CreateDevice</span>(</span><br><span class="line">	<span class="literal">nullptr</span>,             <span class="comment">// default adapter</span></span><br><span class="line">	D3D_FEATURE_LEVEL_11_0,</span><br><span class="line">	<span class="built_in">IID_PPV_ARGS</span>(&amp;md3dDevice));</span><br></pre></td></tr></table></figure>

<ol>
<li><code>pAdapte</code>r:使用的显示适配器，如果空，则使用主显示适配器</li>
<li><code>MinimumFeatureLevele</code>:应用程序需要硬件所支持的最低功能级别，如果适配器不支持此功能级别，则设备创建失败</li>
<li><code>riid</code>:<code>ID3D12Device</code>接口的COM ID</li>
<li><code>ppDevice</code>:返回创建的Direct3D 12设备</li>
</ol>
<blockquote>
<p>创建失败的话会尝试创建<code>WARP</code>设备</p>
</blockquote>
<h5 id="创建围栏"><a href="#创建围栏" class="headerlink" title="创建围栏"></a>创建围栏</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateFence</span>(<span class="number">0</span>, D3D12_FENCE_FLAG_NONE,</span><br><span class="line">		<span class="built_in">IID_PPV_ARGS</span>(&amp;mFence)));</span><br><span class="line"><span class="comment">//查询并保存描述符信息，方便后面使用</span></span><br><span class="line">	mRtvDescriptorSize = md3dDevice-&gt;<span class="built_in">GetDescriptorHandleIncrementSize</span>(D3D12_DESCRIPTOR_HEAP_TYPE_RTV);</span><br><span class="line">	mDsvDescriptorSize = md3dDevice-&gt;<span class="built_in">GetDescriptorHandleIncrementSize</span>(D3D12_DESCRIPTOR_HEAP_TYPE_DSV);</span><br><span class="line">	mCbvSrvUavDescriptorSize = md3dDevice-&gt;<span class="built_in">GetDescriptorHandleIncrementSize</span>(D3D12_DESCRIPTOR_HEAP_TYPE_CBV_SRV_UAV);</span><br></pre></td></tr></table></figure>

<h5 id="检测4X-MSAA支持"><a href="#检测4X-MSAA支持" class="headerlink" title="检测4X MSAA支持"></a>检测4X MSAA支持</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// Check 4X MSAA quality support for our back buffer format.</span></span><br><span class="line">   <span class="comment">// All Direct3D 11 capable devices support 4X MSAA for all render </span></span><br><span class="line">   <span class="comment">// target formats, so we only need to check quality support.</span></span><br><span class="line"></span><br><span class="line">D3D12_FEATURE_DATA_MULTISAMPLE_QUALITY_LEVELS msQualityLevels;</span><br><span class="line">msQualityLevels.Format = mBackBufferFormat;</span><br><span class="line">msQualityLevels.SampleCount = <span class="number">4</span>;</span><br><span class="line">msQualityLevels.Flags = D3D12_MULTISAMPLE_QUALITY_LEVELS_FLAG_NONE;</span><br><span class="line">msQualityLevels.NumQualityLevels = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CheckFeatureSupport</span>(</span><br><span class="line">	D3D12_FEATURE_MULTISAMPLE_QUALITY_LEVELS,</span><br><span class="line">	&amp;msQualityLevels,</span><br><span class="line">	<span class="built_in"><span class="keyword">sizeof</span></span>(msQualityLevels)));</span><br><span class="line"></span><br><span class="line">   m4xMsaaQuality = msQualityLevels.NumQualityLevels;</span><br><span class="line"><span class="built_in">assert</span>(m4xMsaaQuality &gt; <span class="number">0</span> &amp;&amp; <span class="string">&quot;Unexpected MSAA quality level.&quot;</span>);</span><br></pre></td></tr></table></figure>

<h5 id="创建命令队列和命令列表"><a href="#创建命令队列和命令列表" class="headerlink" title="创建命令队列和命令列表"></a>创建命令队列和命令列表</h5><ul>
<li><p>命令队列：<code>ID3D12CommandQueue</code></p>
</li>
<li><p>命令分配器：<code>ID3D12CommandAllocator</code></p>
</li>
<li><p>命令列表：<code>ID3D12GraphicsCommandList</code></p>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//.h申明</span></span><br><span class="line">Microsoft::WRL::ComPtr&lt;ID3D12CommandQueue&gt; mCommandQueue;</span><br><span class="line">    Microsoft::WRL::ComPtr&lt;ID3D12CommandAllocator&gt; mDirectCmdListAlloc;</span><br><span class="line">    Microsoft::WRL::ComPtr&lt;ID3D12GraphicsCommandList&gt; mCommandList;</span><br><span class="line"><span class="comment">//.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">D3DApp::CreateCommandObjects</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	D3D12_COMMAND_QUEUE_DESC queueDesc = &#123;&#125;;</span><br><span class="line">	queueDesc.Type = D3D12_COMMAND_LIST_TYPE_DIRECT;</span><br><span class="line">	queueDesc.Flags = D3D12_COMMAND_QUEUE_FLAG_NONE;</span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateCommandQueue</span>(&amp;queueDesc, <span class="built_in">IID_PPV_ARGS</span>(&amp;mCommandQueue)));</span><br><span class="line"></span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateCommandAllocator</span>(</span><br><span class="line">		D3D12_COMMAND_LIST_TYPE_DIRECT,</span><br><span class="line">		<span class="built_in">IID_PPV_ARGS</span>(mDirectCmdListAlloc.<span class="built_in">GetAddressOf</span>())));</span><br><span class="line"></span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateCommandList</span>(</span><br><span class="line">		<span class="number">0</span>,</span><br><span class="line">		D3D12_COMMAND_LIST_TYPE_DIRECT,</span><br><span class="line">		mDirectCmdListAlloc.<span class="built_in">Get</span>(), <span class="comment">// 关联的命令分配器</span></span><br><span class="line">		<span class="literal">nullptr</span>,                   <span class="comment">//初始的PipelineStateObject</span></span><br><span class="line">		<span class="built_in">IID_PPV_ARGS</span>(mCommandList.<span class="built_in">GetAddressOf</span>())));</span><br><span class="line"></span><br><span class="line"><span class="comment">//从关闭状态开始。 这是因为我们第一次提到</span></span><br><span class="line"><span class="comment">//在命令列表中，我们将对其进行重置，并且需要先关闭它</span></span><br><span class="line"><span class="comment">//调用Reset。</span></span><br><span class="line">	mCommandList-&gt;<span class="built_in">Close</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="创建交换链"><a href="#创建交换链" class="headerlink" title="创建交换链"></a>创建交换链</h5><ul>
<li><code>DXGI_SWAP_CHAIN_DESC</code>结构体定义</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">DXGI_SWAP_CHAIN_DESC</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">    DXGI_MODE_DESC BufferDesc;</span><br><span class="line">    DXGI_SAMPLE_DESC SampleDesc;</span><br><span class="line">    DXGI_USAGE BufferUsage;</span><br><span class="line">    UINT BufferCount;</span><br><span class="line">    HWND OutputWindow;</span><br><span class="line">    BOOL Windowed;</span><br><span class="line">    DXGI_SWAP_EFFECT SwapEffect;</span><br><span class="line">    UINT Flags;</span><br><span class="line">    &#125; 	DXGI_SWAP_CHAIN_DESC;</span><br></pre></td></tr></table></figure>

<ol>
<li>BufferDesc:后台缓冲区的属性，主要是高度、宽度和像素格式</li>
<li>SampleDesc：多重采样的质量级别以及对每个像素的采样次数</li>
<li>BufferUsage：如果要将数据渲染到后台缓冲区，则设置为<code>DXGI_USAGE_RENDER_TARGET_OUTPUT</code></li>
<li>BufferCount:缓冲区数量，指定为2即双缓冲</li>
<li>OutputWindow：渲染窗口的句柄</li>
<li>Windowed：true则窗口模式运行，否则全屏</li>
<li>SwapEffect：指定为<code>DXGI_SWAP_EFFECT_FLIP_DISCARD</code></li>
<li>Flags：可选；如果指定为<code>DXGI_SWAP_CHAIN_FLAG_ALLOW_MODE_SWITCH</code>则程序切换为全屏时，将选择适用于当前窗口尺寸的显示模式；否则就采用当前桌面的显示模式</li>
</ol>
<ul>
<li><code>DXGI_MODE_DESC</code></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">DXGI_MODE_DESC</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    UINT Width;<span class="comment">//缓冲区分辨率的宽度</span></span><br><span class="line">    UINT Height;<span class="comment">//高度</span></span><br><span class="line">    DXGI_RATIONAL RefreshRate;</span><br><span class="line">    DXGI_FORMAT Format;<span class="comment">//显示格式</span></span><br><span class="line">    DXGI_MODE_SCANLINE_ORDER ScanlineOrdering;<span class="comment">//逐行扫面vs.隔行扫描</span></span><br><span class="line">    DXGI_MODE_SCALING Scaling;<span class="comment">//如何进行拉升</span></span><br><span class="line">&#125; DXGI_MODE_DESC;</span><br></pre></td></tr></table></figure>

<h6 id="执行创建交换链"><a href="#执行创建交换链" class="headerlink" title="执行创建交换链"></a>执行创建交换链</h6><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">D3DApp::CreateSwapChain</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 释放我们将重新创建的先前的交换链。</span></span><br><span class="line">    mSwapChain.<span class="built_in">Reset</span>();</span><br><span class="line"></span><br><span class="line">    DXGI_SWAP_CHAIN_DESC sd;</span><br><span class="line">    sd.BufferDesc.Width = mClientWidth;</span><br><span class="line">    sd.BufferDesc.Height = mClientHeight;</span><br><span class="line">    sd.BufferDesc.RefreshRate.Numerator = <span class="number">60</span>;</span><br><span class="line">    sd.BufferDesc.RefreshRate.Denominator = <span class="number">1</span>;</span><br><span class="line">    sd.BufferDesc.Format = mBackBufferFormat;</span><br><span class="line">    sd.BufferDesc.ScanlineOrdering = DXGI_MODE_SCANLINE_ORDER_UNSPECIFIED;</span><br><span class="line">    sd.BufferDesc.Scaling = DXGI_MODE_SCALING_UNSPECIFIED;</span><br><span class="line">    sd.SampleDesc.Count = m4xMsaaState ? <span class="number">4</span> : <span class="number">1</span>;</span><br><span class="line">    sd.SampleDesc.Quality = m4xMsaaState ? (m4xMsaaQuality - <span class="number">1</span>) : <span class="number">0</span>;</span><br><span class="line">    sd.BufferUsage = DXGI_USAGE_RENDER_TARGET_OUTPUT;</span><br><span class="line">    sd.BufferCount = SwapChainBufferCount;</span><br><span class="line">    sd.OutputWindow = mhMainWnd;</span><br><span class="line">    sd.Windowed = <span class="literal">true</span>;</span><br><span class="line">	sd.SwapEffect = DXGI_SWAP_EFFECT_FLIP_DISCARD;</span><br><span class="line">    sd.Flags = DXGI_SWAP_CHAIN_FLAG_ALLOW_MODE_SWITCH;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Note: 交换链使用队列执行刷新。</span></span><br><span class="line">    <span class="built_in">ThrowIfFailed</span>(mdxgiFactory-&gt;<span class="built_in">CreateSwapChain</span>(</span><br><span class="line">		mCommandQueue.<span class="built_in">Get</span>(),</span><br><span class="line">		&amp;sd, </span><br><span class="line">		mSwapChain.<span class="built_in">GetAddressOf</span>()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="创建描述符堆"><a href="#创建描述符堆" class="headerlink" title="创建描述符堆"></a>创建描述符堆</h5><p>创建描述符堆来存储程序中要用到的<strong>描述符/视图</strong>，本例中需要创建两个描述符堆来存储<code>SwapChainBufferCount</code>个<code>RTV</code> ,另外一个存储1个<code>DSV</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//.h</span></span><br><span class="line">	Microsoft::WRL::ComPtr&lt;ID3D12DescriptorHeap&gt; mRtvHeap;</span><br><span class="line">    Microsoft::WRL::ComPtr&lt;ID3D12DescriptorHeap&gt; mDsvHeap;</span><br><span class="line"><span class="comment">//.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">D3DApp::CreateRtvAndDsvDescriptorHeaps</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    D3D12_DESCRIPTOR_HEAP_DESC rtvHeapDesc;</span><br><span class="line">    rtvHeapDesc.NumDescriptors = SwapChainBufferCount;<span class="comment">//static value=2</span></span><br><span class="line">    rtvHeapDesc.Type = D3D12_DESCRIPTOR_HEAP_TYPE_RTV;</span><br><span class="line">    rtvHeapDesc.Flags = D3D12_DESCRIPTOR_HEAP_FLAG_NONE;</span><br><span class="line">	rtvHeapDesc.NodeMask = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateDescriptorHeap</span>(</span><br><span class="line">        &amp;rtvHeapDesc, <span class="built_in">IID_PPV_ARGS</span>(mRtvHeap.<span class="built_in">GetAddressOf</span>())));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    D3D12_DESCRIPTOR_HEAP_DESC dsvHeapDesc;</span><br><span class="line">    dsvHeapDesc.NumDescriptors = <span class="number">1</span>;</span><br><span class="line">    dsvHeapDesc.Type = D3D12_DESCRIPTOR_HEAP_TYPE_DSV;</span><br><span class="line">    dsvHeapDesc.Flags = D3D12_DESCRIPTOR_HEAP_FLAG_NONE;</span><br><span class="line">	dsvHeapDesc.NodeMask = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateDescriptorHeap</span>(</span><br><span class="line">        &amp;dsvHeapDesc, <span class="built_in">IID_PPV_ARGS</span>(mDsvHeap.<span class="built_in">GetAddressOf</span>())));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建以后需要通过方法来获得描述符的句柄</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">D3D12_CPU_DESCRIPTOR_HANDLE <span class="title">D3DApp::CurrentBackBufferView</span><span class="params">()</span><span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;<span class="comment">//构造函数根据给定的偏移量找到当前后台缓冲区的RTV</span></span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">CD3DX12_CPU_DESCRIPTOR_HANDLE</span>(</span><br><span class="line">		mRtvHeap-&gt;<span class="built_in">GetCPUDescriptorHandleForHeapStart</span>(),<span class="comment">//堆中的首个句柄</span></span><br><span class="line">		mCurrBackBuffer,<span class="comment">//偏移至后台缓冲区描述符句柄的索引</span></span><br><span class="line">		mRtvDescriptorSize);<span class="comment">//描述符所占字节大小</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">D3D12_CPU_DESCRIPTOR_HANDLE <span class="title">D3DApp::DepthStencilView</span><span class="params">()</span><span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> mDsvHeap-&gt;<span class="built_in">GetCPUDescriptorHandleForHeapStart</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="创建渲染目标视图"><a href="#创建渲染目标视图" class="headerlink" title="创建渲染目标视图"></a>创建渲染目标视图</h5><blockquote>
<p>资源不能与渲染流水线中的阶段直接绑定，所以必须先为资源创建视图（描述符），并将其绑定到流水线阶段</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> HRESULT STDMETHODCALLTYPE <span class="title">GetBuffer</span><span class="params">( </span></span></span><br><span class="line"><span class="params"><span class="function">           <span class="comment">/* [in] */</span> UINT Buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">           <span class="comment">/* [annotation][in] */</span> </span></span></span><br><span class="line"><span class="params"><span class="function">           _In_  REFIID riid,</span></span></span><br><span class="line"><span class="params"><span class="function">           <span class="comment">/* [annotation][out][in] */</span> </span></span></span><br><span class="line"><span class="params"><span class="function">           _COM_Outptr_  <span class="keyword">void</span> **ppSurface)</span> </span>= <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<ol>
<li>Buffer:后台缓冲区索引</li>
<li>riid:COM ID</li>
<li>ppSurface:返回<code>ID3D12Resource</code>接口的指针，即后台缓冲区</li>
</ol>
<blockquote>
<p>调用此方法后会增加计数，所以使用后需要释放，需通过ComPtr</p>
</blockquote>
<p>然后获得后台缓冲区创建的渲染目标视图</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> STDMETHODCALLTYPE <span class="title">CreateRenderTargetView</span><span class="params">( </span></span></span><br><span class="line"><span class="params"><span class="function">           _In_opt_  ID3D12Resource *pResource,</span></span></span><br><span class="line"><span class="params"><span class="function">           _In_opt_  <span class="keyword">const</span> D3D12_RENDER_TARGET_VIEW_DESC *pDesc,</span></span></span><br><span class="line"><span class="params"><span class="function">           _In_  D3D12_CPU_DESCRIPTOR_HANDLE DestDescriptor)</span> </span>= <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<ol>
<li>pResource:指定用作渲染目标的资源</li>
<li>pDesc:指向<code>D3D12_RENDER_TARGET_VIEW_DESC</code>数组结构体的指针</li>
<li>DestDescriptor:引用所创建渲染目标视图的描述符句柄</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">CD3DX12_CPU_DESCRIPTOR_HANDLE <span class="title">rtvHeapHandle</span><span class="params">(mRtvHeap-&gt;GetCPUDescriptorHandleForHeapStart())</span></span>;</span><br><span class="line">	<span class="keyword">for</span> (UINT i = <span class="number">0</span>; i &lt; SwapChainBufferCount; i++)</span><br><span class="line">	&#123;</span><br><span class="line">        <span class="comment">//获得交换链中的第 i 个缓冲区</span></span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(mSwapChain-&gt;<span class="built_in">GetBuffer</span>(i, <span class="built_in">IID_PPV_ARGS</span>(&amp;mSwapChainBuffer[i])));</span><br><span class="line">        <span class="comment">//为此缓冲区创建一个RTV</span></span><br><span class="line">		md3dDevice-&gt;<span class="built_in">CreateRenderTargetView</span>(mSwapChainBuffer[i].<span class="built_in">Get</span>(), <span class="literal">nullptr</span>, rtvHeapHandle);</span><br><span class="line">        <span class="comment">//偏移到下一个缓冲区</span></span><br><span class="line">		rtvHeapHandle.<span class="built_in">Offset</span>(<span class="number">1</span>, mRtvDescriptorSize);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<h5 id="创建深度-模板缓冲区及其视图"><a href="#创建深度-模板缓冲区及其视图" class="headerlink" title="创建深度/模板缓冲区及其视图"></a>创建深度/模板缓冲区及其视图</h5><p>因为深度缓冲区就是一种2D纹理，所以我们通过填写<code>D3D12_RESOURCE_DESC</code>结构体来描述纹理资源</p>
<p>再用<code>ID3D12Device::CreateCommittedResource</code>方法来创建它</p>
<ul>
<li>D3D12_RESOURCE_DESC</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">D3D12_RESOURCE_DESC</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">    D3D12_RESOURCE_DIMENSION Dimension;</span><br><span class="line">    UINT64 Alignment;</span><br><span class="line">    UINT64 Width;</span><br><span class="line">    UINT Height;</span><br><span class="line">    UINT16 DepthOrArraySize;</span><br><span class="line">    UINT16 MipLevels;</span><br><span class="line">    DXGI_FORMAT Format;</span><br><span class="line">    DXGI_SAMPLE_DESC SampleDesc;</span><br><span class="line">    D3D12_TEXTURE_LAYOUT Layout;</span><br><span class="line">    D3D12_RESOURCE_FLAGS Flags;</span><br><span class="line">    &#125; 	D3D12_RESOURCE_DESC;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>D3D12_RESOURCE_DIMENSION Dimension：资源的维度</p>
<ol>
<li>```cpp<br>enum D3D12_RESOURCE_DIMENSION<pre><code>&#123;
    D3D12_RESOURCE_DIMENSION_UNKNOWN    = 0,
    D3D12_RESOURCE_DIMENSION_BUFFER    = 1,
    D3D12_RESOURCE_DIMENSION_TEXTURE1D    = 2,
    D3D12_RESOURCE_DIMENSION_TEXTURE2D    = 3,
    D3D12_RESOURCE_DIMENSION_TEXTURE3D    = 4
&#125;     D3D12_RESOURCE_DIMENSION;
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">2. Width:像素单位的纹理宽度。对于缓冲区，此项是占用的字节数</span><br><span class="line"></span><br><span class="line">3. Height:同上</span><br><span class="line"></span><br><span class="line">4. DepthOrArraySize:纹素为单位的纹理深度，或者是纹理数组的大小</span><br><span class="line"></span><br><span class="line">5. MipLevels：mipmap层级的数量</span><br><span class="line"></span><br><span class="line">6. Format:DXGI_FORMAT枚举成员之一</span><br><span class="line"></span><br><span class="line">7. SampleDesc：多重采样级别和每个像素的采样次数</span><br><span class="line"></span><br><span class="line">8. Layout：D3D12_TEXTURE_LAYOUT枚举成员之一，用于指定纹理布局</span><br><span class="line"></span><br><span class="line">9. Flags：杂项标记，对于深度/模板缓冲区资源，设置为`D3D12_RESOURCE_FLAG_ALLOW_DEPTH_STENCIL`</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; `GPU`资源都存储在`堆`中，本质是具有特定属性的`GPU`显存快</span><br><span class="line">&gt;</span><br><span class="line">&gt; `ID3D12Device::CreateCommitedResource`方法根据提供的属性创建一个资源和一个堆，把资源提交到这个堆</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">###### CreateCommittedResource</span><br><span class="line"></span><br><span class="line">```cpp</span><br><span class="line">virtual HRESULT STDMETHODCALLTYPE CreateCommittedResource( </span><br><span class="line">            _In_  const D3D12_HEAP_PROPERTIES *pHeapProperties,//资源提交到的堆的属性，见下</span><br><span class="line">            D3D12_HEAP_FLAGS HeapFlags,//额外标记，一般是D3D12_HEAP_FLAG_NONE</span><br><span class="line">            _In_  const D3D12_RESOURCE_DESC *pDesc,//描述待创建的资源</span><br><span class="line">            D3D12_RESOURCE_STATES InitialResourceState,//此参数来设置资源的初始状态</span><br><span class="line">            _In_opt_  const D3D12_CLEAR_VALUE *pOptimizedClearValue,//清楚资源的优化值，不需要就选择nullptr</span><br><span class="line">            REFIID riidResource,//COM ID</span><br><span class="line">            _COM_Outptr_opt_  void **ppvResource) = 0;//新创建的资源，指向ID3D12Resource的指针</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ol>
<h6 id="D3D12-HEAP-PROPERTIES"><a href="#D3D12-HEAP-PROPERTIES" class="headerlink" title="D3D12_HEAP_PROPERTIES"></a>D3D12_HEAP_PROPERTIES</h6><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">D3D12_HEAP_PROPERTIES</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">    D3D12_HEAP_TYPE Type;</span><br><span class="line">    D3D12_CPU_PAGE_PROPERTY CPUPageProperty;</span><br><span class="line">    D3D12_MEMORY_POOL MemoryPoolPreference;</span><br><span class="line">    UINT CreationNodeMask;</span><br><span class="line">    UINT VisibleNodeMask;</span><br><span class="line">    &#125; 	D3D12_HEAP_PROPERTIES;</span><br></pre></td></tr></table></figure>

<h6 id="D3D12-HEAP-TYPE"><a href="#D3D12-HEAP-TYPE" class="headerlink" title="D3D12_HEAP_TYPE"></a>D3D12_HEAP_TYPE</h6><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">D3D12_HEAP_TYPE</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        D3D12_HEAP_TYPE_DEFAULT	= <span class="number">1</span>,<span class="comment">//默认堆</span></span><br><span class="line">        D3D12_HEAP_TYPE_UPLOAD	= <span class="number">2</span>,<span class="comment">//上传堆</span></span><br><span class="line">        D3D12_HEAP_TYPE_READBACK	= <span class="number">3</span>,<span class="comment">//回读堆</span></span><br><span class="line">        D3D12_HEAP_TYPE_CUSTOM	= <span class="number">4</span><span class="comment">//高级场景使用</span></span><br><span class="line">    &#125; 	D3D12_HEAP_TYPE;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h6 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h6><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// Create the depth/stencil buffer and view.</span></span><br><span class="line">  D3D12_RESOURCE_DESC depthStencilDesc;</span><br><span class="line">  depthStencilDesc.Dimension = D3D12_RESOURCE_DIMENSION_TEXTURE2D;</span><br><span class="line">  depthStencilDesc.Alignment = <span class="number">0</span>;</span><br><span class="line">  depthStencilDesc.Width = mClientWidth;</span><br><span class="line">  depthStencilDesc.Height = mClientHeight;</span><br><span class="line">  depthStencilDesc.DepthOrArraySize = <span class="number">1</span>;</span><br><span class="line">  depthStencilDesc.MipLevels = <span class="number">1</span>;</span><br><span class="line">  depthStencilDesc.Format = mDepthStencilFormat;</span><br><span class="line">  depthStencilDesc.SampleDesc.Count = m4xMsaaState ? <span class="number">4</span> : <span class="number">1</span>;</span><br><span class="line">  depthStencilDesc.SampleDesc.Quality = m4xMsaaState ? (m4xMsaaQuality - <span class="number">1</span>) : <span class="number">0</span>;</span><br><span class="line">  depthStencilDesc.Layout = D3D12_TEXTURE_LAYOUT_UNKNOWN;</span><br><span class="line">  depthStencilDesc.Flags = D3D12_RESOURCE_FLAG_ALLOW_DEPTH_STENCIL;</span><br><span class="line"></span><br><span class="line">  D3D12_CLEAR_VALUE optClear;</span><br><span class="line">  optClear.Format = mDepthStencilFormat;</span><br><span class="line">  optClear.DepthStencil.Depth = <span class="number">1.0f</span>;</span><br><span class="line">  optClear.DepthStencil.Stencil = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateCommittedResource</span>(</span><br><span class="line">      &amp;<span class="built_in">CD3DX12_HEAP_PROPERTIES</span>(D3D12_HEAP_TYPE_DEFAULT),</span><br><span class="line">D3D12_HEAP_FLAG_NONE,</span><br><span class="line">      &amp;depthStencilDesc,</span><br><span class="line">D3D12_RESOURCE_STATE_COMMON,</span><br><span class="line">      &amp;optClear,</span><br><span class="line">      <span class="built_in">IID_PPV_ARGS</span>(mDepthStencilBuffer.<span class="built_in">GetAddressOf</span>())));</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// 使用资源格式将描述符创建为整个资源的MIP级别0。</span></span><br><span class="line">   md3dDevice-&gt;<span class="built_in">CreateDepthStencilView</span>(mDepthStencilBuffer.<span class="built_in">Get</span>(), <span class="literal">nullptr</span>, <span class="built_in">DepthStencilView</span>());</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 将资源从其初始状态转换为深度缓冲区。</span></span><br><span class="line">mCommandList-&gt;<span class="built_in">ResourceBarrier</span>(<span class="number">1</span>, &amp;CD3DX12_RESOURCE_BARRIER::<span class="built_in">Transition</span>(mDepthStencilBuffer.<span class="built_in">Get</span>(),</span><br><span class="line">	D3D12_RESOURCE_STATE_COMMON, D3D12_RESOURCE_STATE_DEPTH_WRITE));</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h5 id="设置视口"><a href="#设置视口" class="headerlink" title="设置视口"></a>设置视口</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">D3D12_VIEWPORT mScreenViewport; </span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">D3D12_VIEWPORT</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">    FLOAT TopLeftX;</span><br><span class="line">    FLOAT TopLeftY;</span><br><span class="line">    FLOAT Width;</span><br><span class="line">    FLOAT Height;</span><br><span class="line">    FLOAT MinDepth;<span class="comment">//负责从区间0-1转化为MinDepth-MaxDepth</span></span><br><span class="line">    FLOAT MaxDepth;</span><br><span class="line">    &#125; 	D3D12_VIEWPORT;</span><br></pre></td></tr></table></figure>



<p>填好结构体以后通过函数<code>ID3D12GraphicsCommandList::RSSetViewports</code>方法来设置视口</p>
<h6 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h6><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mScreenViewport.TopLeftX = <span class="number">0</span>;</span><br><span class="line">	mScreenViewport.TopLeftY = <span class="number">0</span>;</span><br><span class="line">	mScreenViewport.Width    = <span class="keyword">static_cast</span>&lt;<span class="keyword">float</span>&gt;(mClientWidth);</span><br><span class="line">	mScreenViewport.Height   = <span class="keyword">static_cast</span>&lt;<span class="keyword">float</span>&gt;(mClientHeight);</span><br><span class="line">	mScreenViewport.MinDepth = <span class="number">0.0f</span>;</span><br><span class="line">	mScreenViewport.MaxDepth = <span class="number">1.0f</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> mCommandList-&gt;<span class="built_in">RSSetViewports</span>(<span class="number">1</span>, &amp;mScreenViewport);</span><br></pre></td></tr></table></figure>



<blockquote>
<p>不能为同一个渲染目标指定多个视口</p>
<p>而多个视口则是一种用于对多个渲染目标同时进行渲染的高级技术</p>
<p>命令列表重置，视口也要重置</p>
</blockquote>
<h5 id="设置裁剪矩形"><a href="#设置裁剪矩形" class="headerlink" title="设置裁剪矩形"></a>设置裁剪矩形</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tagRECT</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    LONG    left;</span><br><span class="line">    LONG    top;</span><br><span class="line">    LONG    right;</span><br><span class="line">    LONG    bottom;</span><br><span class="line">&#125; RECT, *PRECT, NEAR *NPRECT, FAR *LPRECT;</span><br></pre></td></tr></table></figure>



<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mScissorRect = &#123; <span class="number">0</span>, <span class="number">0</span>, mClientWidth, mClientHeight &#125;;</span><br><span class="line"></span><br><span class="line">mCommandList-&gt;<span class="built_in">RSSetScissorRects</span>(<span class="number">1</span>, &amp;mScissorRect);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>不能为同一个渲染目标指定多个裁剪矩形。</p>
<p>多裁剪矩形是以各种用于同时对多个渲染目标进行渲染的高级技术</p>
<p>裁剪矩形需要随着命令列表重置而重置</p>
</blockquote>
<h3 id="计时与动画"><a href="#计时与动画" class="headerlink" title="计时与动画"></a>计时与动画</h3><h5 id="性能计时器"><a href="#性能计时器" class="headerlink" title="性能计时器"></a>性能计时器</h5><p><code>QueryPerformanceCounter</code>函数来活得性能计时器测量的当前时刻值</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">__int64 countsPerSec;</span><br><span class="line">	<span class="built_in">QueryPerformanceFrequency</span>((LARGE_INTEGER*)&amp;countsPerSec);</span><br><span class="line">	mSecondsPerCount = <span class="number">1.0</span> / (<span class="keyword">double</span>)countsPerSec;</span><br></pre></td></tr></table></figure>

<p>通过如下方式转换为秒</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">valueInSecs=valueInCounts * mSecondsPercount;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>调用2次<code>QueryPerformanceCounter</code>函数得到两个时间戳的相对插值</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__int64 A;</span><br><span class="line">	<span class="built_in">QueryPerformanceFrequency</span>((LARGE_INTEGER*)&amp;A);</span><br><span class="line">__int64 B;</span><br><span class="line">	<span class="built_in">QueryPerformanceFrequency</span>((LARGE_INTEGER*)&amp;B);</span><br></pre></td></tr></table></figure>

<p><code>B-A</code>即可获得执行期间的计数值，或者<code>(B-1)*mSecondsPerCount</code>获得代码运行期间所花费的秒数</p>
<h5 id="游戏计时器类"><a href="#游戏计时器类" class="headerlink" title="游戏计时器类"></a>游戏计时器类</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GameTimer</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">GameTimer</span>();</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">float</span> <span class="title">TotalTime</span><span class="params">()</span><span class="keyword">const</span></span>; <span class="comment">//秒为单位</span></span><br><span class="line">	<span class="function"><span class="keyword">float</span> <span class="title">DeltaTime</span><span class="params">()</span><span class="keyword">const</span></span>; <span class="comment">//秒为单位</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Reset</span><span class="params">()</span></span>; <span class="comment">// 开始循环之前调用</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Start</span><span class="params">()</span></span>; <span class="comment">// 接触计时器暂停时调用</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Stop</span><span class="params">()</span></span>;  <span class="comment">// 暂停计时器调用</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Tick</span><span class="params">()</span></span>;  <span class="comment">//每帧都要调用</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="keyword">double</span> mSecondsPerCount;</span><br><span class="line">	<span class="keyword">double</span> mDeltaTime;</span><br><span class="line"></span><br><span class="line">	__int64 mBaseTime;</span><br><span class="line">	__int64 mPausedTime;</span><br><span class="line">	__int64 mStopTime;</span><br><span class="line">	__int64 mPrevTime;</span><br><span class="line">	__int64 mCurrTime;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">bool</span> mStopped;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="帧与帧之间的时间间隔"><a href="#帧与帧之间的时间间隔" class="headerlink" title="帧与帧之间的时间间隔"></a>帧与帧之间的时间间隔</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">GameTimer::Tick</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>( mStopped )</span><br><span class="line">	&#123;</span><br><span class="line">		mDeltaTime = <span class="number">0.0</span>;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 获得本帧开始的时刻</span></span><br><span class="line">	__int64 currTime;</span><br><span class="line">	<span class="built_in">QueryPerformanceCounter</span>((LARGE_INTEGER*)&amp;currTime);</span><br><span class="line">	mCurrTime = currTime;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 两帧的时间差</span></span><br><span class="line">	mDeltaTime = (mCurrTime - mPrevTime)*mSecondsPerCount;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 把当前时间设置为下一次的开始时间</span></span><br><span class="line">	mPrevTime = mCurrTime;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//保证时间差为非负值；</span></span><br><span class="line">    <span class="comment">//在处理器处于节能模式或者计算两次时间差的过程中切换到了另一个处理器可能会得到负值</span></span><br><span class="line">	<span class="keyword">if</span>(mDeltaTime &lt; <span class="number">0.0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		mDeltaTime = <span class="number">0.0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>次<code>Tick</code>函数被调用在<code>D3DApp::Run</code>函数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">D3DApp::Run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	MSG msg = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"> </span><br><span class="line">	mTimer.<span class="built_in">Reset</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span>(msg.message != WM_QUIT)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// If there are Window messages then process them.</span></span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">PeekMessage</span>( &amp;msg, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, PM_REMOVE ))</span><br><span class="line">		&#123;</span><br><span class="line">            <span class="built_in">TranslateMessage</span>( &amp;msg );</span><br><span class="line">            <span class="built_in">DispatchMessage</span>( &amp;msg );</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// Otherwise, do animation/game stuff.</span></span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">        &#123;	</span><br><span class="line">			mTimer.<span class="built_in">Tick</span>();</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span>( !mAppPaused )</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">CalculateFrameStats</span>();</span><br><span class="line">				<span class="built_in">Update</span>(mTimer);	</span><br><span class="line">                <span class="built_in">Draw</span>(mTimer);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">Sleep</span>(<span class="number">100</span>);</span><br><span class="line">			&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">int</span>)msg.wParam;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Reset</code>方法初始化第一帧的数据，因为第一帧没有之前的帧</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">GameTimer::Reset</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	__int64 currTime;</span><br><span class="line">	<span class="built_in">QueryPerformanceCounter</span>((LARGE_INTEGER*)&amp;currTime);</span><br><span class="line"></span><br><span class="line">	mBaseTime = currTime;</span><br><span class="line">	mPrevTime = currTime;</span><br><span class="line">	mStopTime = <span class="number">0</span>;</span><br><span class="line">	mStopped  = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="总时间"><a href="#总时间" class="headerlink" title="总时间"></a>总时间</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">GameTimer::TotalTime</span><span class="params">()</span><span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果我们停止了，请勿计算自停止以来经过的时间。</span></span><br><span class="line">    <span class="comment">//此外，如果我们之前已经停顿了一下</span></span><br><span class="line">    <span class="comment">// mStopTime-mBaseTime包含暂停时间，我们不想计算。</span></span><br><span class="line">    <span class="comment">//要纠正此问题，我们可以从mStopTime中减去暂停时间： </span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">//                     |&lt;--paused time--&gt;|</span></span><br><span class="line">	<span class="comment">// ----*---------------*-----------------*------------*------------*------&gt; time</span></span><br><span class="line">	<span class="comment">//  mBaseTime       mStopTime        startTime     mStopTime    mCurrTime</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>( mStopped )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> (<span class="keyword">float</span>)(((mStopTime - mPausedTime)-mBaseTime)*mSecondsPerCount);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//距离mCurrTime-mBaseTime包括暂停时间，</span></span><br><span class="line">    <span class="comment">//我们不想计算。 要纠正这一点，我们可以减去</span></span><br><span class="line">    <span class="comment">//从mCurrTime暂停的时间： </span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">//  (mCurrTime - mPausedTime) - mBaseTime </span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">//                     |&lt;--paused time--&gt;|</span></span><br><span class="line">	<span class="comment">// ----*---------------*-----------------*------------*------&gt; time</span></span><br><span class="line">	<span class="comment">//  mBaseTime       mStopTime        startTime     mCurrTime</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in"><span class="keyword">return</span></span> (<span class="keyword">float</span>)(((mCurrTime-mPausedTime)-mBaseTime)*mSecondsPerCount);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h3 id="应用程序框架示例"><a href="#应用程序框架示例" class="headerlink" title="应用程序框架示例"></a>应用程序框架示例</h3><p>自己模仿框架的代码</p>
<h6 id="DXApp-h"><a href="#DXApp-h" class="headerlink" title="DXApp.h"></a>DXApp.h</h6><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;../Common/d3dUtil.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;../Common/d3dx12.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;../Common/GameTimer.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(DEBUG) || defined(_DEBUG)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _CRTDBG_MAP_ALLOC</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;crtdbg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dxgiformat.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Link necessary d3d12 libraries.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib,<span class="meta-string">&quot;d3dcompiler.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">&quot;D3D12.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">&quot;dxgi.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DXApp</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">DXApp</span>(HINSTANCE nInstance);</span><br><span class="line">	<span class="built_in">DXApp</span>(<span class="keyword">const</span> DXApp&amp; rhs) = <span class="keyword">delete</span>;</span><br><span class="line">	DXApp&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> DXApp&amp; rhs) = <span class="keyword">delete</span>;</span><br><span class="line">	<span class="keyword">virtual</span> ~<span class="built_in">DXApp</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnResize</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">Initialize</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">CreateRtvAndDsvDescriptorHeaps</span><span class="params">()</span></span>;<span class="comment">//创建描述符堆</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Update</span><span class="params">(<span class="keyword">const</span> GameTimer&amp; gt)</span> </span>= <span class="number">0</span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Draw</span><span class="params">(<span class="keyword">const</span> GameTimer&amp; gt)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">InitMainWindow</span><span class="params">()</span></span>;<span class="comment">//初始化窗口</span></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">InitDirect3D</span><span class="params">()</span></span>;<span class="comment">//初始化DX</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">FlushCommandQueue</span><span class="params">()</span></span>;<span class="comment">//齐平命令队列</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">CreateSwapChain</span><span class="params">()</span></span>;<span class="comment">//创建交换链</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">CreateCommandObjects</span><span class="params">()</span></span>;<span class="comment">//创建命令队列、命令适配器、命令列表</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="function">ID3D12Resource* <span class="title">CurrentBackBuffer</span><span class="params">()</span><span class="keyword">const</span></span>;</span><br><span class="line">	<span class="function">D3D12_CPU_DESCRIPTOR_HANDLE <span class="title">CurrentBackBufferView</span><span class="params">()</span><span class="keyword">const</span></span>;</span><br><span class="line">	<span class="function">D3D12_CPU_DESCRIPTOR_HANDLE <span class="title">DepthStencilView</span><span class="params">()</span><span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">LogAdapters</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">LogAdapterOutputs</span><span class="params">(IDXGIAdapter* adapter)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">LogOutputDisplayModes</span><span class="params">(IDXGIOutput* output, DXGI_FORMAT format)</span></span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">static</span> DXApp* <span class="title">GetApp</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function">HINSTANCE <span class="title">AppInst</span><span class="params">()</span><span class="keyword">const</span></span>;<span class="comment">//得到应用程序实例</span></span><br><span class="line">	<span class="function">HWND      <span class="title">MainWnd</span><span class="params">()</span><span class="keyword">const</span></span>;<span class="comment">//得到窗口</span></span><br><span class="line">	<span class="function"><span class="keyword">float</span>     <span class="title">AspectRatio</span><span class="params">()</span><span class="keyword">const</span></span>;<span class="comment">//长宽比</span></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">Get4xMsaaState</span><span class="params">()</span><span class="keyword">const</span></span>;<span class="comment">//4XMSAA开启与否</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Set4xMsaaState</span><span class="params">(<span class="keyword">bool</span> value)</span></span>;<span class="comment">//设置4XMSAA</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">Run</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">CalculateFrameStats</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	HWND hwnd; //窗口句柄 </span></span><br><span class="line"><span class="comment">	UINT message; //消息常量标识符 </span></span><br><span class="line"><span class="comment">	WPARAM wParam; //32位消息的特定附加信息,具体表示什么处决于message </span></span><br><span class="line"><span class="comment">	LPARAM lParam; //32位消息的特定附加信息,具体表示什么处决于message </span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> LRESULT <span class="title">MsgProc</span><span class="params">(HWND hwnd, UINT msg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//鼠标输入</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnMouseDown</span><span class="params">(WPARAM btnState, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnMouseUp</span><span class="params">(WPARAM btnState, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnMouseMove</span><span class="params">(WPARAM btnState, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line"></span><br><span class="line">	<span class="keyword">static</span> DXApp* mApp;</span><br><span class="line"></span><br><span class="line">	HINSTANCE mhAppInst = <span class="literal">nullptr</span>; <span class="comment">// 应用程序实例句柄</span></span><br><span class="line">	HWND      mhMainWnd = <span class="literal">nullptr</span>; <span class="comment">// 主窗口句柄</span></span><br><span class="line">	<span class="keyword">bool</span>      mAppPaused = <span class="literal">false</span>;  <span class="comment">// 应用程序是否已暂停？</span></span><br><span class="line">	<span class="keyword">bool</span>      mMinimized = <span class="literal">false</span>;  <span class="comment">// 将应用程序最小化?</span></span><br><span class="line">	<span class="keyword">bool</span>      mMaximized = <span class="literal">false</span>;  <span class="comment">// 应用程序是否已最大化？</span></span><br><span class="line">	<span class="keyword">bool</span>      mResizing = <span class="literal">false</span>;   <span class="comment">// 是否拖动了大小调整栏？</span></span><br><span class="line">	<span class="keyword">bool</span>      mFullscreenState = <span class="literal">false</span>;<span class="comment">// 启用全屏</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 是否启用 4X MSAA (?.1.8).  The default is false.</span></span><br><span class="line">	<span class="keyword">bool</span>      m4xMsaaState = <span class="literal">false</span>;    <span class="comment">// 启用 4X MSAA </span></span><br><span class="line">	UINT      m4xMsaaQuality = <span class="number">0</span>;      <span class="comment">// 4倍MSAA的质量水平</span></span><br><span class="line"></span><br><span class="line">	GameTimer mTimer;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//COM</span></span><br><span class="line">	Microsoft::WRL::ComPtr&lt;ID3D12Device&gt; md3dDevice; <span class="comment">//设备接口</span></span><br><span class="line">	Microsoft::WRL::ComPtr&lt;IDXGIFactory4&gt; mdxgiFactory;</span><br><span class="line">	Microsoft::WRL::ComPtr&lt;IDXGISwapChain&gt; mSwapChain;<span class="comment">//交换链</span></span><br><span class="line"></span><br><span class="line">	Microsoft::WRL::ComPtr&lt;ID3D12Fence&gt; mFence;<span class="comment">//围栏</span></span><br><span class="line">	UINT64 mCurrentFence = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	Microsoft::WRL::ComPtr&lt;ID3D12CommandQueue&gt; mCommandQueue;<span class="comment">//命令队列</span></span><br><span class="line">	Microsoft::WRL::ComPtr&lt;ID3D12CommandAllocator&gt; mDirectCmdListAlloc;<span class="comment">//适配器</span></span><br><span class="line">	Microsoft::WRL::ComPtr&lt;ID3D12GraphicsCommandList&gt; mCommandList;<span class="comment">//列表</span></span><br><span class="line">	<span class="comment">//描述符</span></span><br><span class="line">	UINT mRtvDescriptorSize = <span class="number">0</span>;</span><br><span class="line">	UINT mDsvDescriptorSize = <span class="number">0</span>;</span><br><span class="line">	UINT mCbvSrvUavDescriptorSize = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> SwapChainBufferCount = <span class="number">2</span>;<span class="comment">//双重缓冲</span></span><br><span class="line">	<span class="keyword">int</span> mCurrBackBuffer = <span class="number">0</span>;</span><br><span class="line">	Microsoft::WRL::ComPtr&lt;ID3D12Resource&gt; mSwapChainBuffer[SwapChainBufferCount];<span class="comment">//交换链缓冲区数组</span></span><br><span class="line">	Microsoft::WRL::ComPtr&lt;ID3D12Resource&gt; mDepthStencilBuffer;<span class="comment">//深度模板缓冲区</span></span><br><span class="line">	</span><br><span class="line">	Microsoft::WRL::ComPtr&lt;ID3D12DescriptorHeap&gt; mRtvHeap;<span class="comment">//RTV描述符堆</span></span><br><span class="line">	Microsoft::WRL::ComPtr&lt;ID3D12DescriptorHeap&gt; mDsvHeap;<span class="comment">//DSV描述符堆</span></span><br><span class="line"></span><br><span class="line">	std::wstring mMainWndCaption = <span class="string">L&quot;DX App&quot;</span>;</span><br><span class="line">	D3D_DRIVER_TYPE md3dDriverType = D3D_DRIVER_TYPE_HARDWARE;</span><br><span class="line">	DXGI_FORMAT mBackBufferFormat = DXGI_FORMAT_R8G8B8A8_UNORM;</span><br><span class="line">	DXGI_FORMAT mDepthStencilFormat = DXGI_FORMAT_D24_UNORM_S8_UINT;</span><br><span class="line"></span><br><span class="line">	D3D12_VIEWPORT mScreenViewport;<span class="comment">//视口</span></span><br><span class="line">	D3D12_RECT mScissorRect;<span class="comment">//裁剪</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> mClientWidth = <span class="number">800</span>;</span><br><span class="line">	<span class="keyword">int</span> mClientHeight = <span class="number">600</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h6 id="DXApp-cpp"><a href="#DXApp-cpp" class="headerlink" title="DXApp.cpp"></a>DXApp.cpp</h6><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;DXApp.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;WindowsX.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;winuser.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dxgi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> Microsoft::WRL::ComPtr;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> DirectX;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DXApp* DXApp::mApp = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">LRESULT CALLBACK</span></span><br><span class="line"><span class="function"><span class="title">MainWndProc</span><span class="params">(HWND hwnd, UINT msg, WPARAM wParam, LPARAM lParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//cout &lt;&lt; &quot;test&quot;;</span></span><br><span class="line">	<span class="keyword">return</span> DXApp::<span class="built_in">GetApp</span>()-&gt;<span class="built_in">MsgProc</span>(hwnd, msg, wParam, lParam);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DXApp::<span class="built_in">DXApp</span>(HINSTANCE nInstance):<span class="built_in">mhAppInst</span>(nInstance)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">assert</span>(mApp == <span class="literal">nullptr</span>);</span><br><span class="line">	mApp = <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DXApp::~<span class="built_in">DXApp</span>()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (mhAppInst != <span class="literal">nullptr</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">FlushCommandQueue</span>();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DXApp::OnResize</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">assert</span>(md3dDevice);</span><br><span class="line">	<span class="built_in">assert</span>(mSwapChain);</span><br><span class="line">	<span class="built_in">assert</span>(mDirectCmdListAlloc);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">FlushCommandQueue</span>();</span><br><span class="line"></span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(mCommandList-&gt;<span class="built_in">Reset</span>(mDirectCmdListAlloc.<span class="built_in">Get</span>(),<span class="literal">nullptr</span>));</span><br><span class="line"></span><br><span class="line">	<span class="comment">//释放我们将重新创建的先前资源。</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;SwapChainBufferCount;++i)</span><br><span class="line">	&#123;</span><br><span class="line">		mSwapChainBuffer[i].<span class="built_in">Reset</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	mDepthStencilBuffer.<span class="built_in">Reset</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">//调整交换链的大小。</span></span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(mSwapChain-&gt;<span class="built_in">ResizeBuffers</span>(</span><br><span class="line">	SwapChainBufferCount,</span><br><span class="line">	mClientWidth,</span><br><span class="line">	mClientHeight,</span><br><span class="line">	mBackBufferFormat,</span><br><span class="line">	DXGI_SWAP_CHAIN_FLAG_ALLOW_MODE_SWITCH));</span><br><span class="line"></span><br><span class="line">	mCurrBackBuffer=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function">CD3DX12_CPU_DESCRIPTOR_HANDLE <span class="title">rtvHeapHandle</span><span class="params">(mRtvHeap-&gt;GetCPUDescriptorHandleForHeapStart())</span></span>;</span><br><span class="line">	<span class="keyword">for</span> (UINT i = <span class="number">0</span>; i &lt; SwapChainBufferCount; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//构造函数根据给定的偏移量找到当前后台缓冲区的RTV</span></span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(mSwapChain-&gt;<span class="built_in">GetBuffer</span>(i, <span class="built_in">IID_PPV_ARGS</span>(&amp;mSwapChainBuffer[i])));</span><br><span class="line">		md3dDevice-&gt;<span class="built_in">CreateRenderTargetView</span>(mSwapChainBuffer[i].<span class="built_in">Get</span>(), <span class="literal">nullptr</span>, rtvHeapHandle);<span class="comment">//堆中的首个句柄</span></span><br><span class="line">		rtvHeapHandle.<span class="built_in">Offset</span>(<span class="number">1</span>, mRtvDescriptorSize);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//创建深度/模板缓冲区和视口</span></span><br><span class="line">	D3D12_RESOURCE_DESC depthStencilDesc;</span><br><span class="line">	depthStencilDesc.Dimension= D3D12_RESOURCE_DIMENSION_TEXTURE2D;</span><br><span class="line">	depthStencilDesc.Alignment=<span class="number">0</span>;</span><br><span class="line">	depthStencilDesc.Width=mClientWidth;</span><br><span class="line">	depthStencilDesc.Height=mClientHeight;</span><br><span class="line">	depthStencilDesc.DepthOrArraySize=<span class="number">1</span>;</span><br><span class="line">	depthStencilDesc.MipLevels=<span class="number">1</span>;</span><br><span class="line">	depthStencilDesc.Format=mDepthStencilFormat;</span><br><span class="line">	depthStencilDesc.SampleDesc.Count=m4xMsaaState?<span class="number">4</span>:<span class="number">1</span>;</span><br><span class="line">	depthStencilDesc.SampleDesc.Quality=m4xMsaaState?(m4xMsaaQuality<span class="number">-1</span>):<span class="number">0</span>;</span><br><span class="line">	depthStencilDesc.Layout=D3D12_TEXTURE_LAYOUT_UNKNOWN;</span><br><span class="line">	depthStencilDesc.Flags=D3D12_RESOURCE_FLAG_ALLOW_DEPTH_STENCIL;</span><br><span class="line"></span><br><span class="line">	D3D12_CLEAR_VALUE optClear;</span><br><span class="line">	optClear.Format=mDepthStencilFormat;</span><br><span class="line">	optClear.DepthStencil.Depth=<span class="number">1.0f</span>;</span><br><span class="line">	optClear.DepthStencil.Stencil=<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateCommittedResource</span>(</span><br><span class="line">		&amp;<span class="built_in">CD3DX12_HEAP_PROPERTIES</span>(D3D12_HEAP_TYPE_DEFAULT),</span><br><span class="line">		D3D12_HEAP_FLAG_NONE,</span><br><span class="line">		&amp;depthStencilDesc,</span><br><span class="line">		D3D12_RESOURCE_STATE_COMMON,</span><br><span class="line">		&amp;optClear,</span><br><span class="line">		<span class="built_in">IID_PPV_ARGS</span>(mDepthStencilBuffer.<span class="built_in">GetAddressOf</span>())));</span><br><span class="line"></span><br><span class="line">		<span class="comment">//使用资源的格式将描述符创建为整个资源的MIP级别0。</span></span><br><span class="line">	md3dDevice-&gt;<span class="built_in">CreateDepthStencilView</span>(mDepthStencilBuffer.<span class="built_in">Get</span>(),<span class="literal">nullptr</span>, <span class="built_in">DepthStencilView</span>());</span><br><span class="line">	<span class="comment">//将资源从其初始状态转换为深度缓冲区。</span></span><br><span class="line">	mCommandList-&gt;<span class="built_in">ResourceBarrier</span>(<span class="number">1</span>,&amp;CD3DX12_RESOURCE_BARRIER::<span class="built_in">Transition</span>(mDepthStencilBuffer.<span class="built_in">Get</span>(),D3D12_RESOURCE_STATE_COMMON,D3D12_RESOURCE_STATE_DEPTH_WRITE));</span><br><span class="line">	<span class="comment">//执行resize命令</span></span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(mCommandList-&gt;<span class="built_in">Close</span>());</span><br><span class="line">	ID3D12CommandList* cmdsLists[]=&#123;mCommandList.<span class="built_in">Get</span>()&#125;;</span><br><span class="line">	mCommandQueue-&gt;<span class="built_in">ExecuteCommandLists</span>(_countof(cmdsLists),cmdsLists);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//等待到resize完成</span></span><br><span class="line">	<span class="built_in">FlushCommandQueue</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//更新视口变换以覆盖客户区域。</span></span><br><span class="line">	mScreenViewport.TopLeftX = <span class="number">0</span>;</span><br><span class="line">	mScreenViewport.TopLeftY = <span class="number">0</span>;</span><br><span class="line">	mScreenViewport.Width = <span class="keyword">static_cast</span>&lt;<span class="keyword">float</span>&gt;(mClientWidth);</span><br><span class="line">	mScreenViewport.Height = <span class="keyword">static_cast</span>&lt;<span class="keyword">float</span>&gt;(mClientHeight);</span><br><span class="line">	mScreenViewport.MinDepth = <span class="number">0.0f</span>;</span><br><span class="line">	mScreenViewport.MaxDepth = <span class="number">1.0f</span>;</span><br><span class="line"></span><br><span class="line">	mScissorRect=&#123;<span class="number">0</span>,<span class="number">0</span>,mClientWidth,mClientHeight&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">DXApp::Initialize</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">InitMainWindow</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">InitDirect3D</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">OnResize</span>();</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DXApp::CreateRtvAndDsvDescriptorHeaps</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	D3D12_DESCRIPTOR_HEAP_DESC rtvHeapDesc;</span><br><span class="line">	rtvHeapDesc.NumDescriptors=SwapChainBufferCount;</span><br><span class="line">	rtvHeapDesc.Type=D3D12_DESCRIPTOR_HEAP_TYPE_RTV;</span><br><span class="line">	rtvHeapDesc.Flags=D3D12_DESCRIPTOR_HEAP_FLAG_NONE;</span><br><span class="line">	rtvHeapDesc.NodeMask=<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateDescriptorHeap</span>(&amp;rtvHeapDesc,<span class="built_in">IID_PPV_ARGS</span>(mRtvHeap.<span class="built_in">GetAddressOf</span>())));</span><br><span class="line"></span><br><span class="line">	D3D12_DESCRIPTOR_HEAP_DESC dsvHeapDesc;</span><br><span class="line">	dsvHeapDesc.NumDescriptors = SwapChainBufferCount;</span><br><span class="line">	dsvHeapDesc.Type = D3D12_DESCRIPTOR_HEAP_TYPE_DSV;</span><br><span class="line">	dsvHeapDesc.Flags = D3D12_DESCRIPTOR_HEAP_FLAG_NONE;</span><br><span class="line">	dsvHeapDesc.NodeMask = <span class="number">0</span>;</span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateDescriptorHeap</span>(&amp;dsvHeapDesc, <span class="built_in">IID_PPV_ARGS</span>(mDsvHeap.<span class="built_in">GetAddressOf</span>())));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">DXApp::InitMainWindow</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	WNDCLASS wc;</span><br><span class="line">	wc.style = CS_HREDRAW | CS_VREDRAW;</span><br><span class="line">	wc.lpfnWndProc = MainWndProc;</span><br><span class="line">	wc.cbClsExtra = <span class="number">0</span>;</span><br><span class="line">	wc.cbWndExtra = <span class="number">0</span>;</span><br><span class="line">	wc.hInstance = mhAppInst;</span><br><span class="line">	wc.hIcon = <span class="built_in">LoadIcon</span>(<span class="number">0</span>, IDI_APPLICATION);</span><br><span class="line">	wc.hCursor = <span class="built_in">LoadCursor</span>(<span class="number">0</span>, IDC_ARROW);</span><br><span class="line">	wc.hbrBackground = (HBRUSH)<span class="built_in">GetStockObject</span>(NULL_BRUSH);</span><br><span class="line">	wc.lpszMenuName = <span class="number">0</span>;</span><br><span class="line">	wc.lpszClassName = <span class="string">L&quot;MainWnd&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">RegisterClass</span>(&amp;wc))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">MessageBox</span>(<span class="number">0</span>, <span class="string">L&quot;RegisterClass Failed.&quot;</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Compute window rectangle dimensions based on requested client area dimensions.</span></span><br><span class="line">	RECT R = &#123; <span class="number">0</span>, <span class="number">0</span>, mClientWidth, mClientHeight &#125;;</span><br><span class="line">	<span class="built_in">AdjustWindowRect</span>(&amp;R, WS_OVERLAPPEDWINDOW, <span class="literal">false</span>);</span><br><span class="line">	<span class="keyword">int</span> width = R.right - R.left;</span><br><span class="line">	<span class="keyword">int</span> height = R.bottom - R.top;</span><br><span class="line"></span><br><span class="line">	mhMainWnd = <span class="built_in">CreateWindow</span>(<span class="string">L&quot;MainWnd&quot;</span>, mMainWndCaption.<span class="built_in">c_str</span>(),</span><br><span class="line">		WS_OVERLAPPEDWINDOW, CW_USEDEFAULT, CW_USEDEFAULT, width, height, <span class="number">0</span>, <span class="number">0</span>, mhAppInst, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (!mhMainWnd)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">MessageBox</span>(<span class="number">0</span>, <span class="string">L&quot;CreateWindow Failed.&quot;</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">ShowWindow</span>(mhMainWnd, SW_SHOW);</span><br><span class="line">	<span class="built_in">UpdateWindow</span>(mhMainWnd);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">DXApp::InitDirect3D</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//	&#123;</span></span><br><span class="line"><span class="comment">//#if defined(DEBUG) || defined(_DEBUG) </span></span><br><span class="line"><span class="comment">//		// Enable the D3D12 debug layer.</span></span><br><span class="line"><span class="comment">//		&#123;</span></span><br><span class="line"><span class="comment">//			ComPtr&lt;ID3D12Debug&gt; debugController;</span></span><br><span class="line"><span class="comment">//			ThrowIfFailed(D3D12GetDebugInterface(IID_PPV_ARGS(&amp;debugController)));</span></span><br><span class="line"><span class="comment">//			debugController-&gt;EnableDebugLayer();</span></span><br><span class="line"><span class="comment">//		&#125;</span></span><br><span class="line"><span class="comment">//#endif</span></span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(<span class="built_in">CreateDXGIFactory</span>(<span class="built_in">IID_PPV_ARGS</span>(&amp;mdxgiFactory)));</span><br><span class="line"></span><br><span class="line">	<span class="comment">//创建硬件设备</span></span><br><span class="line">	HRESULT hardwareResult = <span class="built_in">D3D12CreateDevice</span>(<span class="literal">nullptr</span>, D3D_FEATURE_LEVEL_11_0, <span class="built_in">IID_PPV_ARGS</span>(&amp;md3dDevice));<span class="comment">//第一个参数是空则使用默认显示器</span></span><br><span class="line">	<span class="comment">//回退至WARP设备</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">FAILED</span>(hardwareResult))</span><br><span class="line">	&#123;</span><br><span class="line">		ComPtr&lt;IDXGIAdapter&gt; pWarpAdapter;</span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(mdxgiFactory-&gt;<span class="built_in">EnumWarpAdapter</span>(<span class="built_in">IID_PPV_ARGS</span>(&amp;pWarpAdapter)));</span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(<span class="built_in">D3D12CreateDevice</span>(pWarpAdapter.<span class="built_in">Get</span>(), D3D_FEATURE_LEVEL_11_0, <span class="built_in">IID_PPV_ARGS</span>(&amp;md3dDevice)));</span><br><span class="line">	&#125;</span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateFence</span>(<span class="number">0</span>, D3D12_FENCE_FLAG_NONE, <span class="built_in">IID_PPV_ARGS</span>(&amp;mFence)));</span><br><span class="line"></span><br><span class="line">		<span class="comment">//描述符信息，方便以后使用</span></span><br><span class="line">		mRtvDescriptorSize = md3dDevice-&gt;<span class="built_in">GetDescriptorHandleIncrementSize</span>(D3D12_DESCRIPTOR_HEAP_TYPE_RTV);</span><br><span class="line">		mDsvDescriptorSize = md3dDevice-&gt;<span class="built_in">GetDescriptorHandleIncrementSize</span>(D3D12_DESCRIPTOR_HEAP_TYPE_DSV);</span><br><span class="line">		mCbvSrvUavDescriptorSize = md3dDevice-&gt;<span class="built_in">GetDescriptorHandleIncrementSize</span>(D3D12_DESCRIPTOR_HEAP_TYPE_CBV_SRV_UAV);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//检查4X MSAA质量对我们的后缓冲区格式的支持。</span></span><br><span class="line">		 <span class="comment">//所有支持Direct3D 11的设备都对所有渲染支持4倍MSAA</span></span><br><span class="line">		 <span class="comment">//目标格式，因此我们只需要检查质量支持。</span></span><br><span class="line">		D3D12_FEATURE_DATA_MULTISAMPLE_QUALITY_LEVELS msQualityLevels;</span><br><span class="line">		msQualityLevels.Format = mBackBufferFormat;</span><br><span class="line">		msQualityLevels.SampleCount = <span class="number">4</span>;</span><br><span class="line">		msQualityLevels.Flags = D3D12_MULTISAMPLE_QUALITY_LEVELS_FLAG_NONE;</span><br><span class="line">		msQualityLevels.NumQualityLevels = <span class="number">0</span>;</span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CheckFeatureSupport</span>(D3D12_FEATURE_MULTISAMPLE_QUALITY_LEVELS, &amp;msQualityLevels, <span class="built_in"><span class="keyword">sizeof</span></span>(msQualityLevels)));</span><br><span class="line">		m4xMsaaQuality = msQualityLevels.NumQualityLevels;</span><br><span class="line">		<span class="built_in">assert</span>(m4xMsaaQuality &gt; <span class="number">0</span> &amp;&amp; <span class="string">&quot;Unexpected MSAA quality level.&quot;</span>);</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">		<span class="built_in">CreateCommandObjects</span>();</span><br><span class="line">		<span class="built_in">CreateSwapChain</span>();</span><br><span class="line">		<span class="built_in">CreateRtvAndDsvDescriptorHeaps</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DXApp::FlushCommandQueue</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//提升围栏值以将命令标记到该围栏点。</span></span><br><span class="line">	mCurrentFence++;</span><br><span class="line">	<span class="comment">//将指令添加到命令队列以设置新的防护点。 因为我们</span></span><br><span class="line">	<span class="comment">//在GPU时间轴上，直到GPU完成后才会设置新的围栏点</span></span><br><span class="line">	<span class="comment">//处理此Signal（）之前的所有命令。</span></span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(mCommandQueue-&gt;<span class="built_in">Signal</span>(mFence.<span class="built_in">Get</span>(),mCurrentFence));</span><br><span class="line"></span><br><span class="line">	<span class="comment">//等待直到GPU完成命令为止。</span></span><br><span class="line">	<span class="keyword">if</span> (mFence-&gt;<span class="built_in">GetCompletedValue</span>() &lt; mCurrentFence)</span><br><span class="line">	&#123;</span><br><span class="line">		HANDLE eventHandle=<span class="built_in">CreateEventEx</span>(<span class="literal">nullptr</span>,<span class="literal">false</span>,<span class="literal">false</span>,EVENT_ALL_ACCESS);</span><br><span class="line">		<span class="comment">//GPU击中当前围墙时触发事件。</span></span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(mFence-&gt;<span class="built_in">SetEventOnCompletion</span>(mCurrentFence,eventHandle));</span><br><span class="line"></span><br><span class="line">		<span class="comment">//等到GPU击中当前的fence事件后再触发。</span></span><br><span class="line">		<span class="built_in">WaitForSingleObject</span>(eventHandle,INFINITE);</span><br><span class="line">		<span class="built_in">CloseHandle</span>(eventHandle);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DXApp::CreateSwapChain</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	mSwapChain.<span class="built_in">Reset</span>();</span><br><span class="line">	DXGI_SWAP_CHAIN_DESC sd;</span><br><span class="line">	sd.BufferDesc.Width = mClientWidth;</span><br><span class="line">	sd.BufferDesc.Height = mClientHeight;</span><br><span class="line">	sd.BufferDesc.RefreshRate.Numerator = <span class="number">60</span>;</span><br><span class="line">	sd.BufferDesc.RefreshRate.Denominator = <span class="number">1</span>;</span><br><span class="line">	sd.BufferDesc.Format = mBackBufferFormat;</span><br><span class="line">	sd.BufferDesc.ScanlineOrdering = DXGI_MODE_SCANLINE_ORDER_UNSPECIFIED;</span><br><span class="line">	sd.BufferDesc.Scaling = DXGI_MODE_SCALING_UNSPECIFIED;</span><br><span class="line">	sd.SampleDesc.Count = m4xMsaaState ? <span class="number">4</span> : <span class="number">1</span>;</span><br><span class="line">	sd.SampleDesc.Quality = m4xMsaaState ? (m4xMsaaQuality - <span class="number">1</span>) : <span class="number">0</span>;</span><br><span class="line">	sd.BufferUsage = DXGI_USAGE_RENDER_TARGET_OUTPUT;</span><br><span class="line">	sd.BufferCount = SwapChainBufferCount;</span><br><span class="line">	sd.OutputWindow = mhMainWnd;</span><br><span class="line">	sd.Windowed = <span class="literal">true</span>;</span><br><span class="line">	sd.SwapEffect = DXGI_SWAP_EFFECT_FLIP_DISCARD;</span><br><span class="line">	sd.Flags = DXGI_SWAP_CHAIN_FLAG_ALLOW_MODE_SWITCH;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Note: Swap chain uses queue to perform flush.</span></span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(mdxgiFactory-&gt;<span class="built_in">CreateSwapChain</span>(</span><br><span class="line">		mCommandQueue.<span class="built_in">Get</span>(),</span><br><span class="line">		&amp;sd,</span><br><span class="line">		mSwapChain.<span class="built_in">GetAddressOf</span>()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DXApp::CreateCommandObjects</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	D3D12_COMMAND_QUEUE_DESC queueDesc = &#123;&#125;;</span><br><span class="line">	queueDesc.Type = D3D12_COMMAND_LIST_TYPE_DIRECT;</span><br><span class="line">	queueDesc.Flags = D3D12_COMMAND_QUEUE_FLAG_NONE;</span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateCommandQueue</span>(&amp;queueDesc, <span class="built_in">IID_PPV_ARGS</span>(&amp;mCommandQueue)));</span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateCommandAllocator</span>(D3D12_COMMAND_LIST_TYPE_DIRECT, <span class="built_in">IID_PPV_ARGS</span>(mDirectCmdListAlloc.<span class="built_in">GetAddressOf</span>())));</span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateCommandList</span>(<span class="number">0</span>, D3D12_COMMAND_LIST_TYPE_DIRECT, mDirectCmdListAlloc.<span class="built_in">Get</span>(), <span class="literal">nullptr</span>, <span class="built_in">IID_PPV_ARGS</span>(mCommandList.<span class="built_in">ReleaseAndGetAddressOf</span>())));</span><br><span class="line"></span><br><span class="line">	<span class="comment">//从关闭状态开始。 这是因为我们第一次提到</span></span><br><span class="line">	<span class="comment">//在命令列表中，我们将对其进行重置，并且需要先关闭它</span></span><br><span class="line">	<span class="comment">//调用Reset。</span></span><br><span class="line">	mCommandList-&gt;<span class="built_in">Close</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ID3D12Resource* <span class="title">DXApp::CurrentBackBuffer</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> mSwapChainBuffer[mCurrBackBuffer].<span class="built_in">Get</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">D3D12_CPU_DESCRIPTOR_HANDLE <span class="title">DXApp::CurrentBackBufferView</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">CD3DX12_CPU_DESCRIPTOR_HANDLE</span>(</span><br><span class="line">		mRtvHeap-&gt;<span class="built_in">GetCPUDescriptorHandleForHeapStart</span>(),</span><br><span class="line">		mCurrBackBuffer,</span><br><span class="line">		mRtvDescriptorSize);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">D3D12_CPU_DESCRIPTOR_HANDLE <span class="title">DXApp::DepthStencilView</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> mDsvHeap-&gt;<span class="built_in">GetCPUDescriptorHandleForHeapStart</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DXApp::LogAdapters</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UINT i = <span class="number">0</span>;</span><br><span class="line">	IDXGIAdapter* adapter = <span class="literal">nullptr</span>;</span><br><span class="line">	std::vector&lt;IDXGIAdapter*&gt; adapterList;</span><br><span class="line">	<span class="keyword">while</span> (mdxgiFactory-&gt;<span class="built_in">EnumAdapters</span>(i, &amp;adapter) != DXGI_ERROR_NOT_FOUND)</span><br><span class="line">	&#123;</span><br><span class="line">		DXGI_ADAPTER_DESC desc;</span><br><span class="line">		adapter-&gt;<span class="built_in">GetDesc</span>(&amp;desc);</span><br><span class="line"></span><br><span class="line">		std::wstring text = <span class="string">L&quot;***Adapter: &quot;</span>;</span><br><span class="line">		text += desc.Description;</span><br><span class="line">		text += <span class="string">L&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">OutputDebugString</span>(text.<span class="built_in">c_str</span>());</span><br><span class="line"></span><br><span class="line">		adapterList.<span class="built_in">push_back</span>(adapter);</span><br><span class="line"></span><br><span class="line">		++i;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; adapterList.<span class="built_in">size</span>(); ++i)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">LogAdapterOutputs</span>(adapterList[i]);</span><br><span class="line">		<span class="built_in">ReleaseCom</span>(adapterList[i]);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DXApp::LogAdapterOutputs</span><span class="params">(IDXGIAdapter* adapter)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UINT i = <span class="number">0</span>;</span><br><span class="line">	IDXGIOutput* output = <span class="literal">nullptr</span>;</span><br><span class="line">	<span class="keyword">while</span> (adapter-&gt;<span class="built_in">EnumOutputs</span>(i, &amp;output) != DXGI_ERROR_NOT_FOUND)</span><br><span class="line">	&#123;</span><br><span class="line">		DXGI_OUTPUT_DESC desc;</span><br><span class="line">		output-&gt;<span class="built_in">GetDesc</span>(&amp;desc);</span><br><span class="line"></span><br><span class="line">		std::wstring text = <span class="string">L&quot;***Output: &quot;</span>;</span><br><span class="line">		text += desc.DeviceName;</span><br><span class="line">		text += <span class="string">L&quot;\n&quot;</span>;</span><br><span class="line">		<span class="built_in">OutputDebugString</span>(text.<span class="built_in">c_str</span>());</span><br><span class="line"></span><br><span class="line">		<span class="built_in">LogOutputDisplayModes</span>(output, mBackBufferFormat);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">ReleaseCom</span>(output);</span><br><span class="line"></span><br><span class="line">		++i;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DXApp::LogOutputDisplayModes</span><span class="params">(IDXGIOutput* output, DXGI_FORMAT format)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UINT count = <span class="number">0</span>;</span><br><span class="line">	UINT flags = <span class="number">0</span>; </span><br><span class="line"></span><br><span class="line">	<span class="comment">// Call with nullptr to get list count.</span></span><br><span class="line">	output-&gt;<span class="built_in">GetDisplayModeList</span>(format, flags, &amp;count, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">	<span class="function">std::vector&lt;DXGI_MODE_DESC&gt; <span class="title">modeList</span><span class="params">(count)</span></span>;</span><br><span class="line">	output-&gt;<span class="built_in">GetDisplayModeList</span>(format, flags, &amp;count, &amp;modeList[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">auto</span>&amp; x : modeList)</span><br><span class="line">	&#123;</span><br><span class="line">		UINT n = x.RefreshRate.Numerator;</span><br><span class="line">		UINT d = x.RefreshRate.Denominator;</span><br><span class="line">		std::wstring text =</span><br><span class="line">			<span class="string">L&quot;Width = &quot;</span> + std::<span class="built_in">to_wstring</span>(x.Width) + <span class="string">L&quot; &quot;</span> +</span><br><span class="line">			<span class="string">L&quot;Height = &quot;</span> + std::<span class="built_in">to_wstring</span>(x.Height) + <span class="string">L&quot; &quot;</span> +</span><br><span class="line">			<span class="string">L&quot;Refresh = &quot;</span> + std::<span class="built_in">to_wstring</span>(n) + <span class="string">L&quot;/&quot;</span> + std::<span class="built_in">to_wstring</span>(d) +</span><br><span class="line">			<span class="string">L&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">		::<span class="built_in">OutputDebugString</span>(text.<span class="built_in">c_str</span>());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">DXApp* <span class="title">DXApp::GetApp</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> mApp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">HINSTANCE <span class="title">DXApp::AppInst</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> mhAppInst;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">HWND <span class="title">DXApp::MainWnd</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> mhMainWnd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">DXApp::AspectRatio</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">static_cast</span>&lt;<span class="keyword">float</span>&gt;(mClientWidth) / mClientHeight;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">DXApp::Get4xMsaaState</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> m4xMsaaState;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DXApp::Set4xMsaaState</span><span class="params">(<span class="keyword">bool</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (m4xMsaaState!=value)</span><br><span class="line">	&#123;</span><br><span class="line">		m4xMsaaState = value;</span><br><span class="line">		<span class="comment">//重置4xmasaa需要重新创建交换链和刷新尺寸</span></span><br><span class="line">		<span class="built_in">CreateSwapChain</span>();</span><br><span class="line">		<span class="built_in">OnResize</span>();</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">DXApp::Run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	MSG msg = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">	mTimer.<span class="built_in">Reset</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (msg.message != WM_QUIT)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// If there are Window messages then process them.</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">PeekMessage</span>(&amp;msg, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, PM_REMOVE))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">TranslateMessage</span>(&amp;msg);</span><br><span class="line">			<span class="built_in">DispatchMessage</span>(&amp;msg);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// Otherwise, do animation/game stuff.</span></span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			mTimer.<span class="built_in">Tick</span>();</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (!mAppPaused)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">CalculateFrameStats</span>();</span><br><span class="line">				<span class="built_in">Update</span>(mTimer);</span><br><span class="line">				<span class="built_in">Draw</span>(mTimer);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">Sleep</span>(<span class="number">100</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">int</span>)msg.wParam;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DXApp::CalculateFrameStats</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// Code computes the average frames per second, and also the </span></span><br><span class="line">		<span class="comment">// average time it takes to render one frame.  These stats </span></span><br><span class="line">		<span class="comment">// are appended to the window caption bar.</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">int</span> frameCnt = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">float</span> timeElapsed = <span class="number">0.0f</span>;</span><br><span class="line"></span><br><span class="line">	frameCnt++;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Compute averages over one second period.</span></span><br><span class="line">	<span class="keyword">if</span> ((mTimer.<span class="built_in">TotalTime</span>() - timeElapsed) &gt;= <span class="number">1.0f</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">float</span> fps = (<span class="keyword">float</span>)frameCnt; <span class="comment">// fps = frameCnt / 1</span></span><br><span class="line">		<span class="keyword">float</span> mspf = <span class="number">1000.0f</span> / fps;</span><br><span class="line"></span><br><span class="line">		wstring fpsStr = <span class="built_in">to_wstring</span>(fps);</span><br><span class="line">		wstring mspfStr = <span class="built_in">to_wstring</span>(mspf);</span><br><span class="line"></span><br><span class="line">		wstring windowText = mMainWndCaption +</span><br><span class="line">			<span class="string">L&quot;    fps: &quot;</span> + fpsStr +</span><br><span class="line">			<span class="string">L&quot;   mspf: &quot;</span> + mspfStr;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">SetWindowText</span>(mhMainWnd, <span class="string">L&quot;window text&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Reset for next average.</span></span><br><span class="line">		frameCnt = <span class="number">0</span>;</span><br><span class="line">		timeElapsed += <span class="number">1.0f</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">LRESULT <span class="title">DXApp::MsgProc</span><span class="params">(HWND hwnd, UINT msg, WPARAM wParam, LPARAM lParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in"><span class="keyword">switch</span></span> (msg)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//激活或停用窗口时发送WM_ACTIVATE。</span></span><br><span class="line">		<span class="comment">//当停用窗口时我们暂停游戏</span></span><br><span class="line">		<span class="comment">//当它变为活动状态时取消暂停</span></span><br><span class="line">	<span class="keyword">case</span> WM_ACTIVATE:</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">LOWORD</span>(wParam)==WA_INACTIVE)</span><br><span class="line">		&#123;</span><br><span class="line">			mAppPaused = <span class="literal">true</span>;</span><br><span class="line">			mTimer.<span class="built_in">Stop</span>();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			mAppPaused = <span class="literal">false</span>;</span><br><span class="line">			mTimer.<span class="built_in">Start</span>();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		<span class="comment">// 当用户调整窗口大小时，发送WM_SIZE。</span></span><br><span class="line">	<span class="keyword">case</span> WM_SIZE:</span><br><span class="line">		<span class="comment">// 保存新的客户区域尺寸。</span></span><br><span class="line">		mClientWidth = <span class="built_in">LOWORD</span>(lParam);</span><br><span class="line">		mClientHeight = <span class="built_in">HIWORD</span>(lParam);</span><br><span class="line">		<span class="keyword">if</span> (md3dDevice)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (wParam == SIZE_MINIMIZED)</span><br><span class="line">			&#123;</span><br><span class="line">				mAppPaused = <span class="literal">true</span>;</span><br><span class="line">				mMinimized = <span class="literal">true</span>;</span><br><span class="line">				mMaximized = <span class="literal">false</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (wParam == SIZE_MAXIMIZED)</span><br><span class="line">			&#123;</span><br><span class="line">				mAppPaused = <span class="literal">false</span>;</span><br><span class="line">				mMinimized = <span class="literal">false</span>;</span><br><span class="line">				mMaximized = <span class="literal">true</span>;</span><br><span class="line">				<span class="built_in">OnResize</span>();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (wParam == SIZE_RESTORED)</span><br><span class="line">			&#123;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Restoring from minimized state?</span></span><br><span class="line">				<span class="keyword">if</span> (mMinimized)</span><br><span class="line">				&#123;</span><br><span class="line">					mAppPaused = <span class="literal">false</span>;</span><br><span class="line">					mMinimized = <span class="literal">false</span>;</span><br><span class="line">					<span class="built_in">OnResize</span>();</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Restoring from maximized state?</span></span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">if</span> (mMaximized)</span><br><span class="line">				&#123;</span><br><span class="line">					mAppPaused = <span class="literal">false</span>;</span><br><span class="line">					mMaximized = <span class="literal">false</span>;</span><br><span class="line">					<span class="built_in">OnResize</span>();</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">if</span> (mResizing)</span><br><span class="line">				&#123;</span><br><span class="line">				<span class="comment">//如果用户拖动调整大小栏，我们不会调整大小</span></span><br><span class="line">				<span class="comment">//这里的缓冲区，因为随着用户的不断前进</span></span><br><span class="line">				<span class="comment">//拖动调整大小条，WM_SIZE消息流是</span></span><br><span class="line">				<span class="comment">//发送到窗口，它将毫无意义（而且很慢）</span></span><br><span class="line">				<span class="comment">//为从拖动中收到的每个WM_SIZE消息调整大小</span></span><br><span class="line">				<span class="comment">//调整尺寸栏。 因此，我们在用户</span></span><br><span class="line">				<span class="comment">//完成调整窗口大小并释放大小调整条</span></span><br><span class="line">				<span class="comment">//发送WM_EXITSIZEMOVE消息。</span></span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> <span class="comment">// API call such as SetWindowPos or mSwapChain-&gt;SetFullscreenState.</span></span><br><span class="line">				&#123;</span><br><span class="line">					<span class="built_in">OnResize</span>();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 当用户抓住调整大小条时，将发送WM_EXITSIZEMOVE。</span></span><br><span class="line">	<span class="keyword">case</span> WM_ENTERSIZEMOVE:</span><br><span class="line">		mAppPaused = <span class="literal">true</span>;</span><br><span class="line">		mResizing = <span class="literal">true</span>;</span><br><span class="line">		mTimer.<span class="built_in">Stop</span>();</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//当用户释放大小调整条时，发送WM_EXITSIZEMOVE。</span></span><br><span class="line">		<span class="comment">//在这里，我们根据新窗口的尺寸重置所有内容。</span></span><br><span class="line">	<span class="keyword">case</span> WM_EXITSIZEMOVE:</span><br><span class="line">		mAppPaused = <span class="literal">false</span>;</span><br><span class="line">		mResizing = <span class="literal">false</span>;</span><br><span class="line">		mTimer.<span class="built_in">Start</span>();</span><br><span class="line">		<span class="built_in">OnResize</span>();</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		<span class="comment">//销毁窗口时发送WM_DESTROY。</span></span><br><span class="line">	<span class="keyword">case</span> WM_DESTROY:</span><br><span class="line">		<span class="built_in">PostQuitMessage</span>(<span class="number">0</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		<span class="comment">// 当菜单处于活动状态并且用户按下时，将发送WM_MENUCHAR消息与任何助记键或加速键都不对应的键。</span></span><br><span class="line">	<span class="keyword">case</span> WM_MENUCHAR:</span><br><span class="line">		<span class="comment">// 进入时不要发出哔声。</span></span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">MAKELRESULT</span>(<span class="number">0</span>, MNC_CLOSE);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="comment">//捕获此消息，以防止窗口变得太小。</span></span><br><span class="line">	<span class="keyword">case</span> WM_GETMINMAXINFO:</span><br><span class="line">		((MINMAXINFO*)lParam)-&gt;ptMinTrackSize.x = <span class="number">200</span>;</span><br><span class="line">		((MINMAXINFO*)lParam)-&gt;ptMinTrackSize.y = <span class="number">200</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> WM_LBUTTONDOWN:</span><br><span class="line">	<span class="keyword">case</span> WM_MBUTTONDOWN:</span><br><span class="line">	<span class="keyword">case</span> WM_RBUTTONDOWN:</span><br><span class="line">		<span class="built_in">OnMouseDown</span>(wParam, <span class="built_in">GET_X_LPARAM</span>(lParam), <span class="built_in">GET_Y_LPARAM</span>(lParam));</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">case</span> WM_LBUTTONUP:</span><br><span class="line">	<span class="keyword">case</span> WM_MBUTTONUP:</span><br><span class="line">	<span class="keyword">case</span> WM_RBUTTONUP:</span><br><span class="line">		<span class="built_in">OnMouseUp</span>(wParam, <span class="built_in">GET_X_LPARAM</span>(lParam), <span class="built_in">GET_Y_LPARAM</span>(lParam));</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">case</span> WM_MOUSEMOVE:</span><br><span class="line">		<span class="built_in">OnMouseMove</span>(wParam, <span class="built_in">GET_X_LPARAM</span>(lParam), <span class="built_in">GET_Y_LPARAM</span>(lParam));</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">case</span> WM_KEYUP:</span><br><span class="line">		<span class="keyword">if</span> (wParam == VK_ESCAPE)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">PostQuitMessage</span>(<span class="number">0</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ((<span class="keyword">int</span>)wParam == VK_F2)</span><br><span class="line">			<span class="built_in">Set4xMsaaState</span>(!m4xMsaaState);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">DefWindowProc</span>(hwnd, msg, wParam, lParam);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://supervj.top/2020/06/15/%E8%B6%855%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3EN/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://img.supervj.top/imgHEAD_Icon.png">
      <meta itemprop="name" content="VJ东">
      <meta itemprop="description" content=" 如果我们不曾相遇 ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="月光林地">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/06/15/%E8%B6%855%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3EN/" class="post-title-link" itemprop="url">《Fightting Game Template》Documentation</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-06-15 00:00:00" itemprop="dateCreated datePublished" datetime="2020-06-15T00:00:00+08:00">2020-06-15</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-08-02 16:13:15" itemprop="dateModified" datetime="2021-08-02T16:13:15+08:00">2021-08-02</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/other/" itemprop="url" rel="index"><span itemprop="name">other</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    
      <a title="changyan" href="/2020/06/15/%E8%B6%855%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3EN/#SOHUCS" itemprop="discussionUrl">
        <span id="url::http://supervj.top/2020/06/15/%E8%B6%855%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3EN/" class="cy_cmt_count" data-xid="2020/06/15/超5说明文档EN/" itemprop="commentCount"></span>
      </a>
    
  </span>
  
  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>715</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Instructions"><a href="#Instructions" class="headerlink" title="Instructions"></a>Instructions</h2><ul>
<li>It is very important that you should click the <strong>option button</strong> to set your keys ，and save it</li>
<li>Click the Multiplayer button to enter the character selection interface<ul>
<li>V1.0 has no AI so we can not click <code>SinglePlayer</code> button</li>
</ul>
</li>
<li>Use the <code>LEFT</code> and <code>RIGHT</code> buttons and <code>A</code> button in your button settings to select and confirm the role<ul>
<li>ps. <code>A</code> Key is not the keyboard <code>A</code>， but the <code>A</code> in the game, generally the default is <code>U</code> key</li>
</ul>
</li>
<li>Then player 1 can use the same operation to select the map</li>
<li>After that，let’s battle！</li>
</ul>
<h2 id="Charcater-Moves"><a href="#Charcater-Moves" class="headerlink" title="Charcater Moves"></a>Charcater Moves</h2><h3 id="WuKong"><a href="#WuKong" class="headerlink" title="WuKong"></a>WuKong</h3><h5 id="NormalMoves"><a href="#NormalMoves" class="headerlink" title="NormalMoves"></a>NormalMoves</h5><table>
<thead>
<tr>
<th>Keys</th>
<th>Moves(temp name)</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://img.supervj.top/img/FighttingGamearrow_D.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_r.png" style="zoom:10%;" />+A/C</td>
<td>1</td>
</tr>
<tr>
<td><img src="https://img.supervj.top/img/FighttingGamearrow_r.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_D.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_r.png" style="zoom:10%;" />+A/C</td>
<td>2</td>
</tr>
<tr>
<td><img src="https://img.supervj.top/img/FighttingGamearrow_D.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_L.png" style="zoom:10%;" />+B/D</td>
<td>3</td>
</tr>
<tr>
<td><img src="https://img.supervj.top/img/FighttingGamearrow_r.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_r.png" style="zoom:10%;" />+A/C</td>
<td>4</td>
</tr>
</tbody></table>
<h5 id="SpecialMoves"><a href="#SpecialMoves" class="headerlink" title="SpecialMoves"></a>SpecialMoves</h5><table>
<thead>
<tr>
<th>Keys</th>
<th>Moves(temp name)</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://img.supervj.top/img/FighttingGamearrow_D.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_r.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_D.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_r.png" style="zoom:10%;" />+A/C</td>
<td>1</td>
</tr>
<tr>
<td><img src="https://img.supervj.top/img/FighttingGamearrow_D.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_r.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_D.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_L.png" style="zoom:10%;" />+A/C</td>
<td>2</td>
</tr>
</tbody></table>
<h5 id="MaxSpecialMoves"><a href="#MaxSpecialMoves" class="headerlink" title="MaxSpecialMoves"></a>MaxSpecialMoves</h5><table>
<thead>
<tr>
<th>Keys</th>
<th>Moves(temp name)</th>
</tr>
</thead>
<tbody><tr>
<td>(<strong>In Max Stat</strong>)<img src="https://img.supervj.top/img/FighttingGamearrow_D.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_r.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_D.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_r.png" style="zoom:10%;" />+A/C</td>
<td>1</td>
</tr>
</tbody></table>
<h3 id="Aurora"><a href="#Aurora" class="headerlink" title="Aurora"></a>Aurora</h3><h5 id="NormalMoves-1"><a href="#NormalMoves-1" class="headerlink" title="NormalMoves"></a>NormalMoves</h5><table>
<thead>
<tr>
<th>Keys</th>
<th>Moves(temp name)</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://img.supervj.top/img/FighttingGamearrow_D.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_r.png" style="zoom:10%;" />+A/C</td>
<td>1</td>
</tr>
<tr>
<td><img src="https://img.supervj.top/img/FighttingGamearrow_r.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_D.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_L.png" style="zoom:10%;" />+A/C</td>
<td>2</td>
</tr>
<tr>
<td><img src="https://img.supervj.top/img/FighttingGamearrow_r.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_D.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_L.png" style="zoom:10%;" />+B/D</td>
<td>3</td>
</tr>
<tr>
<td><img src="https://img.supervj.top/img/FighttingGamearrow_L.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_D.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_r.png" style="zoom:10%;" />+B/D</td>
<td>4</td>
</tr>
</tbody></table>
<h5 id="SpecialMoves-1"><a href="#SpecialMoves-1" class="headerlink" title="SpecialMoves"></a>SpecialMoves</h5><table>
<thead>
<tr>
<th>Keys</th>
<th>Moves(temp name)</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://img.supervj.top/img/FighttingGamearrow_D.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_r.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_D.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_r.png" style="zoom:10%;" />+A/C</td>
<td>1</td>
</tr>
<tr>
<td><img src="https://img.supervj.top/img/FighttingGamearrow_D.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_r.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_D.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_L.png" style="zoom:10%;" />+B/D</td>
<td>2</td>
</tr>
</tbody></table>
<h5 id="MaxSpecialMoves-1"><a href="#MaxSpecialMoves-1" class="headerlink" title="MaxSpecialMoves"></a>MaxSpecialMoves</h5><table>
<thead>
<tr>
<th>Keys</th>
<th>Moves(temp name)</th>
</tr>
</thead>
<tbody><tr>
<td>(<strong>In Max Stat</strong>)<img src="https://img.supervj.top/img/FighttingGamearrow_D.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_r.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_D.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_r.png" style="zoom:10%;" />+A/C</td>
<td>1</td>
</tr>
</tbody></table>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://supervj.top/2020/06/12/%E8%B7%AF%E5%BE%84%E4%BC%98%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://img.supervj.top/imgHEAD_Icon.png">
      <meta itemprop="name" content="VJ东">
      <meta itemprop="description" content=" 如果我们不曾相遇 ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="月光林地">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/06/12/%E8%B7%AF%E5%BE%84%E4%BC%98%E5%8C%96/" class="post-title-link" itemprop="url">路径点优化</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-06-12 00:00:00" itemprop="dateCreated datePublished" datetime="2020-06-12T00:00:00+08:00">2020-06-12</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-08-02 16:36:06" itemprop="dateModified" datetime="2021-08-02T16:36:06+08:00">2021-08-02</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/math/" itemprop="url" rel="index"><span itemprop="name">math</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    
      <a title="changyan" href="/2020/06/12/%E8%B7%AF%E5%BE%84%E4%BC%98%E5%8C%96/#SOHUCS" itemprop="discussionUrl">
        <span id="url::http://supervj.top/2020/06/12/%E8%B7%AF%E5%BE%84%E4%BC%98%E5%8C%96/" class="cy_cmt_count" data-xid="2020/06/12/路径优化/" itemprop="commentCount"></span>
      </a>
    
  </span>
  
  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>5.5k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>5 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>本文介绍路径点的优化方式，或者叫做多线段优化、轨迹点优化</p>
<p>根据设定阈值，去掉路径点中的部分多余点，以达到方便传输的目的</p>
<p>本文用UE4蓝图和C++蓝图函数库的2个方式解释</p>
<p><strong>注:多种方法可以叠加使用</strong></p>
</blockquote>
<p>本算法提供了基于UE4的Demo，<a target="_blank" rel="noopener" href="https://xshniteducn-my.sharepoint.com/:u:/g/personal/15040920722_xs_hnit_edu_cn/EdZ7WHvq8mdHm2b0xRcJtWsBnhqVdqBx07E_Tr_s7mshDQ?e=8lhWkm">PC</a>，<a target="_blank" rel="noopener" href="https://xshniteducn-my.sharepoint.com/:u:/g/personal/15040920722_xs_hnit_edu_cn/ET-Wm3V8br1PuSrS0qUnwekBLP5bGpnZqZ8cGb3tGSLK-w?e=Y7wQmT">安卓</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/VJien/PathOptimazation">GitHub工程下载</a></p>
<p>Demo演示动图</p>
<p><img src="https://img.supervj.top/img/PathOptimization/pathOpt_10.gif"></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2020/06/12/%E8%B7%AF%E5%BE%84%E4%BC%98%E5%8C%96/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://supervj.top/2020/06/04/%E7%94%B1SetActorLocation%E5%88%86%E6%9E%90%E6%B8%B2%E6%9F%93%E6%B5%81%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://img.supervj.top/imgHEAD_Icon.png">
      <meta itemprop="name" content="VJ东">
      <meta itemprop="description" content=" 如果我们不曾相遇 ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="月光林地">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/06/04/%E7%94%B1SetActorLocation%E5%88%86%E6%9E%90%E6%B8%B2%E6%9F%93%E6%B5%81%E7%A8%8B/" class="post-title-link" itemprop="url">由SetActorLocation分析渲染流程</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-06-04 00:00:00" itemprop="dateCreated datePublished" datetime="2020-06-04T00:00:00+08:00">2020-06-04</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-08-02 16:20:26" itemprop="dateModified" datetime="2021-08-02T16:20:26+08:00">2021-08-02</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/engine/" itemprop="url" rel="index"><span itemprop="name">engine</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    
      <a title="changyan" href="/2020/06/04/%E7%94%B1SetActorLocation%E5%88%86%E6%9E%90%E6%B8%B2%E6%9F%93%E6%B5%81%E7%A8%8B/#SOHUCS" itemprop="discussionUrl">
        <span id="url::http://supervj.top/2020/06/04/%E7%94%B1SetActorLocation%E5%88%86%E6%9E%90%E6%B8%B2%E6%9F%93%E6%B5%81%E7%A8%8B/" class="cy_cmt_count" data-xid="2020/06/04/由SetActorLocation分析渲染流程/" itemprop="commentCount"></span>
      </a>
    
  </span>
  
  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>8.5k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>8 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>角色位移本质上就是渲染问题，从这条思路我们去看看角色怎么实现这一部分渲染的</p>
</blockquote>
<h5 id="起点：SetActorLocation"><a href="#起点：SetActorLocation" class="headerlink" title="起点：SetActorLocation"></a>起点：SetActorLocation</h5><blockquote>
<p>蓝图调用的API实际调用的是K2_SetActorLocation，然后调用到此函数</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> RootComponent-&gt;<span class="built_in">MoveComponent</span>(Delta, <span class="built_in">GetActorQuat</span>(), bSweep, OutSweepHitResult, MOVECOMP_NoFlags, Teleport);</span><br></pre></td></tr></table></figure>

<p>只看这个关键代码，调用<code>RootComponent</code>的<code>MoveComponent</code></p>
<h5 id="USceneComponent"><a href="#USceneComponent" class="headerlink" title="USceneComponent"></a>USceneComponent</h5><h6 id="MoveComponent"><a href="#MoveComponent" class="headerlink" title="MoveComponent"></a>MoveComponent</h6><blockquote>
<p>外部调用此函数后里面直接调用到带<code>Impl</code>后缀的虚函数</p>
<p>这个函数在UPrimitiveComponent内有重写</p>
</blockquote>
<p><code>USceneComponent</code>内主要调用了函数<code>ConditionalUpdateComponentToWorld</code>,而<code>UPrimitiveComponent</code>因为有碰撞等属性所以又多了很多逻辑，这里不多描述</p>
<h6 id="UpdateComponentToWorldWithParent"><a href="#UpdateComponentToWorldWithParent" class="headerlink" title="UpdateComponentToWorldWithParent"></a>UpdateComponentToWorldWithParent</h6><blockquote>
<p>此函数通过<code>ConditionalUpdateComponentToWorld</code>调用，后又调用到虚函数<code>UpdateComponentToWorld</code>,此虚函数在<code>UActorComponent</code>声明，在<code>USceneComponent</code>重写</p>
<p>然后再直接调用到此函数</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (Parent &amp;&amp; !Parent-&gt;bComponentToWorldUpdated)</span><br><span class="line">&#123;</span><br><span class="line">	Parent-&gt;<span class="built_in">UpdateComponentToWorld</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (bComponentToWorldUpdated)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果有父级组件，先去处理他</p>
<p>然后调用到函数<code>PropagateTransformUpdate</code></p>
<h6 id="PropagateTransformUpdate"><a href="#PropagateTransformUpdate" class="headerlink" title="PropagateTransformUpdate"></a>PropagateTransformUpdate</h6><p>该函数执行了</p>
<ul>
<li>更新体积(Bounds)</li>
<li>更新变换(Transform)<ul>
<li>更新Attach的子组件的变换信息</li>
</ul>
</li>
<li>更新寻路信息</li>
</ul>
<p>其中有个关键的函数<code>UActorComponent::MarkRenderTransformDirty</code></p>
<p>然后经过简单判断以后调用<code>UActorComponent::MarkForNeededEndOfFrameUpdate</code></p>
<p>然后调用了<code>UWorld</code> 的<code>MarkActorComponentForNeededEndOfFrameUpdate</code></p>
<p>看主要代码</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UActorComponent::MarkRenderTransformDirty</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">IsRegistered</span>() &amp;&amp; bRenderStateCreated)</span><br><span class="line">	&#123;</span><br><span class="line">		bRenderTransformDirty = <span class="literal">true</span>;</span><br><span class="line">		<span class="built_in">MarkForNeededEndOfFrameUpdate</span>();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UActorComponent::MarkForNeededEndOfFrameUpdate</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (bNeverNeedsRenderUpdate)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	UWorld* ComponentWorld = <span class="built_in">GetWorld</span>();</span><br><span class="line">	<span class="keyword">if</span> (ComponentWorld)</span><br><span class="line">	&#123;</span><br><span class="line">		ComponentWorld-&gt;<span class="built_in">MarkActorComponentForNeededEndOfFrameUpdate</span>(<span class="keyword">this</span>, <span class="built_in">RequiresGameThreadEndOfFrameUpdates</span>());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">IsUnreachable</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// 如果没有世界，执行如下代码</span></span><br><span class="line">		<span class="built_in">DoDeferredRenderUpdates_Concurrent</span>();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="UWorld"><a href="#UWorld" class="headerlink" title="UWorld"></a>UWorld</h5><h6 id="MarkActorComponentForNeededEndOfFrameUpdate"><a href="#MarkActorComponentForNeededEndOfFrameUpdate" class="headerlink" title="MarkActorComponentForNeededEndOfFrameUpdate"></a>MarkActorComponentForNeededEndOfFrameUpdate</h6><blockquote>
<p>代码在LevelTick.cpp L883</p>
</blockquote>
<p>主要执行了把组件添加到了等待渲染的列表<code>ComponentsThatNeedEndOfFrameUpdate_OnGameThread</code>里,当然还有一个非游戏线程的<code>ComponentsThatNeedEndOfFrameUpdate</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (bForceGameThread)</span><br><span class="line">		&#123;</span><br><span class="line">			FMarkComponentEndOfFrameUpdateState::<span class="built_in">Set</span>(Component, ComponentsThatNeedEndOfFrameUpdate_OnGameThread.<span class="built_in">Num</span>(), EComponentMarkedForEndOfFrameUpdateState::MarkedForGameThread);</span><br><span class="line">			ComponentsThatNeedEndOfFrameUpdate_OnGameThread.<span class="built_in">Add</span>(Component);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			FMarkComponentEndOfFrameUpdateState::<span class="built_in">Set</span>(Component, ComponentsThatNeedEndOfFrameUpdate.<span class="built_in">Num</span>(), EComponentMarkedForEndOfFrameUpdateState::Marked);</span><br><span class="line">			ComponentsThatNeedEndOfFrameUpdate.<span class="built_in">Add</span>(Component);</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<p>到此我们大概知道了这一条线的终点了，然后去看看哪里使用到了这个数组</p>
<h6 id="SendAllEndOfFrameUpdates"><a href="#SendAllEndOfFrameUpdates" class="headerlink" title="SendAllEndOfFrameUpdates"></a>SendAllEndOfFrameUpdates</h6><p>确认使用上面数组是在此函数内，查找引用发现此函数在很多地方被调用，如<code>SceneRendering.cpp</code>,<code>UnrealEngine.cpp</code>大概就是要更新场景最新的渲染的时候就会调用，先不理会，看这个函数内实现</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (UActorComponent* Component : ComponentsThatNeedEndOfFrameUpdate_OnGameThread)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (Component)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> (Component-&gt;<span class="built_in">IsRegistered</span>() &amp;&amp; !Component-&gt;<span class="built_in">IsTemplate</span>() &amp;&amp; !Component-&gt;<span class="built_in">IsPendingKill</span>())</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="function">FScopeCycleCounterUObject <span class="title">ComponentScope</span><span class="params">(Component)</span></span>;</span><br><span class="line">					<span class="function">FScopeCycleCounterUObject <span class="title">AdditionalScope</span><span class="params">(STATS ? Component-&gt;AdditionalStatObject() : <span class="literal">nullptr</span>)</span></span>;</span><br><span class="line">					Component-&gt;<span class="built_in">DoDeferredRenderUpdates_Concurrent</span>();</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="built_in">check</span>(Component-&gt;<span class="built_in">IsPendingKill</span>() || Component-&gt;<span class="built_in">GetMarkedForEndOfFrameUpdateState</span>() == EComponentMarkedForEndOfFrameUpdateState::MarkedForGameThread);</span><br><span class="line">				FMarkComponentEndOfFrameUpdateState::<span class="built_in">Set</span>(Component, INDEX_NONE, EComponentMarkedForEndOfFrameUpdateState::Unmarked);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		ComponentsThatNeedEndOfFrameUpdate_OnGameThread.<span class="built_in">Reset</span>();</span><br><span class="line">		ComponentsThatNeedEndOfFrameUpdate.<span class="built_in">Reset</span>();</span><br></pre></td></tr></table></figure>

<p>遍历了所有数组成员，主要执行了<code>DoDeferredRenderUpdates_Concurrent</code>，回头看<code>USceneComponent</code>内的如果没有<code>UWorld</code>就直接调用了这个函数</p>
<h5 id="UActorComponent"><a href="#UActorComponent" class="headerlink" title="UActorComponent"></a>UActorComponent</h5><h6 id="DoDeferredRenderUpdates-Concurrent"><a href="#DoDeferredRenderUpdates-Concurrent" class="headerlink" title="DoDeferredRenderUpdates_Concurrent"></a>DoDeferredRenderUpdates_Concurrent</h6><p><code>RecreateRenderState_Concurrent</code>,<code>SendRenderTransform_Concurrent</code>,<code>SendRenderDynamicData_Concurrent</code>告诉引擎需要处理相应的渲染任务</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UActorComponent::DoDeferredRenderUpdates_Concurrent</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">checkf</span>(!<span class="built_in">IsUnreachable</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;%s&quot;</span>), *<span class="built_in">GetFullName</span>());</span><br><span class="line">	<span class="built_in">checkf</span>(!<span class="built_in">IsTemplate</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;%s&quot;</span>), *<span class="built_in">GetFullName</span>());</span><br><span class="line">	<span class="built_in">checkf</span>(!<span class="built_in">IsPendingKill</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;%s&quot;</span>), *<span class="built_in">GetFullName</span>());</span><br><span class="line"></span><br><span class="line">	<span class="function">FScopeCycleCounterUObject <span class="title">ContextScope</span><span class="params">(<span class="keyword">this</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(!<span class="built_in">IsRegistered</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">UE_LOG</span>(LogActorComponent, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;UpdateComponent: (%s) Not registered, Aborting.&quot;</span>), *<span class="built_in">GetPathName</span>());</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(bRenderStateDirty)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SCOPE_CYCLE_COUNTER</span>(STAT_PostTickComponentRecreate);</span><br><span class="line">		<span class="built_in">RecreateRenderState_Concurrent</span>();</span><br><span class="line">		<span class="built_in">checkf</span>(!bRenderStateDirty, <span class="built_in">TEXT</span>(<span class="string">&quot;Failed to route CreateRenderState_Concurrent (%s)&quot;</span>), *<span class="built_in">GetFullName</span>());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SCOPE_CYCLE_COUNTER</span>(STAT_PostTickComponentLW);</span><br><span class="line">		<span class="keyword">if</span>(bRenderTransformDirty)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// Update the component&#x27;s transform if the actor has been moved since it was last updated.</span></span><br><span class="line">			<span class="built_in">SendRenderTransform_Concurrent</span>();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(bRenderDynamicDataDirty)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">SendRenderDynamicData_Concurrent</span>();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="SendRenderTransform-Concurrent"><a href="#SendRenderTransform-Concurrent" class="headerlink" title="SendRenderTransform_Concurrent"></a>SendRenderTransform_Concurrent</h6><p>这个函数在基类只做了基础实现，主要是派生类重写实现主要逻辑，类似的也包括<code>SendRenderDynamicData_Concurrent</code>,<code>CreateRenderState_Concurrent</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="built_in">check</span>(bRenderStateCreated);</span><br><span class="line">	bRenderTransformDirty = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> LOG_RENDER_STATE</span></span><br><span class="line">	<span class="built_in">UE_LOG</span>(LogActorComponent, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;SendRenderTransform_Concurrent: %s&quot;</span>), *<span class="built_in">GetPathName</span>());</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="UPrimitiveComponent"><a href="#UPrimitiveComponent" class="headerlink" title="UPrimitiveComponent"></a>UPrimitiveComponent</h5><p>紧接上面，我们看看有形状体积等信息的<code>UPrimitiveComponent</code></p>
<h6 id="SendRenderTransform-Concurrent-1"><a href="#SendRenderTransform-Concurrent-1" class="headerlink" title="SendRenderTransform_Concurrent"></a>SendRenderTransform_Concurrent</h6><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UPrimitiveComponent::SendRenderTransform_Concurrent</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">UpdateBounds</span>();</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">bool</span> bDetailModeAllowsRendering	= DetailMode &lt;= <span class="built_in">GetCachedScalabilityCVars</span>().DetailMode;</span><br><span class="line">	<span class="keyword">if</span>( bDetailModeAllowsRendering &amp;&amp; (<span class="built_in">ShouldRender</span>() || bCastHiddenShadow))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">GetWorld</span>()-&gt;Scene-&gt;<span class="built_in">UpdatePrimitiveTransform</span>(<span class="keyword">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	Super::<span class="built_in">SendRenderTransform_Concurrent</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看到在实现基类逻辑之前执行了<code>FScene</code>内的函数<code>UpdatePrimitiveTransform</code></p>
<h5 id="FScene"><a href="#FScene" class="headerlink" title="FScene"></a>FScene</h5><blockquote>
<p>代码在 RendererScene.cpp中</p>
</blockquote>
<h6 id="UpdatePrimitiveTransform"><a href="#UpdatePrimitiveTransform" class="headerlink" title="UpdatePrimitiveTransform"></a>UpdatePrimitiveTransform</h6><p>在<code>UpdatePrimitiveTransform</code>函数中会判断该<code>Primitive</code>有没有<code>SceneProxy</code>，如果有<code>SceneProxy</code>则判断该<code>Primitive</code>是否需要重新创建，如果需要重新创建则需要先删除，然后再添加该<code>Primitive</code>；如果没有<code>SceneProxy</code>则直接加入到场景中。接着我们具体看一下<code>AddPrimitive</code>函数的具体实现：</p>
<h6 id="AddPrimitive"><a href="#AddPrimitive" class="headerlink" title="AddPrimitive"></a>AddPrimitive</h6><p> 此函数主要做了如下几件事情</p>
<ul>
<li>创建<code>SceneProxy</code>和<code>PrimitiveSceneInfo</code></li>
<li>利用<code>FPrimitiveSceneInfo</code>封装<code>UPrimitiveComponent</code>的信息，继续在<code>render</code>线程中进行操作</li>
<li>给渲染线程发送2个命令，分别是设置<code>Primitive</code>的<code>Transform</code>信息和将<code>PrimitiveSceneInfo</code>加入到渲染线程的数据集合中</li>
</ul>
<p>代码如下</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FPrimitiveSceneProxy* PrimitiveSceneProxy = Primitive-&gt;<span class="built_in">CreateSceneProxy</span>();</span><br><span class="line">	Primitive-&gt;SceneProxy = PrimitiveSceneProxy;</span><br><span class="line"><span class="comment">// Create the primitive scene info.</span></span><br><span class="line">	FPrimitiveSceneInfo* PrimitiveSceneInfo = <span class="keyword">new</span> <span class="built_in">FPrimitiveSceneInfo</span>(Primitive, <span class="keyword">this</span>);</span><br><span class="line">	PrimitiveSceneProxy-&gt;PrimitiveSceneInfo = PrimitiveSceneInfo;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create any RenderThreadResources required.</span></span><br><span class="line">	<span class="built_in">ENQUEUE_RENDER_COMMAND</span>(CreateRenderThreadResourcesCommand)(</span><br><span class="line">		[Params](FRHICommandListImmediate&amp; RHICmdList)</span><br><span class="line">	&#123;</span><br><span class="line">		FPrimitiveSceneProxy* SceneProxy = Params.PrimitiveSceneProxy;</span><br><span class="line">		FScopeCycleCounter <span class="built_in">Context</span>(SceneProxy-&gt;<span class="built_in">GetStatId</span>());</span><br><span class="line">		SceneProxy-&gt;<span class="built_in">SetTransform</span>(Params.RenderMatrix, Params.WorldBounds, Params.LocalBounds, Params.AttachmentRootPosition);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Create any RenderThreadResources required.</span></span><br><span class="line">		SceneProxy-&gt;<span class="built_in">CreateRenderThreadResources</span>();</span><br><span class="line">	&#125;);</span><br></pre></td></tr></table></figure>



<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ENQUEUE_RENDER_COMMAND</span>(AddPrimitiveCommand)(</span><br><span class="line">	[Scene, PrimitiveSceneInfo](FRHICommandListImmediate&amp; RHICmdList)</span><br><span class="line">	&#123;</span><br><span class="line">		FScopeCycleCounter <span class="built_in">Context</span>(PrimitiveSceneInfo-&gt;Proxy-&gt;<span class="built_in">GetStatId</span>());</span><br><span class="line">		Scene-&gt;<span class="built_in">AddPrimitiveSceneInfo_RenderThread</span>(RHICmdList, PrimitiveSceneInfo);</span><br><span class="line">	&#125;);</span><br></pre></td></tr></table></figure>

<h6 id="AddPrimitiveSceneInfo-RenderThread"><a href="#AddPrimitiveSceneInfo-RenderThread" class="headerlink" title="AddPrimitiveSceneInfo_RenderThread"></a>AddPrimitiveSceneInfo_RenderThread</h6><p><code>AddPrimitiveSceneInfo_RenderThread</code>函数是在渲染线程执行的，完成<code>PrimitiveBounds</code>、<code>PrimitiveFlagsCompact</code>等数据的初始化后，并调用<code>LinkAttachmentGroup</code>处理<code>primitive</code>的父子关系，调用<code>LinkLODParentComponent</code>处理LOD父子关系，然后调用<code>FPrimitiveSceneInfo::AddToScene</code></p>
<p><code>AddToScene</code>最终会把物体添加到列表<code>DrawList</code> 中去完成绘制，这里不继续深挖了,埋个扣子，以后来解开</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Add the primitive to its shadow parent&#x27;s linked list of children.</span></span><br><span class="line">	<span class="comment">// Note: must happen before AddToScene because AddToScene depends on LightingAttachmentRoot</span></span><br><span class="line">PrimitiveSceneInfo-&gt;<span class="built_in">LinkAttachmentGroup</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Set lod Parent information if valid</span></span><br><span class="line">PrimitiveSceneInfo-&gt;<span class="built_in">LinkLODParentComponent</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Add the primitive to the scene.</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">bool</span> bAddToDrawLists = !(CVarDoLazyStaticMeshUpdate.<span class="built_in">GetValueOnRenderThread</span>() &amp;&amp; !WITH_EDITOR);</span><br><span class="line"><span class="keyword">if</span> (bAddToDrawLists)</span><br><span class="line">&#123;</span><br><span class="line">	PrimitiveSceneInfo-&gt;<span class="built_in">AddToScene</span>(RHICmdList, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">	PrimitiveSceneInfo-&gt;<span class="built_in">AddToScene</span>(RHICmdList, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">	PrimitiveSceneInfo-&gt;<span class="built_in">BeginDeferredUpdateStaticMeshes</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h5><blockquote>
<p>由此我们就大致整理一下思路</p>
</blockquote>
<p>设置Actor的位置，其实就是把新旧位置做一个插值，把这个插值传递给继承自<code>USceneComponent</code>的<code>MoveComponent</code>方法，然后在下一帧渲染出新的位置</p>
<p>这里也接上了并解释了之前<a href="%5Bhttps://supervj.top/2020/05/27/AI_MoveTo%E7%A0%94%E7%A9%B6/%5D(https://supervj.top/2020/05/27/AI_MoveTo%E7%A0%94%E7%A9%B6/)">AI_MoveTo</a>的内容了</p>
<p>上一张流程简图</p>
<p><img src="https://img.supervj.top/img/%E6%B8%B2%E6%9F%93.jpg"></p>
<h5 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h5><h6 id="场景中静态物体的渲染顺序堆栈表参考"><a href="#场景中静态物体的渲染顺序堆栈表参考" class="headerlink" title="场景中静态物体的渲染顺序堆栈表参考"></a>场景中静态物体的渲染顺序堆栈表参考</h6><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ActorComponet::ExecuteRegisterEvents</span><br><span class="line">UPrimitiveComponent::CreateRenderState_Concurrent</span><br><span class="line">FScene:: AddPrimitive</span><br><span class="line">FScene:: AddPrimitiveSceneInfo_RenderThread</span><br><span class="line">FScene:: AddStaticMeshes</span><br><span class="line">FStaticMesh::AddToDrawLists</span><br><span class="line">FMobileBasePassOpaqueDrawingPolicyFactory::AddStaticMesh</span><br><span class="line">ProcessMobileBasePassMesh</span><br><span class="line">FDrawMobileBasePassStaticMeshAction:: Process</span><br><span class="line">AddMeshToStaticDrawList</span><br><span class="line"><span class="comment">//加入到scene GetMobileBasePassDrawList中</span></span><br></pre></td></tr></table></figure>

<p>最终加入队列 以<code>DrawingPolicy</code> 为<code>key </code>的<code>map</code>队列</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TStaticMeshDrawList&lt;TMobileBasePassDrawingPolicy&lt;FUniformLightMapPolicy, <span class="number">0</span>&gt; &gt; MobileBasePassUniformLightMapPolicyDrawList[EBasePass_MAX];</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://supervj.top/2020/06/01/UE4%E5%88%9B%E5%BB%BA%E5%BC%82%E6%AD%A5%E8%8A%82%E7%82%B9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://img.supervj.top/imgHEAD_Icon.png">
      <meta itemprop="name" content="VJ东">
      <meta itemprop="description" content=" 如果我们不曾相遇 ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="月光林地">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/06/01/UE4%E5%88%9B%E5%BB%BA%E5%BC%82%E6%AD%A5%E8%8A%82%E7%82%B9/" class="post-title-link" itemprop="url">创建异步节点</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-06-01 00:00:00" itemprop="dateCreated datePublished" datetime="2020-06-01T00:00:00+08:00">2020-06-01</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-08-02 16:29:59" itemprop="dateModified" datetime="2021-08-02T16:29:59+08:00">2021-08-02</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/editor/" itemprop="url" rel="index"><span itemprop="name">editor</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    
      <a title="changyan" href="/2020/06/01/UE4%E5%88%9B%E5%BB%BA%E5%BC%82%E6%AD%A5%E8%8A%82%E7%82%B9/#SOHUCS" itemprop="discussionUrl">
        <span id="url::http://supervj.top/2020/06/01/UE4%E5%88%9B%E5%BB%BA%E5%BC%82%E6%AD%A5%E8%8A%82%E7%82%B9/" class="cy_cmt_count" data-xid="2020/06/01/UE4创建异步节点/" itemprop="commentCount"></span>
      </a>
    
  </span>
  
  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>7.1k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>6 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><img src="https://img.supervj.top/img/AIMoveTo/move_4.jpg"></p>
<blockquote>
<p>如图所示，我们经常在UE4内看到如此的异步节点，简单说此类节点的输出并非像函数一样瞬间完成，而是拥有自己的生命周期，此类节点一般在右上角有一个<strong>时钟标志</strong></p>
<p>本文讲解如何制作类似<code>AI_MoveTo</code>的异步节点</p>
<p>另一篇<a href="%5Bhttps://supervj.top/2020/05/27/AI_MoveTo%E7%A0%94%E7%A9%B6/%5D(https://supervj.top/2020/05/27/AI_MoveTo%E7%A0%94%E7%A9%B6/)">AI_MoveTo简单分析和扩展</a>介绍<code>AI_MoveTo</code>的简单运行机制和其他扩展方式</p>
</blockquote>
<hr>
<blockquote>
<ul>
<li>2020.11.24更新:</li>
</ul>
<p>更新各类移动扩展函数库以及K2Node</p>
<p><a href="git@github.com:VJien/MovementEx.git">github</a></p>
<p><img src="https://img.supervj.top//img/image-20201124134801666.png" alt="image-20201124134801666"></p>
<ul>
<li>2021.2.25更新:</li>
</ul>
<p>基于<code>UBlueprintAsyncActionBase</code>的异步节点 <a href="#Asyc">跳转</a></p>
</blockquote>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2020/06/01/UE4%E5%88%9B%E5%BB%BA%E5%BC%82%E6%AD%A5%E8%8A%82%E7%82%B9/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://supervj.top/2020/05/27/AI_MoveTo%E7%A0%94%E7%A9%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://img.supervj.top/imgHEAD_Icon.png">
      <meta itemprop="name" content="VJ东">
      <meta itemprop="description" content=" 如果我们不曾相遇 ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="月光林地">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/05/27/AI_MoveTo%E7%A0%94%E7%A9%B6/" class="post-title-link" itemprop="url">AI_MoveTo分析和扩展</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-05-27 00:00:00" itemprop="dateCreated datePublished" datetime="2020-05-27T00:00:00+08:00">2020-05-27</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-08-02 16:35:31" itemprop="dateModified" datetime="2021-08-02T16:35:31+08:00">2021-08-02</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/editor/" itemprop="url" rel="index"><span itemprop="name">editor</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    
      <a title="changyan" href="/2020/05/27/AI_MoveTo%E7%A0%94%E7%A9%B6/#SOHUCS" itemprop="discussionUrl">
        <span id="url::http://supervj.top/2020/05/27/AI_MoveTo%E7%A0%94%E7%A9%B6/" class="cy_cmt_count" data-xid="2020/05/27/AI_MoveTo研究/" itemprop="commentCount"></span>
      </a>
    
  </span>
  
  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>20k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>18 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="UK2Node-AIMoveTo"><a href="#UK2Node-AIMoveTo" class="headerlink" title="UK2Node_AIMoveTo"></a>UK2Node_AIMoveTo</h2><p><img src="https://img.supervj.top/img/AIMoveTo/move_4.jpg"></p>
<blockquote>
<p>这是我们最熟悉的编辑器模式下的AI_MoveTo节点，也就是那个自带OnSuccess和OnFailed的异步节点，在蓝图中大多数时候使用起来都得心应手非常方便，但是它有个最大的缺点，异步节点意味着他有自己的生命周期，不能放到函数中使用，同样的，在代码中也没有此类节点，那么接下来我们尝试解决这一问题</p>
</blockquote>
<p>翻看此节点的代码，没几行代码,主要看如下</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2020/05/27/AI_MoveTo%E7%A0%94%E7%A9%B6/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/10/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><span class="page-number current">11</span><a class="page-number" href="/page/12/">12</a><a class="page-number" href="/page/13/">13</a><a class="extend next" rel="next" href="/page/12/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>


<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2020 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">VJ东</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">771k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">11:41</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>

<script src="/js/local-search.js"></script>





  <script>
    NProgress.configure({
      showSpinner: true
    });
    NProgress.start();
    document.addEventListener('readystatechange', () => {
      if (document.readyState === 'interactive') {
        NProgress.inc(0.8);
      }
      if (document.readyState === 'complete') {
        NProgress.done();
      }
    });
    document.addEventListener('pjax:send', () => {
      NProgress.start();
    });
    document.addEventListener('pjax:success', () => {
      NProgress.done();
    });
  </script>

  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





  <script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'none'
      },
      options: {
        renderActions: {
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              const target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    const script = document.createElement('script');
    script.src = '//cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js';
    script.defer = true;
    document.head.appendChild(script);
  } else {
    MathJax.startup.document.state(0);
    MathJax.typesetClear();
    MathJax.texReset();
    MathJax.typeset();
  }
</script>



  <script id="cy_cmt_num" src="https://changyan.sohu.com/upload/plugins/plugins.list.count.js?clientId=cyvbKaUjB"></script>


</body>
</html>
